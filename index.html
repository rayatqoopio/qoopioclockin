<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Qoopio 打卡系統</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user‑scalable=no" />
    <meta name="theme-color" content="#111111" />
    <link rel="manifest" href="manifest.json" />
    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("service-worker.js")
          .then(() => console.log("✅ Service Worker registered"))
          .catch((error) => console.error("❌ SW registration failed:", error));
      }
    </script>
    <style>
      body {
        font-family: "Helvetica Neue", Helvetica, Arial, sans‑serif;
        margin: 0;
        padding: 2rem;
        background-color: #f9f9f9;
        color: #333;
        text-align: center;
      }
      .container {
        max-width: 960px;
        margin: 20vh auto;
      }
      label {
        display: block;
        margin: 1rem 0 0.5rem;
        font-size: 1.5rem;
        text-align: left;
      }
      input[type="email"] {
        font-size: 2.5rem;
        width: 98%;
        padding: 1.6rem;
        border: 1px solid #ccc;
        border-radius: 12px;
        box-sizing: border‑box;
      }
      .button-row {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
      }
      .submit-btn {
        flex: 5;
        padding: 2.5rem;
        font-size: 2rem;
        background-color: #111;
        color: #fff;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }
      .submit-btn:hover {
        background-color: #444;
      }
      .change-btn {
        flex: 1;
        padding: 2.5rem;
        font-size: 1.6rem;
        background-color: #e0e0e0;
        color: #222;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .change-btn:hover {
        background-color: #ccc;
      }
      .user-label {
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: 1rem;
      }
      #status {
        margin-top: 1.2rem;
        font-size: 1.5rem;
        font-weight: bold;
      }
      #shift-info {
        margin-top: 2rem;
        font-size: 1.3rem;
        color: #444;
      }
    </style>
  </head>
  <body>
    <div class="container">

      <!-- 使用者資訊區 -->
      <div id="user-info" style="display: none;">
        <div id="user-label" class="user-label"></div>
      </div>

      <!-- Email 輸入區 -->
      <div id="email-input-area">
        <label for="email">Email：</label>
        <input type="email" id="email" placeholder="輸入公司 email" required />
        <button onclick="handleLogin()">登入</button>
      </div>

      <!-- 打卡與更換帳號按鈕 -->
      <div class="button-row">
        <button id="clockInBtn" class="submit-btn" onclick="submitClockIn()">打卡</button>
        <button onclick="resetEmail()" class="change-btn">更換帳號</button>
      </div>

      <!-- 班別資訊顯示區 -->
      <div id="shift-info">讀取班別中…</div>

      <!-- 打卡狀態顯示 -->
      <div id="status"></div>

    </div>

    <script>
      const scriptUrl = "https://script.google.com/macros/s/AKfycbzfCWSZCydOFXJMaOqHOA25HHW36RlONmD‑D‑TgruSsx6xrO4RegK7CGlkwNwpG6QKlj/exec";
      let userData = {};

      // 載入 user.json
      fetch("user.json")
        .then(res => res.json())
        .then(json => {
          userData = json;
          initLogin();
        })
        .catch(err => {
          console.error("❌ 無法載入使用者資料", err);
          alert("使用者資料載入失敗，請刷新頁面");
        });

      // 初始化登入狀態
      function initLogin() {
        const savedEmail = localStorage.getItem("qoopio_email");
        if (savedEmail && userData[savedEmail]) {
          showUserInfo(savedEmail);
        } else {
          showEmailInput();
        }
        updateButtonLabel();
        setInterval(updateButtonLabel, 60000);
      }

      // 處理登入按鈕
      function handleLogin() {
        const email = document.getElementById("email").value.trim();
        if (!userData[email]) {
          alert("查無此帳號，請重新確認 email！");
          return;
        }
        localStorage.setItem("qoopio_email", email);
        showUserInfo(email);
      }

      // 顯示使用者資訊
      function showUserInfo(email) {
        const name = userData[email].name || email;
        document.getElementById("user-label").textContent = `${name}（${email}）`;
        document.getElementById("user-info").style.display = "block";
        document.getElementById("email-input-area").style.display = "none";
        loadShifts(email);
      }

      // 顯示 email 輸入區
      function showEmailInput() {
        document.getElementById("user-info").style.display = "none";
        document.getElementById("email-input-area").style.display = "block";
      }

      // 重設帳號
      function resetEmail() {
        localStorage.removeItem("qoopio_email");
        location.reload();
      }

      // 更新打卡按鈕文字（上班／下班）
      let lastSubmitTime = 0;
      function updateButtonLabel() {
        const now = new Date();
        const totalMinutes = now.getHours() * 60 + now.getMinutes();
        const btn = document.getElementById("clockInBtn");
        if (totalMinutes >= 240 && totalMinutes <= 1140) {
          btn.textContent = "上班打卡";
          btn.dataset.type = "上班";
        } else {
          btn.textContent = "下班打卡";
          btn.dataset.type = "下班";
        }
      }

      // 取得今日與明日班別
      function loadShifts(email) {
        document.getElementById("shift-info").textContent = "讀取班別中…";
        fetch(`${scriptUrl}?email=${encodeURIComponent(email)}`)
          .then(res => res.json())
          .then(data => {
            document.getElementById("shift-info").innerHTML =
              `📅 今日班別：${data.today || "—"}<br>⏭️ 明日班別：${data.tomorrow || "—"}`;
          })
          .catch(err => {
            console.error("❌ 無法載入班別：", err);
            document.getElementById("shift-info").textContent = "無法讀取班表";
          });
      }

      // 打卡送出邏輯（定位 + 傳送 +狀態顯示）
      function submitClockIn() {
        const now = Date.now();
        if (now - lastSubmitTime < 15000) {
          alert("請勿重複打卡，請等待幾秒再試！");
          return;
        }
        const email = localStorage.getItem("qoopio_email");
        if (!email) {
          alert("請先登入！");
          return;
        }
        const type = document.getElementById("clockInBtn").dataset.type || "上班";
        if (!navigator.geolocation) {
          alert("您的瀏覽器不支援定位功能");
          return;
        }
        navigator.geolocation.getCurrentPosition(position => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;

          const data = { email, type, lat, lng };
          const name = userData[email].name || email;
          const timeStr = new Date().toLocaleTimeString();

          document.getElementById("status").textContent =
            `✅ ${name} ${type}（${timeStr}）`;
          document.getElementById("status").style.color = "green";

          document.getElementById("clockInBtn").disabled = true;
          setTimeout(() => {
            document.getElementById("clockInBtn").disabled = false;
          }, 15000);

          lastSubmitTime = now;
          // 傳送資料給 Apps Script
          fetch(scriptUrl, {
            method: "POST",
            mode: "no-cors",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
          });
        }, () => {
          alert("無法取得定位資訊，請確認瀏覽器權限！");
        });
      }
    </script>
  </body>
</html>