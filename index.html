<!DOCTYPE html>
<html lang="zh-TW" style="background-color: #fdf5e6;">
<head>
  <meta charset="UTF-8" />
  <title>Qoopio å“¡å·¥ç³»çµ± (Final v4.2)</title>
  
  <meta name="theme-color" content="#fdf5e6" media="(prefers-color-scheme: light)" />
  <meta name="theme-color" content="#fdf5e6" media="(prefers-color-scheme: dark)" />
  <meta name="theme-color" content="#fdf5e6" />

  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no" />
  
  <link rel="manifest" href="manifest.json?v=20251201" />
  <link rel="icon" href="icon.png" />
  <script>
    if("serviceWorker" in navigator) navigator.serviceWorker.register("service-worker.js?v=20251201");
  </script>
  <style>
    /* === 1. åŸºç¤è¨­å®š === */
    @supports (height: 100dvh) { .container { min-height: calc(100dvh - env(safe-area-inset-bottom, 0px)); } }
    html, body { margin: 0; padding: 0; height: 100%; background-color: #fdf5e6; font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; color: #333; text-align: center; overflow-x: hidden; overscroll-behavior-y: none; }
    .hidden { display: none !important; }

    /* === 2. Header & Logo === */
    #global-header { position: fixed; top: 0; left: 0; right: 0; height: 60px; background-color: #fdf5e6; display: flex; align-items: center; justify-content: center; z-index: 10010; padding-top: env(safe-area-inset-top, 0px); }
    .header-logo { height: 56px; width: auto; display: block; }

    /* === 3. Container === */
    .container { max-width: 500px; margin: 0 auto; padding: calc(60px + env(safe-area-inset-top, 0px)) 1rem calc(3rem + env(safe-area-inset-bottom, 0px)); box-sizing: border-box; min-height: calc(100vh - env(safe-area-inset-bottom, 0px)); display: flex; flex-direction: column; }
    .page-section { width: 100%; flex: 1; }

    /* === 4. ç™»å…¥é  === */
    #login-page { padding-top: 10vh; display: block; }
    .logo-large { width: 200px; margin-bottom: 1.5rem; }
    #login-page input { width: 80%; padding: 0.8rem; margin: 1rem 0; font-size: 1rem; border-radius: 8px; border: 1px solid #ccc; }
    #login-page button { padding: 0.8rem 1.5rem; font-size: 1rem; background: #111; color: #fff; border: none; border-radius: 8px; cursor: pointer; }

    /* === 5. æ‰“å¡é  === */
    #page-clock { display: flex; flex-direction: column; justify-content: center; padding-top: 10vh; padding-bottom: 15vh; }
    .user-label { font-size: 1.1rem; font-weight: bold; margin-bottom: 0.4rem; }
    .user-email { font-size: 0.9rem; color: #666; margin-bottom: 1rem; font-family: monospace; } /* ä¿®æ”¹æ¨£å¼å */
    #clockInBtn { width: 80%; padding: 1.7rem; font-size: 1.3rem; background-color: #111; color: #fff; border: none; border-radius: 10px; cursor: pointer; display: block; margin: 0.8rem auto; transition: opacity 0.3s; }
    #clockInBtn:disabled { background-color: #bbb !important; opacity: .6; pointer-events: none; }
    .logout-btn { background: none; border: none; color: #777; font-size: 0.8rem; cursor: pointer; display: block; margin: 0 auto; }
    #status { margin-top: 1rem; font-size: 0.95rem; font-weight: bold; min-height: 1.2em; }
    #leave-pending-banner { margin-top: 0.3rem; font-size: 0.9rem; color: #c0392b; font-weight: bold; min-height: 1.2em; }

    /* === 6. æœˆæ›† (ç­è¡¨) === */
    .calendar-header { padding-top: 1rem; display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; font-size: 1.2rem; font-weight: bold; }
    .calendar-header button { background: none; border: none; font-size: 1.4rem; font-weight: bold; color: #333; cursor: pointer; padding: 0.3rem 0.6rem; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 1rem; }
    .day-cell { position: relative; padding: 10px 0; border-radius: 8px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.9rem; }
    .day-cell.today { border: 2px solid #111; font-weight: bold; }
    .day-cell.selected { background-color: #ddd; }
    .day-name { font-weight: bold; color: #666; }
    .day-indicator { width: 8px; height: 8px; border-radius: 50%; margin-top: 4px; }
    .shift-zhongshan .day-indicator { background-color: #e74c3c; }
    .shift-jingmei .day-indicator { background-color: #27ae60; }
    #selected-shift { font-size: 1rem; line-height: 1.8; color: #444; text-align: left; padding: 1rem; border-radius: 10px; background: #fff; box-shadow: 0 0 6px rgba(0,0,0,0.1); min-height: 100px; }
    .group-title { font-weight: bold; color: #000; margin-top: 1rem; margin-bottom: 0.5rem; }

    /* === 7. è«‹å‡é  === */
    #page-leave { text-align: left; padding-top: 1vh; }
    .leave-btn-main { position: fixed; left: 50%; transform: translateX(-50%); bottom: calc(100px + env(safe-area-inset-bottom, 0px)); z-index: 9998; width: 55%; min-width: 180px; max-width: 300px; padding: 0.9rem; font-size: 1rem; border-radius: 999px; border: none; background: #111; color: #fff; cursor: pointer; box-shadow: 0 4px 14px rgba(0,0,0,0.12); }
    #leave-history { margin-top: 0.5rem; font-size: 0.9rem; color: #555; }
    .leave-card { padding: 0.8rem; border-radius: 12px; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 0.8rem; text-align: left; }
    .leave-card .row-1 { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.4rem; font-weight: bold; }
    .leave-card .row-1 .title { font-size: 1rem; color: #111; }
    .status-bar { display: inline-flex; height: 24px; padding: 0 10px; border-radius: 6px; font-size: 0.8rem; font-weight: 700; color: #fff; align-items: center; }
    .status-å¯©æ ¸ä¸­ { background: #e67e22; } .status-é€šé { background: #27ae60; } .status-é€€å› { background: #c0392b; }
    .leave-card .info { font-size: 0.9rem; color: #555; line-height: 1.5; }
    .leave-card .reason { margin-top: 6px; font-size: 0.9rem; color: #333; font-style: italic; background: #f9f9f9; padding: 6px; border-radius: 6px; }

    /* === 8. Manager & Admin Page === */
    #page-manager, #page-admin { text-align: left; padding-top: 1vh; }
    .manager-tabs { display: flex; gap: 10px; margin-bottom: 15px; justify-content: center; }
    .manager-tabs button { flex: 0 0 auto; width: auto; padding: 10px 16px; border-radius: 8px; border: 1px solid #ccc; background: transparent; font-weight: bold; color: #777; cursor: pointer; font-size: 1.2rem; }
    .manager-tabs button.active { background: #111; color: #fff; border-color: #111; }
    
    .review-actions { display: flex; gap: 10px; margin-top: 12px; }
    .btn-approve { flex: 1; padding: 10px; border-radius: 8px; border: none; background: #27ae60; color: #fff; font-weight: bold; cursor: pointer; }
    .btn-reject { flex: 1; padding: 10px; border-radius: 8px; border: none; background: #c0392b; color: #fff; font-weight: bold; cursor: pointer; }
    .empty-state { text-align: center; color: #999; margin-top: 30px; font-size: 0.95rem; }

    /* Admin Cards */
    .dash-title { font-size: 1.1rem; font-weight: bold; margin-bottom: 10px; border-left: 4px solid #111; padding-left: 10px; margin-top: 20px; }
    .dashboard-card { background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 10px; }
    .dash-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.95rem; }
    .dash-item:last-child { border-bottom: none; }
    .dash-time { font-family: monospace; font-weight: bold; }
    .admin-input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
    .admin-btn { width: 100%; padding: 12px; background: #111; color: #fff; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 5px; font-size: 1rem; }
    .admin-btn.secondary { background: #fff; color: #111; border: 1px solid #111; }

    /* === 9. FAB === */
    #fab-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 10015; }
    .menu-fab { position: fixed; left: 16px; bottom: calc(16px + env(safe-area-inset-bottom, 0px)); z-index: 10020; display: none; flex-direction: column; align-items: flex-start; }
    .fab-main { width: 60px; height: 60px; border-radius: 50%; border: none; background: #111; color: #fff; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 16px rgba(0,0,0,0.35); font-size: 1.6rem; position: relative; }
    .fab-icon-o, .fab-icon-x { position: absolute; font-family: sans-serif; font-weight: 700; transition: all 0.3s; }
    .fab-icon-o { opacity: 1; transform: scale(1); font-size: 1.5rem; } 
    .fab-icon-x { opacity: 0; transform: rotate(-90deg) scale(0.5); font-size: 1.4rem; }
    .fab-main.open .fab-icon-o { opacity: 0; transform: scale(0.5); } 
    .fab-main.open .fab-icon-x { opacity: 1; transform: rotate(0deg) scale(1); }
    
    .menu-sheet { margin-bottom: 10px; } .menu-sheet.hidden { display: none; }
    .fab-option { display: flex; align-items: center; margin-bottom: 10px; }
    .menu-item { padding: 8px 14px; border: none; background: #fff; color: #333; font-size: 0.9rem; border-radius: 999px; box-shadow: 0 4px 12px rgba(0,0,0,0.18); white-space: nowrap; cursor: pointer; }
    .menu-circle { width: 35px; height: 35px; margin-left: 8px; border-radius: 50%; background: #fff; color: #555; display: flex; align-items: center; justify-content: center; font-size: 0.95rem; box-shadow: 0 4px 12px rgba(0,0,0,0.25); position: relative; }
    .notification-dot::after { content: ''; position: absolute; top: -2px; right: -2px; width: 10px; height: 10px; background-color: #ff3b30; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    .menu-item.active { background: #111; color: #fff; font-weight: 700; } .menu-item.active + .menu-circle { border: 2px solid #111; }

    /* === 10. HUD & Modals === */
    .hud-right { position: fixed; right: 16px; bottom: calc(16px + env(safe-area-inset-bottom, 0px)); display: none; z-index: 10001; }
    .gacha-btn { background: transparent !important; border: 0 !important; width: auto; height: auto; }
    .gacha-img { width: 96px; height: 96px; } 
    .gacha-img:not(.hidden) + .gacha-svg { display: none; } .gacha-svg { width: 96px; height: 96px; }
    .gacha-badge { position: absolute; right: -6px; top: -6px; min-width: 22px; height: 22px; padding: 0 6px; border-radius: 999px; background: #111; color: #fff; font-weight: 800; font-size: 12px; display: inline-flex; align-items: center; justify-content: center; border: 1px solid #fff; }

    .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.45); z-index: 10030; } .modal.open { display: flex; }
    .modal-card { width: min(520px, 92%); background: #fff; border-radius: 16px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); text-align: left; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; } .modal-header h3 { margin: 0; font-size: 1.1rem; } .modal-close { background: none; border: none; font-size: 1.2rem; cursor: pointer; }
    
    /* Gacha Styles */
    .modal-tabs { display: flex; gap: 8px; margin-bottom: 10px; }
    .modal-tabs button { flex: 1; padding: 8px; border-radius: 10px; border: 1px solid #222; background: #fff; cursor: pointer; font-weight: 700; color: #111; }
    .modal-tabs button.active { background: #111; color: #fff; border-color: #111; }
    .gacha-body-content { text-align: center; padding: 10px 0; }
    .gacha-btn-main { width: 100%; padding: 16px; font-size: 1.2rem; font-weight: bold; color: #fff; background-color: #111; border: none; border-radius: 12px; cursor: pointer; box-shadow: 0 6px 0 #444; transform: translateY(0); transition: all 0.1s; margin-bottom: 10px; }
    .gacha-btn-main:active { box-shadow: 0 2px 0 #444; transform: translateY(4px); }
    .gacha-btn-main:disabled { background-color: #aaa; box-shadow: none; transform: translateY(4px); cursor: not-allowed; }
    .gacha-result { min-height: 60px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: bold; color: #111; margin-top: 10px; opacity: 0; transition: opacity 0.3s; } .gacha-result.show { opacity: 1; }
    .shake-hard { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) infinite; }
    @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    .gacha-log-item { padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.9rem; color: #555; display: flex; justify-content: space-between; }
    .gacha-win { color: #d35400; font-weight: bold; }

    /* Leave Form Inputs */
    #leave-form label { display: block; margin-top: 0.5rem; font-size: 0.9rem; color: #555; }
    #leave-form select, #leave-form textarea { width: 100%; box-sizing: border-box; margin-top: 0.2rem; padding: 0.4rem 0.5rem; border-radius: 8px; border: 1px solid #ccc; font-size: 0.9rem; } #leave-form textarea { min-height: 60px; resize: vertical; }
    .leave-form-actions { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 0.8rem; }
    .leave-submit-btn { padding: 0.5rem 1rem; font-size: 0.9rem; border-radius: 999px; border: none; background: #111; color: #fff; cursor: pointer; }
    .leave-cancel-btn { padding: 0.5rem 0.9rem; font-size: 0.9rem; border-radius: 999px; border: 1px solid #aaa; background: #f5f5f5; color: #555; cursor: pointer; }
    
    /* Loading & Announce */
    #loading-screen { position: fixed; inset: 0; background: #fdf5e6; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 20000; transition: opacity 0.3s ease; }
    #loading-screen.hidden { opacity: 0; pointer-events: none; }
    .spinner { width: 40px; height: 40px; border: 4px solid #ccc; border-top-color: #111; border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 10px; }
    @keyframes spin { to { transform:rotate(360deg); } }
    #announce-modal .modal-card { text-align: center; }
    #announce-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; }
    #announce-content { font-size: 1rem; color: #555; margin-bottom: 20px; line-height: 1.5; white-space: pre-wrap; }
  </style>
</head>
<body>
  <div id="loading-screen"><div class="spinner"></div><p>ç³»çµ±é€£ç·šä¸­...</p></div>
  <div id="fab-overlay" class="hidden" onclick="toggleMenu()"></div>
  <header id="global-header" class="hidden"><img src="qoopio logo.png" class="header-logo" /></header>

  <div class="container">
    <div id="login-page" class="hidden page-section">
      <img src="qoopio logo.png" class="logo-large" />
      <h3>è«‹è¼¸å…¥æ‚¨çš„ Email ç™»å…¥</h3>
      <input type="email" id="login-email" placeholder="name@qoopio.com" />
      <button onclick="login()">é€²å…¥ç³»çµ±</button>
    </div>

    <div id="page-clock" class="hidden page-section">
      <div id="user-label" class="user-label"></div>
      <div id="user-email" class="user-email"></div>
      <button id="clockInBtn" type="button" onclick="submitClockIn()">è®€å–ä¸­...</button>
      <button onclick="resetApp()" class="logout-btn">ç™»å‡º</button>
      <div id="status"></div>
    </div>

    <div id="page-leave" class="hidden page-section">
      <h3 style="display:none">è«‹å‡</h3>
      <button class="leave-btn-main" type="button" onclick="openLeaveForm()">ç”³è«‹è«‹å‡</button>
      <h4>å€‹äººè«‹å‡ç´€éŒ„</h4>
      <div id="leave-history">è¼‰å…¥ä¸­...</div>
    </div>

    <div id="page-schedule" class="hidden page-section">
      <div class="calendar-view">
        <div class="calendar-header">
          <button onclick="changeMonth(-1)">ã€ˆ</button><span id="calendar-title"></span><button onclick="changeMonth(1)">ã€‰</button>
        </div>
        <div id="calendar-grid" class="calendar-grid"></div>
        <div id="selected-shift">ğŸ“… è«‹é¸æ“‡æ—¥æœŸ</div>
      </div>
    </div>

    <div id="page-manager" class="hidden page-section">
      <div class="manager-tabs">
        <button id="mgr-tab-pending" class="active" onclick="showMgrTab('pending')">å¾…å¯©æ ¸</button>
        <button id="mgr-tab-today" onclick="showMgrTab('today')">ä»Šæ—¥å‡ºå‹¤</button>
      </div>
      <div id="mgr-view-pending">
        <div class="dashboard-card" id="mgr-review-list">è¼‰å…¥ä¸­...</div>
      </div>
      <div id="mgr-view-today" class="hidden">
        <div class="dashboard-card" id="mgr-dashboard-list">è¼‰å…¥ä¸­...</div>
      </div>
    </div>

    <div id="page-admin" class="hidden page-section">
      <div class="dash-title">ç™¼é€æ‰­è›‹ä»£å¹£</div>
      <div class="dashboard-card">
        <input id="adm-token-email" class="admin-input" placeholder="å“¡å·¥ Email" />
        <input id="adm-token-amt" class="admin-input" type="number" placeholder="æ•¸é‡ (ä¾‹å¦‚ 1)" />
        <input id="adm-token-reason" class="admin-input" placeholder="åŸå›  (é¸å¡«)" />
        <button class="admin-btn" onclick="adminGiveToken()">ç™¼é€ä»£å¹£</button>
      </div>
      <div class="dash-title">å…¨åŸŸå…¬å‘Šè¨­å®š</div>
      <div class="dashboard-card">
        <input id="adm-ann-title" class="admin-input" placeholder="å…¬å‘Šæ¨™é¡Œ" />
        <textarea id="adm-ann-content" class="admin-input" placeholder="å…¬å‘Šå…§å®¹..." rows="3"></textarea>
        <button class="admin-btn" onclick="adminSetAnnounce()">ç™¼å¸ƒå…¬å‘Š</button>
      </div>
      <div class="dash-title">ç³»çµ±åŒæ­¥</div>
      <div class="dashboard-card">
        <button class="admin-btn secondary" onclick="adminSync('schedule')">åŒæ­¥ A è¡¨ç­è¡¨</button>
        <button class="admin-btn secondary" onclick="adminSync('clock')">è£œå¡«å‡ºå‹¤æ™‚é–“</button>
      </div>
    </div>
  </div>

  <div class="menu-fab" id="menu-fab">
    <div class="menu-sheet hidden" id="menu-sheet">
      <div class="fab-option"><button class="menu-item" onclick="nav('clock')">æ‰“å¡</button><div class="menu-circle">â±</div></div>
      <div class="fab-option"><button class="menu-item" onclick="nav('leave')">è«‹å‡</button><div class="menu-circle">ğŸ“</div></div>
      <div class="fab-option"><button class="menu-item" onclick="nav('schedule')">ç­è¡¨</button><div class="menu-circle">ğŸ“…</div></div>
      
      <div class="fab-option hidden" id="fab-mgr">
        <button class="menu-item" onclick="nav('manager')">è«‹å‡å¯©æ ¸</button>
        <div class="menu-circle" id="dot-mgr">ğŸ–‹ï¸</div>
      </div>
      <div class="fab-option hidden" id="fab-adm">
        <button class="menu-item" onclick="nav('admin')">ç®¡ç†å“¡</button>
        <div class="menu-circle">ğŸ”§</div>
      </div>
    </div>
    <button class="fab-main" onclick="toggleMenu()"><span class="fab-icon-o">O</span><span class="fab-icon-x">âœ•</span></button>
  </div>

  <div class="hud-right" id="hud-right">
    <button class="gacha-btn" onclick="openGacha()"><img id="gacha-img" src="icon.png" class="gacha-img" /><span class="gacha-badge" id="hud-coin">0</span></button>
  </div>

  <div class="modal" id="gacha-modal">
    <div class="modal-card">
      <div class="modal-header"><h3>æ‰­è›‹æ©Ÿ</h3><button class="modal-close" onclick="closeGacha()">âœ•</button></div>
      <div class="modal-tabs">
        <button id="tab-gacha-play" class="active" onclick="switchGachaTab('play')">æ‰­è›‹</button>
        <button id="tab-gacha-log" onclick="switchGachaTab('log')">ç´€éŒ„</button>
      </div>
      <div class="modal-body" id="gacha-view-play">
        <div class="gacha-body-content">
          <p><b>ä»£å¹£ï¼š</b><span id="modal-coin-count">0</span></p>
          <div style="height:10px"></div>
          <button id="gacha-action-btn" class="gacha-btn-main" onclick="playGachaAnimation()">START</button>
          <div id="gacha-result-display" class="gacha-result"></div>
          <div style="font-size:0.85rem; color:#888; margin-top:10px;">ç¥æ‚¨ä¸­ç (Â´â‰–â—à±ªâ—Ÿâ‰–)</div>
        </div>
      </div>
      <div class="modal-body hidden" id="gacha-view-log">
        <div id="gacha-history-list" style="max-height:200px; overflow-y:auto;"></div>
      </div>
    </div>
  </div>

  <div class="modal" id="leave-modal">
    <div class="modal-card">
      <div class="modal-header"><h3>ç”³è«‹è«‹å‡</h3><button class="modal-close" onclick="closeLeaveForm()">âœ•</button></div>
      <div class="modal-body">
        <div id="leave-form">
          <div><strong>ç”³è«‹äººï¼š</strong><span id="leave-name">â€”</span></div>
          <label>æ—¥æœŸ<select id="leave-date"></select></label>
          <label>å‡åˆ¥<select id="leave-type"><option>äº‹å‡</option><option>ç—…å‡</option><option>ä¼‘å‡</option><option>ç‰¹ä¼‘å‡</option></select></label>
          <label>åŸå› <input id="leave-reason" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:8px;" /></label>
          <div class="leave-form-actions">
            <button class="leave-cancel-btn" onclick="closeLeaveForm()">å–æ¶ˆ</button>
            <button class="leave-submit-btn" onclick="submitLeave()">é€å‡º</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="announce-modal">
    <div class="modal-card">
      <div id="announce-title"></div>
      <div id="announce-content"></div>
      <button class="admin-btn" onclick="closeAnnounce()">æˆ‘çŸ¥é“äº†</button>
    </div>
  </div>

  <script>
    // âš ï¸ æ›¿æ›æˆ C è¡¨éƒ¨ç½²çš„ URL
    const API_URL = "https://script.google.com/macros/s/AKfycbzB12OEJhNMEMWQI3lNjm61pfAtl7boHkN8n7MpTsWTLVl7txO4vxFs593fn_YyljOm/exec";
    
    let currentUser = null;
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth();
    const GACHA_ICON = "gacha-icon.png?v=4.1";

    window.onload = async () => {
      // å˜—è©¦è¼‰å…¥ Gacha Icon
      const img = new Image(); img.src=GACHA_ICON;
      img.onload = () => { document.getElementById("gacha-img").src = GACHA_ICON; };

      const email = localStorage.getItem("q_email");
      if (email) {
        await appInit(email);
      } else {
        document.getElementById("loading-screen").classList.add("hidden");
        document.getElementById("login-page").classList.remove("hidden");
      }
    };

    async function appInit(email) {
      document.getElementById("login-page").classList.add("hidden");
      document.getElementById("loading-screen").classList.remove("hidden");
      
      try {
        const res = await fetch(`${API_URL}?action=initApp&email=${email}`);
        const data = await res.json();
        
        if (!data.ok) { alert(data.msg); resetApp(); return; }
        
        currentUser = data.user;
        currentUser.email = email;
        
        setupUI(data);
        
        if (data.announcement) {
          const lastRead = localStorage.getItem("q_ann_id");
          if (lastRead != data.announcement.id) {
            showAnnounce(data.announcement);
          }
        }

        // Init Calendar
        loadCalendar(currentYear, currentMonth);
        updateMonthShiftMarkers();

        document.getElementById("loading-screen").classList.add("hidden");
        document.getElementById("global-header").classList.remove("hidden");
        document.getElementById("page-clock").classList.remove("hidden");
        document.getElementById("menu-fab").style.display = "flex";
        document.getElementById("hud-right").style.display = "inline-flex";

      } catch (e) {
        alert("é€£ç·šå¤±æ•—ï¼Œè«‹é‡è©¦");
        document.getElementById("loading-screen").classList.add("hidden");
        document.getElementById("login-page").classList.remove("hidden");
      }
    }

    function setupUI(data) {
      // [UI èª¿æ•´] åƒ…é¡¯ç¤ºå§“åèˆ‡ Email
      document.getElementById("user-label").textContent = currentUser.name;
      document.getElementById("user-email").textContent = currentUser.email; 
      
      document.getElementById("leave-name").textContent = currentUser.name;
      document.getElementById("hud-coin").textContent = data.tokens;
      document.getElementById("modal-coin-count").textContent = data.tokens;
      
      // Clock Btn
      const btn = document.getElementById("clockInBtn");
      const status = document.getElementById("status");
      if (data.clockStatus.includes("å·²")) {
        status.textContent = data.clockStatus;
        status.style.color = "green";
        btn.textContent = data.clockStatus.includes("ä¸‹ç­") ? "å·²ä¸‹ç­" : "ä¸‹ç­";
        btn.style.background = "#333";
        btn.dataset.type = data.clockStatus.includes("ä¸‹ç­") ? "done" : "ä¸‹ç­";
        if(btn.dataset.type==="done") btn.disabled = true;
      } else {
        btn.textContent = "ä¸Šç­";
        btn.dataset.type = "ä¸Šç­";
      }
      
      // Permissions
      if (currentUser.role === 'manager' || currentUser.role === 'admin') {
        document.getElementById("fab-mgr").classList.remove("hidden");
      }
      if (currentUser.role === 'admin') {
        document.getElementById("fab-adm").classList.remove("hidden");
      }
    }

    function login() {
      const email = document.getElementById("login-email").value.trim();
      if (!email) return;
      localStorage.setItem("q_email", email);
      appInit(email);
    }

    function resetApp() {
      localStorage.removeItem("q_email");
      location.reload();
    }

    // Navigation
    function toggleMenu() {
      const sheet = document.getElementById("menu-sheet");
      const overlay = document.getElementById("fab-overlay");
      const fab = document.querySelector(".fab-main");
      sheet.classList.toggle("hidden");
      overlay.classList.toggle("hidden");
      fab.classList.toggle("open");
    }

    function nav(page) {
      document.querySelectorAll(".page-section").forEach(p => p.classList.add("hidden"));
      document.getElementById("page-" + page).classList.remove("hidden");
      toggleMenu();
      
      if (page === 'manager') loadManagerData();
      if (page === 'leave') loadLeaveHistory(currentUser.email);
    }

    // Clock In [Updated with Confirm]
    function submitClockIn() {
      const btn = document.getElementById("clockInBtn");
      if (btn.disabled) return;
      
      // å®‰å…¨ç¢ºèª
      const type = btn.dataset.type;
      if (!confirm(`æ‚¨ç¢ºå®šè¦æ‰“ã€Œ${type}ã€å¡å—ï¼Ÿ\n(å°‡è¨˜éŒ„æ‚¨çš„æ™‚é–“èˆ‡ä½ç½®)`)) return;
      
      btn.disabled = true;
      btn.textContent = "å®šä½ä¸­...";
      
      navigator.geolocation.getCurrentPosition(async (pos) => {
        btn.textContent = "æ‰“å¡ä¸­...";
        
        const res = await fetch(API_URL, {
          method: "POST", mode: "no-cors",
          body: JSON.stringify({
            action: "clockIn",
            email: currentUser.email,
            type: type,
            lat: pos.coords.latitude,
            lng: pos.coords.longitude
          })
        });
        
        alert("æ‰“å¡æˆåŠŸï¼");
        if (type === "ä¸Šç­") {
          btn.textContent = "ä¸‹ç­";
          btn.dataset.type = "ä¸‹ç­";
          btn.disabled = false;
        } else {
          btn.textContent = "å·²ä¸‹ç­";
          btn.disabled = true;
        }
        
      }, () => {
        alert("ç„¡æ³•å®šä½ï¼Œè«‹é–‹å•Ÿ GPS");
        btn.disabled = false;
        btn.textContent = btn.dataset.type;
      });
    }

    // Manager Dashboard
    function showMgrTab(tab) {
      document.getElementById("mgr-tab-pending").classList.toggle("active", tab==='pending');
      document.getElementById("mgr-tab-today").classList.toggle("active", tab==='today');
      
      document.getElementById("mgr-view-pending").classList.toggle("hidden", tab!=='pending');
      document.getElementById("mgr-view-today").classList.toggle("hidden", tab!=='today');
    }

    async function loadManagerData() {
      // 1. Pending Leaves
      const rList = document.getElementById("mgr-review-list");
      rList.innerHTML = "è¼‰å…¥ä¸­...";
      const rRes = await fetch(`${API_URL}?action=getAllPendingLeaves`);
      const rData = await rRes.json();
      
      if (rData.items.length > 0) {
        document.getElementById("dot-mgr").classList.add("notification-dot");
        rList.innerHTML = rData.items.map(i => `
          <div class="dash-item">
            <span>${i.name} - ${i.leaveType} (${i.date})</span>
            <button class="btn-approve" style="padding:4px 8px; width:auto;" onclick="reviewLeave(${i.rowIndex}, '${i.email}', '${i.date}', 'é€šé')">âœ…</button>
          </div>
        `).join("");
      } else {
        rList.innerHTML = "ç„¡å¾…å¯©æ ¸é …ç›®";
        document.getElementById("dot-mgr").classList.remove("notification-dot");
      }

      // 2. Today Dashboard
      const dList = document.getElementById("mgr-dashboard-list");
      dList.innerHTML = "è¼‰å…¥ä¸­...";
      const dRes = await fetch(`${API_URL}?action=getManagerDashboard`);
      const dData = await dRes.json();
      
      let html = "";
      dData.items.forEach(i => {
        html += `
          <div class="dash-item">
            <span>${i.name} <small style="color:#888">(${i.dept})</small></span>
            <span class="dash-time">${i.in} / ${i.out}</span>
          </div>`;
      });
      dList.innerHTML = html || "ä»Šæ—¥ç„¡äººä¸Šç­";
    }

    async function reviewLeave(idx, em, dt, st) {
      if(!confirm("ç¢ºå®šé€šé?")) return;
      await fetch(API_URL, {
        method: "POST", mode: "no-cors",
        body: JSON.stringify({ action: "reviewLeave", rowIndex: idx, email: em, date: dt, status: st })
      });
      alert("å·²å¯©æ ¸");
      loadManagerData();
    }

    // Admin Actions
    async function adminGiveToken() {
      const em = document.getElementById("adm-token-email").value;
      const amt = document.getElementById("adm-token-amt").value;
      if(!em || !amt) return;
      await fetch(API_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "adminGiveToken", targetEmail: em, amount: amt }) });
      alert("ç™¼é€å®Œæˆ");
    }
    async function adminSetAnnounce() {
      const t = document.getElementById("adm-ann-title").value;
      const c = document.getElementById("adm-ann-content").value;
      await fetch(API_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "adminSetAnnounce", title: t, content: c }) });
      alert("å…¬å‘Šå·²ç™¼å¸ƒ");
    }
    async function adminSync(type) {
      if(!confirm("ç¢ºå®šåŸ·è¡Œ?")) return;
      await fetch(API_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "adminSync", type: type }) });
      alert("åŒæ­¥æŒ‡ä»¤å·²ç™¼é€");
    }

    // Gacha
    function openGacha(){ document.getElementById("gacha-modal").classList.add("open"); switchGachaTab('play'); }
    function closeGacha(){ document.getElementById("gacha-modal").classList.remove("open"); resetGachaUI(); }
    function resetGachaUI(){
      document.getElementById("gacha-result-display").classList.remove("show");
      document.getElementById("gacha-result-display").innerHTML = "";
      document.getElementById("gacha-action-btn").disabled = false;
      document.getElementById("gacha-action-btn").classList.remove("shake-hard");
    }
    function switchGachaTab(tab){
      document.getElementById("tab-gacha-play").classList.toggle("active", tab==='play');
      document.getElementById("tab-gacha-log").classList.toggle("active", tab==='log');
      if(tab==='play'){
        document.getElementById("gacha-view-play").classList.remove("hidden");
        document.getElementById("gacha-view-log").classList.add("hidden");
      } else {
        document.getElementById("gacha-view-play").classList.add("hidden");
        document.getElementById("gacha-view-log").classList.remove("hidden");
        // Load Gacha Log (Simplified for now, can be API call)
        document.getElementById("gacha-history-list").innerHTML = "<div style='text-align:center;padding:10px;color:#999'>ç´€éŒ„è¼‰å…¥ä¸­...</div>";
      }
    }
    function playGachaAnimation() {
      var currentCoins = parseInt(document.getElementById("modal-coin-count").textContent);
      if(currentCoins < 1) { alert("ä»£å¹£ä¸è¶³ï¼"); return; }

      // Deduct UI
      document.getElementById("modal-coin-count").textContent = currentCoins - 1;
      document.getElementById("hud-coin").textContent = currentCoins - 1;

      var btn = document.getElementById("gacha-action-btn");
      var resBox = document.getElementById("gacha-result-display");
      btn.disabled = true;
      resBox.classList.remove("show");
      resBox.innerHTML = "";
      btn.classList.add("shake-hard");
      
      setTimeout(async function(){
        btn.classList.remove("shake-hard");
        
        // Call API
        try {
          const res = await fetch(API_URL, {
            method: "POST", 
            body: JSON.stringify({ action: "drawGacha", email: currentUser.email })
          });
          const data = await res.json();
          
          if(data.win) {
            resBox.innerHTML = "<span style='color:#d35400; font-size:1.4rem;'>ğŸ‰ ä¸­çå•¦ï¼æˆªåœ–é ˜ç</span>";
          } else {
            resBox.innerHTML = "<span style='color:#555;'>æ²’ä¸­...æ˜å¤©å†ä¾† ğŸ˜‚</span>";
          }
          resBox.classList.add("show");
          btn.disabled = false;
          
        } catch(e) {
          alert("é€£ç·šéŒ¯èª¤");
          btn.disabled = false;
        }
      }, 1500);
    }

    // Leave & Calendar Helpers
    function openLeaveForm() {
      document.getElementById("leave-modal").classList.add("open");
      const sel = document.getElementById("leave-date");
      sel.innerHTML = "";
      for(let i=0;i<30;i++){
        let d = new Date(); d.setDate(d.getDate()+i);
        let s = d.toISOString().split('T')[0];
        let opt = document.createElement("option"); opt.text=s; opt.value=s; sel.add(opt);
      }
    }
    async function submitLeave() {
      await fetch(API_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "applyLeave", email: currentUser.email, date: document.getElementById("leave-date").value, leaveType: document.getElementById("leave-type").value, reason: document.getElementById("leave-reason").value }) });
      alert("å·²é€å‡º"); closeLeaveForm(); loadLeaveHistory(currentUser.email);
    }
    function closeLeaveForm(){ document.getElementById("leave-modal").classList.remove("open"); }
    
    async function loadLeaveHistory(e){
      try{
        var r=await fetch(API_URL+"?action=leaveHistory&email="+e);
        var d=await r.json();
        document.getElementById("leave-history").innerHTML=d.items.map(i=>`<div class="leave-card"><div class="row-1"><span class="title">${i.leaveType}</span><span class="status-bar status-${i.status}">${i.status}</span></div><div class="info">${i.date}</div></div>`).join("");
      }catch(_){}
    }

    function showAnnounce(ann) {
      document.getElementById("announce-title").textContent = ann.title;
      document.getElementById("announce-content").textContent = ann.content;
      document.getElementById("announce-modal").style.display = "flex";
      localStorage.setItem("q_ann_id", ann.id);
    }
    function closeAnnounce() { document.getElementById("announce-modal").style.display = "none"; }

    function pad(n){ return ("0"+n).slice(-2); }
    function changeMonth(o){ currentMonth+=o; if(currentMonth<0){currentMonth=11;currentYear--;} if(currentMonth>11){currentMonth=0;currentYear++;} loadCalendar(currentYear,currentMonth); updateMonthShiftMarkers(); }
    
    function loadCalendar(year, month) {
      var grid = document.getElementById("calendar-grid");
      grid.innerHTML = "";
      document.getElementById("calendar-title").textContent = year + " å¹´ " + (month + 1) + " æœˆ";
      var d = new Date(year, month, 1).getDay(); d = (d + 6) % 7;
      var dim = new Date(year, month + 1, 0).getDate();
      ["ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","æ—¥"].forEach(n => { var c = document.createElement("div"); c.textContent = n; c.className = "day-name"; grid.appendChild(c); });
      for (var i = 0; i < d; i++) grid.appendChild(document.createElement("div"));
      for (var i = 1; i <= dim; i++) {
        let cell = document.createElement("div"); cell.className = "day-cell";
        cell.innerHTML = `<div>${i}</div><div class="day-indicator"></div>`;
        let ds = year + "-" + pad(month + 1) + "-" + pad(i);
        cell.onclick = function() {
          document.querySelectorAll(".day-cell").forEach(x => x.classList.remove("selected"));
          this.classList.add("selected");
          document.getElementById("selected-shift").innerHTML = "...";
          loadAllShifts(ds);
        };
        grid.appendChild(cell);
      }
    }
    
    async function updateMonthShiftMarkers() {
      try {
        var ym = currentYear + "-" + pad(currentMonth + 1);
        var res = await fetch(`${API_URL}?month=${ym}&mode=summary&email=${currentUser.email}`);
        var d = await res.json();
        document.querySelectorAll(".day-cell").forEach(c => {
          var dv = c.querySelector("div").textContent;
          if (!dv) return;
          var f = ym + "-" + pad(dv);
          if (d.zhongshanDays.includes(f)) c.classList.add("shift-zhongshan");
          if (d.jingmeiDays.includes(f)) c.classList.add("shift-jingmei");
        });
      } catch (e) {}
    }
    
    async function loadAllShifts(ds) {
      try {
        var r = await fetch(`${API_URL}?date=${ds}&mode=all`);
        var d = await res.json(); // Note: getAllShiftsForDate_ is stub in backend for now
        document.getElementById("selected-shift").innerHTML = ds + "<br>è©³ç´°ç­è¡¨";
      } catch (e) {}
    }
  </script>
</body>
</html>
