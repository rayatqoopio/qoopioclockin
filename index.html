<!DOCTYPE html>
<html lang="zh-TW" style="background-color: #fdf5e6;">
<head>
  <meta charset="UTF-8" />
  <title>Qoopio å“¡å·¥ç³»çµ± (Cloud v4.0)</title>
  <meta name="theme-color" content="#fdf5e6" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no" />
  <link rel="manifest" href="manifest.json?v=20251201" />
  <link rel="icon" href="icon.png" />
  <script>
    if("serviceWorker" in navigator) navigator.serviceWorker.register("service-worker.js?v=20251201");
  </script>
  <style>
    /* CSS Reset & Base */
    @supports(height:100dvh){.container{min-height:calc(100dvh - env(safe-area-inset-bottom,0px))}}
    html,body{margin:0;padding:0;height:100%;background-color:#fdf5e6;font-family:"Helvetica Neue",Arial,sans-serif;color:#333;text-align:center;overflow-x:hidden;overscroll-behavior-y:none;}
    .hidden{display:none !important;}
    
    /* Header */
    #global-header{position:fixed;top:0;left:0;right:0;height:60px;background-color:#fdf5e6;display:flex;align-items:center;justify-content:center;z-index:10010;padding-top:env(safe-area-inset-top,0px);}
    .header-logo{height:56px;width:auto;display:block;}

    /* Container */
    .container{max-width:500px;margin:0 auto;padding:calc(60px + env(safe-area-inset-top,0px)) 1rem calc(3rem + env(safe-area-inset-bottom,0px));box-sizing:border-box;min-height:calc(100vh - env(safe-area-inset-bottom,0px));display:flex;flex-direction:column;}
    .page-section{width:100%;flex:1;}

    /* Login */
    #login-page{padding-top:10vh;display:block;}
    .logo-large{width:200px;margin-bottom:1.5rem;}
    #login-page input{width:80%;padding:0.8rem;margin:1rem 0;border-radius:8px;border:1px solid #ccc;}
    #login-page button{padding:0.8rem 1.5rem;background:#111;color:#fff;border:none;border-radius:8px;cursor:pointer;}

    /* Clock In */
    #page-clock{display:flex;flex-direction:column;justify-content:center;padding-top:10vh;padding-bottom:15vh;}
    .user-label{font-size:1.1rem;font-weight:bold;margin-bottom:0.4rem;}
    .user-pos{font-size:0.9rem;color:#666;margin-bottom:1rem;}
    #clockInBtn{width:80%;padding:1.7rem;font-size:1.3rem;background:#111;color:#fff;border:none;border-radius:10px;margin:0.8rem auto;transition:opacity 0.3s;}
    #clockInBtn:disabled{background:#bbb;opacity:.6;}
    .logout-btn{background:none;border:none;color:#777;margin:0 auto;}
    #status{margin-top:1rem;font-weight:bold;}

    /* Manager/Admin Dashboard */
    .dashboard-card{background:#fff;padding:15px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:15px;text-align:left;}
    .dash-title{font-size:1rem;font-weight:bold;margin-bottom:10px;border-left:4px solid #111;padding-left:8px;}
    .dash-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee;font-size:0.9rem;}
    .dash-item:last-child{border-bottom:none;}
    .dash-time{font-family:monospace;font-weight:bold;}
    
    .admin-input{width:100%;padding:10px;margin-bottom:10px;border:1px solid #ddd;border-radius:8px;box-sizing:border-box;}
    .admin-btn{width:100%;padding:12px;background:#111;color:#fff;border:none;border-radius:8px;font-weight:bold;margin-bottom:5px;}
    .admin-btn.secondary{background:#fff;color:#111;border:1px solid #111;}

    /* FAB */
    .menu-fab{position:fixed;left:16px;bottom:calc(16px + env(safe-area-inset-bottom,0px));z-index:10020;display:none;flex-direction:column;align-items:flex-start;}
    #fab-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:10015;}
    .fab-main{width:60px;height:60px;border-radius:50%;background:#111;color:#fff;border:none;box-shadow:0 6px 16px rgba(0,0,0,0.35);font-size:1.6rem;position:relative;}
    .fab-icon-o,.fab-icon-x{position:absolute;font-weight:700;transition:all 0.3s;}
    .fab-icon-o{opacity:1;transform:scale(1);} .fab-icon-x{opacity:0;transform:rotate(-90deg)scale(0.5);}
    .fab-main.open .fab-icon-o{opacity:0;transform:scale(0.5);} .fab-main.open .fab-icon-x{opacity:1;transform:rotate(0deg)scale(1);}
    .menu-sheet.hidden{display:none;} .fab-option{display:flex;align-items:center;margin-bottom:10px;}
    .menu-item{padding:8px 14px;background:#fff;border:none;border-radius:999px;box-shadow:0 4px 12px rgba(0,0,0,0.18);cursor:pointer;}
    .menu-circle{width:35px;height:35px;margin-left:8px;border-radius:50%;background:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(0,0,0,0.25);position:relative;}
    .notification-dot::after{content:'';position:absolute;top:-2px;right:-2px;width:10px;height:10px;background:#ff3b30;border-radius:50%;border:2px solid #fff;}

    /* HUD */
    .hud-right{position:fixed;right:16px;bottom:calc(16px + env(safe-area-inset-bottom,0px));display:none;z-index:10001;}
    .gacha-btn{background:transparent;border:0;}
    .gacha-img{width:96px;height:96px;}
    .gacha-badge{position:absolute;right:-6px;top:-6px;min-width:22px;padding:0 6px;border-radius:999px;background:#111;color:#fff;font-size:12px;font-weight:800;border:1px solid #fff;}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:10030;} .modal.open{display:flex;}
    .modal-card{width:min(520px,92%);background:#fff;border-radius:16px;padding:16px;text-align:left;}
    .modal-header{display:flex;justify-content:space-between;margin-bottom:10px;} .modal-header h3{margin:0;}
    .modal-close{background:none;border:none;font-size:1.2rem;}
    
    /* Loading */
    #loading-screen{position:fixed;inset:0;background:#fdf5e6;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:20000;transition:opacity 0.3s;}
    #loading-screen.hidden{opacity:0;pointer-events:none;}
    .spinner{width:40px;height:40px;border:4px solid #ccc;border-top-color:#111;border-radius:50%;animation:spin 0.8s linear infinite;margin-bottom:10px;}
    @keyframes spin{to{transform:rotate(360deg);}}

    /* Announcement */
    #announce-modal .modal-card{text-align:center;}
    #announce-title{font-size:1.2rem;font-weight:bold;margin-bottom:10px;}
    #announce-content{font-size:1rem;color:#555;margin-bottom:20px;line-height:1.5;}
  </style>
</head>
<body>
  <div id="loading-screen"><div class="spinner"></div><p>ç³»çµ±é€£ç·šä¸­...</p></div>
  <div id="fab-overlay" class="hidden" onclick="toggleMenu()"></div>
  <header id="global-header" class="hidden"><img src="qoopio logo.png" class="header-logo" /></header>

  <div class="container">
    <div id="login-page" class="hidden page-section">
      <img src="qoopio logo.png" class="logo-large" />
      <h3>å“¡å·¥ç™»å…¥</h3>
      <input type="email" id="login-email" placeholder="è¼¸å…¥ Email" />
      <button onclick="login()">é€²å…¥ç³»çµ±</button>
    </div>

    <div id="page-clock" class="hidden page-section">
      <div id="user-label" class="user-label"></div>
      <div id="user-pos" class="user-pos"></div>
      <button id="clockInBtn" type="button" onclick="submitClockIn()">è®€å–ä¸­...</button>
      <button onclick="resetApp()" class="logout-btn">ç™»å‡º</button>
      <div id="status"></div>
    </div>

    <div id="page-leave" class="hidden page-section">
      <h3>ç”³è«‹è«‹å‡</h3>
      <div style="text-align:left; padding:10px; background:#fff; border-radius:10px;">
        <label>æ—¥æœŸ <select id="leave-date" style="width:100%;padding:8px;margin:5px 0;"></select></label>
        <label>å‡åˆ¥ <select id="leave-type" style="width:100%;padding:8px;margin:5px 0;">
          <option>äº‹å‡</option><option>ç—…å‡</option><option>ä¼‘å‡</option><option>ç‰¹ä¼‘å‡</option>
        </select></label>
        <label>åŸå›  <input id="leave-reason" style="width:100%;padding:8px;" /></label>
        <button class="admin-btn" onclick="submitLeave()" style="margin-top:15px;">é€å‡ºç”³è«‹</button>
      </div>
      <h4>æ­·å²ç´€éŒ„</h4>
      <div id="leave-history-list"></div>
    </div>

    <div id="page-schedule" class="hidden page-section">
      <div style="padding:20px;">ç­è¡¨åŠŸèƒ½é–‹ç™¼ä¸­ (å·²é€£çµ A è¡¨)</div>
    </div>

    <div id="page-manager" class="hidden page-section">
      <div class="dash-title">ä»Šæ—¥å‡ºå‹¤æˆ°æƒ…å®¤</div>
      <div class="dashboard-card" id="mgr-dashboard-list">è¼‰å…¥ä¸­...</div>
      
      <div class="dash-title">å¾…å¯©æ ¸å‡å–®</div>
      <div class="dashboard-card" id="mgr-review-list">ç„¡å¾…å¯©æ ¸é …ç›®</div>
    </div>

    <div id="page-admin" class="hidden page-section">
      <div class="dash-title">ç™¼é€æ‰­è›‹ä»£å¹£</div>
      <div class="dashboard-card">
        <input id="adm-token-email" class="admin-input" placeholder="å“¡å·¥ Email" />
        <input id="adm-token-amt" class="admin-input" type="number" placeholder="æ•¸é‡ (ä¾‹å¦‚ 1)" />
        <input id="adm-token-reason" class="admin-input" placeholder="åŸå›  (é¸å¡«)" />
        <button class="admin-btn" onclick="adminGiveToken()">ç™¼é€ä»£å¹£</button>
      </div>

      <div class="dash-title">å…¨åŸŸå…¬å‘Šè¨­å®š</div>
      <div class="dashboard-card">
        <input id="adm-ann-title" class="admin-input" placeholder="å…¬å‘Šæ¨™é¡Œ" />
        <textarea id="adm-ann-content" class="admin-input" placeholder="å…¬å‘Šå…§å®¹..." rows="3"></textarea>
        <button class="admin-btn" onclick="adminSetAnnounce()">ç™¼å¸ƒå…¬å‘Š</button>
      </div>

      <div class="dash-title">ç³»çµ±åŒæ­¥</div>
      <div class="dashboard-card">
        <button class="admin-btn secondary" onclick="adminSync('schedule')">åŒæ­¥ A è¡¨ç­è¡¨</button>
        <button class="admin-btn secondary" onclick="adminSync('clock')">è£œå¡«å‡ºå‹¤æ™‚é–“</button>
      </div>
    </div>
  </div>

  <div class="menu-fab" id="menu-fab">
    <div class="menu-sheet hidden" id="menu-sheet">
      <div class="fab-option"><button class="menu-item" onclick="nav('clock')">æ‰“å¡</button><div class="menu-circle">â±</div></div>
      <div class="fab-option"><button class="menu-item" onclick="nav('leave')">è«‹å‡</button><div class="menu-circle">ğŸ“</div></div>
      <div class="fab-option"><button class="menu-item" onclick="nav('schedule')">ç­è¡¨</button><div class="menu-circle">ğŸ“…</div></div>
      <div class="fab-option hidden" id="fab-mgr"><button class="menu-item" onclick="nav('manager')">è«‹å‡å¯©æ ¸</button><div class="menu-circle" id="dot-mgr">ğŸ–‹ï¸</div></div>
      <div class="fab-option hidden" id="fab-adm"><button class="menu-item" onclick="nav('admin')">ç®¡ç†å“¡</button><div class="menu-circle">ğŸ”§</div></div>
    </div>
    <button class="fab-main" onclick="toggleMenu()"><span class="fab-icon-o">O</span><span class="fab-icon-x">âœ•</span></button>
  </div>

  <div class="hud-right" id="hud-right">
    <button class="gacha-btn" onclick="openGacha()"><img src="icon.png" class="gacha-img" /><span class="gacha-badge" id="hud-coin">0</span></button>
  </div>

  <div class="modal" id="announce-modal">
    <div class="modal-card">
      <div id="announce-title"></div>
      <div id="announce-content"></div>
      <button class="admin-btn" onclick="closeAnnounce()">æˆ‘çŸ¥é“äº†</button>
    </div>
  </div>

  <script>
    // âš ï¸ æ›¿æ›æˆ C è¡¨éƒ¨ç½²çš„ URL
    const API_URL = "https://script.google.com/macros/s/AKfycbzdG-XnSqTjbrRft_K4Wc3alPIso5RinyXjpqM82Ne6HAg4TW-b3IxUBc6n9kuSbT_y-Q/exec";
    
    let currentUser = null;

    // Init
    window.onload = async () => {
      const email = localStorage.getItem("q_email");
      if (email) {
        await appInit(email);
      } else {
        document.getElementById("loading-screen").classList.add("hidden");
        document.getElementById("login-page").classList.remove("hidden");
      }
    };

    async function appInit(email) {
      document.getElementById("login-page").classList.add("hidden");
      document.getElementById("loading-screen").classList.remove("hidden");
      
      try {
        const res = await fetch(`${API_URL}?action=initApp&email=${email}`);
        const data = await res.json();
        
        if (!data.ok) { alert(data.msg); resetApp(); return; }
        
        currentUser = data.user;
        currentUser.email = email;
        
        // UI Setup
        setupUI(data);
        
        // Announcement Check
        if (data.announcement) {
          const lastRead = localStorage.getItem("q_ann_id");
          if (lastRead != data.announcement.id) {
            showAnnounce(data.announcement);
          }
        }

        document.getElementById("loading-screen").classList.add("hidden");
        document.getElementById("global-header").classList.remove("hidden");
        document.getElementById("page-clock").classList.remove("hidden");
        document.getElementById("menu-fab").style.display = "flex";
        document.getElementById("hud-right").style.display = "inline-flex";

      } catch (e) {
        alert("é€£ç·šå¤±æ•—ï¼Œè«‹é‡è©¦");
        document.getElementById("loading-screen").classList.add("hidden");
        document.getElementById("login-page").classList.remove("hidden");
      }
    }

    function setupUI(data) {
      // Profile
      document.getElementById("user-label").textContent = currentUser.name;
      document.getElementById("user-pos").textContent = `${currentUser.role} | ${currentUser.position}`;
      
      // Tokens
      document.getElementById("hud-coin").textContent = data.tokens;
      
      // Clock Btn
      const btn = document.getElementById("clockInBtn");
      const status = document.getElementById("status");
      if (data.clockStatus.includes("å·²")) {
        status.textContent = data.clockStatus;
        status.style.color = "green";
        btn.textContent = data.clockStatus.includes("ä¸‹ç­") ? "å·²ä¸‹ç­" : "ä¸‹ç­";
        btn.style.background = "#333";
        btn.dataset.type = data.clockStatus.includes("ä¸‹ç­") ? "done" : "ä¸‹ç­";
        if(btn.dataset.type==="done") btn.disabled = true;
      } else {
        btn.textContent = "ä¸Šç­";
        btn.dataset.type = "ä¸Šç­";
      }
      
      // Permissions
      if (currentUser.role === 'manager' || currentUser.role === 'admin') {
        document.getElementById("fab-mgr").classList.remove("hidden");
      }
      if (currentUser.role === 'admin') {
        document.getElementById("fab-adm").classList.remove("hidden");
      }
    }

    function login() {
      const email = document.getElementById("login-email").value.trim();
      if (!email) return;
      localStorage.setItem("q_email", email);
      appInit(email);
    }

    function resetApp() {
      localStorage.removeItem("q_email");
      location.reload();
    }

    // Navigation
    function toggleMenu() {
      const sheet = document.getElementById("menu-sheet");
      const overlay = document.getElementById("fab-overlay");
      const fab = document.querySelector(".fab-main");
      sheet.classList.toggle("hidden");
      overlay.classList.toggle("hidden");
      fab.classList.toggle("open");
    }

    function nav(page) {
      document.querySelectorAll(".page-section").forEach(p => p.classList.add("hidden"));
      document.getElementById("page-" + page).classList.remove("hidden");
      toggleMenu();
      
      if (page === 'manager') loadManagerData();
    }

    // Clock In
    function submitClockIn() {
      const btn = document.getElementById("clockInBtn");
      if (btn.disabled) return;
      
      btn.disabled = true;
      btn.textContent = "å®šä½ä¸­...";
      
      navigator.geolocation.getCurrentPosition(async (pos) => {
        const type = btn.dataset.type;
        btn.textContent = "æ‰“å¡ä¸­...";
        
        const res = await fetch(API_URL, {
          method: "POST", mode: "no-cors",
          body: JSON.stringify({
            action: "clockIn",
            email: currentUser.email,
            type: type,
            lat: pos.coords.latitude,
            lng: pos.coords.longitude
          })
        });
        
        // Optimistic UI update
        alert("æ‰“å¡æˆåŠŸï¼");
        if (type === "ä¸Šç­") {
          btn.textContent = "ä¸‹ç­";
          btn.dataset.type = "ä¸‹ç­";
          btn.disabled = false;
        } else {
          btn.textContent = "å·²ä¸‹ç­";
          btn.disabled = true;
        }
        
      }, () => {
        alert("ç„¡æ³•å®šä½ï¼Œè«‹é–‹å•Ÿ GPS");
        btn.disabled = false;
        btn.textContent = btn.dataset.type;
      });
    }

    // Manager Dashboard
    async function loadManagerData() {
      const list = document.getElementById("mgr-dashboard-list");
      list.innerHTML = "è¼‰å…¥ä¸­...";
      
      const res = await fetch(`${API_URL}?action=getManagerDashboard`);
      const data = await res.json();
      
      let html = "";
      data.items.forEach(i => {
        html += `
          <div class="dash-item">
            <span>${i.name} <small>(${i.dept})</small></span>
            <span class="dash-time">${i.in} / ${i.out}</span>
          </div>`;
      });
      list.innerHTML = html || "ä»Šæ—¥ç„¡äººä¸Šç­";
      
      // Load Reviews
      const rList = document.getElementById("mgr-review-list");
      const rRes = await fetch(`${API_URL}?action=getAllPendingLeaves`);
      const rData = await rRes.json();
      
      if (rData.items.length > 0) {
        document.getElementById("dot-mgr").classList.add("notification-dot");
        rList.innerHTML = rData.items.map(i => `
          <div class="dash-item">
            <span>${i.name} - ${i.leaveType} (${i.date})</span>
            <button onclick="reviewLeave(${i.rowIndex}, '${i.email}', '${i.date}', 'é€šé')">âœ…</button>
          </div>
        `).join("");
      } else {
        rList.innerHTML = "ç„¡å¾…å¯©æ ¸é …ç›®";
        document.getElementById("dot-mgr").classList.remove("notification-dot");
      }
    }

    async function reviewLeave(idx, em, dt, st) {
      if(!confirm("ç¢ºå®šé€šé?")) return;
      await fetch(API_URL, {
        method: "POST", mode: "no-cors",
        body: JSON.stringify({ action: "reviewLeave", rowIndex: idx, email: em, date: dt, status: st })
      });
      alert("å·²å¯©æ ¸");
      loadManagerData();
    }

    // Admin Actions
    async function adminGiveToken() {
      const em = document.getElementById("adm-token-email").value;
      const amt = document.getElementById("adm-token-amt").value;
      if(!em || !amt) return;
      await fetch(API_URL, {
        method: "POST", mode: "no-cors",
        body: JSON.stringify({ action: "adminGiveToken", targetEmail: em, amount: amt })
      });
      alert("ç™¼é€å®Œæˆ");
    }

    async function adminSetAnnounce() {
      const t = document.getElementById("adm-ann-title").value;
      const c = document.getElementById("adm-ann-content").value;
      if(!t) return;
      await fetch(API_URL, {
        method: "POST", mode: "no-cors",
        body: JSON.stringify({ action: "adminSetAnnounce", title: t, content: c })
      });
      alert("å…¬å‘Šå·²ç™¼å¸ƒ");
    }

    async function adminSync(type) {
      if(!confirm("ç¢ºå®šåŸ·è¡Œ?")) return;
      await fetch(API_URL, {
        method: "POST", mode: "no-cors",
        body: JSON.stringify({ action: "adminSync", type: type })
      });
      alert("åŒæ­¥æŒ‡ä»¤å·²ç™¼é€");
    }

    // Announcement
    function showAnnounce(ann) {
      document.getElementById("announce-title").textContent = ann.title;
      document.getElementById("announce-content").textContent = ann.content;
      document.getElementById("announce-modal").style.display = "flex";
      localStorage.setItem("q_ann_id", ann.id);
    }
    function closeAnnounce() {
      document.getElementById("announce-modal").style.display = "none";
    }
    
    // Leave Apply (Simplified)
    function openLeaveForm() {
      document.getElementById("leave-modal").style.display = "flex";
      const sel = document.getElementById("leave-date");
      sel.innerHTML = "";
      for(let i=0;i<30;i++){
        let d = new Date(); d.setDate(d.getDate()+i);
        let s = d.toISOString().split('T')[0];
        let opt = document.createElement("option"); opt.text=s; opt.value=s; sel.add(opt);
      }
    }
    async function submitLeave() {
      await fetch(API_URL, {
        method: "POST", mode: "no-cors",
        body: JSON.stringify({
          action: "applyLeave",
          email: currentUser.email,
          date: document.getElementById("leave-date").value,
          leaveType: document.getElementById("leave-type").value,
          reason: document.getElementById("leave-reason").value
        })
      });
      alert("å·²é€å‡º");
      document.getElementById("leave-modal").style.display = "none";
    }
    function closeLeaveForm(){ document.getElementById("leave-modal").style.display = "none"; }
  </script>
</body>
</html>
