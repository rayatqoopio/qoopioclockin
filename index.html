<!DOCTYPE html>
<html lang="zh-TW" style="background-color: #fdf5e6;">
<head>
  <meta charset="UTF-8" />
  <title>Qoopio å“¡å·¥ç³»çµ± (Gacha Upgrade)</title>
  
  <meta name="theme-color" content="#fdf5e6" media="(prefers-color-scheme: light)" />
  <meta name="theme-color" content="#fdf5e6" media="(prefers-color-scheme: dark)" />
  <meta name="theme-color" content="#fdf5e6" />

  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no" />
  
  <link rel="manifest" href="manifest.json?v=20251117" />
  <link rel="icon" href="icon.png" />
  <script>
    (function () {
      if (!("serviceWorker" in navigator)) return;
      navigator.serviceWorker.register("service-worker.js?v=20251117");
    })();
  </script>
  <style>
    @supports (height: 100dvh) { .container { min-height: calc(100dvh - env(safe-area-inset-bottom, 0px)); } }
    html, body { margin: 0; padding: 0; height: 100%; background-color: #fdf5e6; font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; color: #333; text-align: center; overflow-x: hidden; overscroll-behavior-y: none; }
    .hidden { display: none !important; }

    /* Header */
    #global-header { 
      position: fixed; top: 0; left: 0; right: 0; 
      height: 60px; 
      background-color: #fdf5e6; 
      display: flex; align-items: center; justify-content: center; 
      z-index: 10010; 
      padding-top: env(safe-area-inset-top, 0px); 
    }
    .header-logo { height: 56px; width: auto; display: block; }

    /* Container */
    .container { max-width: 500px; margin: 0 auto; padding: calc(60px + env(safe-area-inset-top, 0px)) 1rem calc(3rem + env(safe-area-inset-bottom, 0px)); box-sizing: border-box; min-height: calc(100vh - env(safe-area-inset-bottom, 0px)); display: flex; flex-direction: column; }
    .page-section { width: 100%; flex: 1; }

    /* Login */
    #login-page { padding-top: 10vh; display: block; }
    .logo-large { width: 200px; margin-bottom: 1.5rem; }
    #login-page input { width: 80%; padding: 0.8rem; margin: 1rem 0; font-size: 1rem; border-radius: 8px; border: 1px solid #ccc; }
    #login-page button { padding: 0.8rem 1.5rem; font-size: 1rem; background: #111; color: #fff; border: none; border-radius: 8px; cursor: pointer; }

    /* Clock In */
    #page-clock { display: flex; flex-direction: column; justify-content: center; padding-top: 10vh; padding-bottom: 15vh; }
    .user-label { font-size: 1rem; font-weight: bold; margin-bottom: 0.4rem; }
    #clockInBtn { width: 80%; padding: 1.7rem; font-size: 1.3rem; background-color: #111; color: #fff; border: none; border-radius: 10px; cursor: pointer; display: block; margin: 0.8rem auto; transition: opacity 0.3s; }
    #clockInBtn:disabled { background-color: #bbb !important; opacity: .6; pointer-events: none; }
    .logout-btn { background: none; border: none; color: #777; font-size: 0.8rem; cursor: pointer; display: block; margin: 0 auto; }
    #status { margin-top: 1rem; font-size: 0.95rem; font-weight: bold; min-height: 1.2em; }
    #leave-pending-banner { margin-top: 0.3rem; font-size: 0.9rem; color: #c0392b; font-weight: bold; min-height: 1.2em; }

    /* Calendar */
    .calendar-header { padding-top: 1rem; display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; font-size: 1.2rem; font-weight: bold; }
    .calendar-header button { background: none; border: none; font-size: 1.4rem; font-weight: bold; color: #333; cursor: pointer; padding: 0.3rem 0.6rem; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 1rem; }
    .day-cell { position: relative; padding: 10px 0; border-radius: 8px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.9rem; }
    .day-cell.today { border: 2px solid #111; font-weight: bold; }
    .day-cell.selected { background-color: #ddd; }
    .day-name { font-weight: bold; color: #666; }
    .day-indicator { width: 8px; height: 8px; border-radius: 50%; margin-top: 4px; }
    .shift-zhongshan .day-indicator { background-color: #e74c3c; }
    .shift-jingmei .day-indicator { background-color: #27ae60; }
    #selected-shift { font-size: 1rem; line-height: 1.8; color: #444; text-align: left; padding: 1rem; border-radius: 10px; background: #fff; box-shadow: 0 0 6px rgba(0,0,0,0.1); min-height: 100px; }
    .group-title { font-weight: bold; color: #000; margin-top: 1rem; margin-bottom: 0.5rem; }

    /* Leave Page */
    #page-leave { text-align: left; padding-top: 1vh; }
    .leave-btn-main { position: fixed; left: 50%; transform: translateX(-50%); bottom: calc(100px + env(safe-area-inset-bottom, 0px)); z-index: 9998; width: 55%; min-width: 180px; max-width: 300px; padding: 0.9rem; font-size: 1rem; border-radius: 999px; border: none; background: #111; color: #fff; cursor: pointer; box-shadow: 0 4px 14px rgba(0,0,0,0.12); }
    #leave-history { margin-top: 0.5rem; font-size: 0.9rem; color: #555; }
    .leave-card { padding: 0.8rem; border-radius: 12px; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 0.8rem; text-align: left; }
    .leave-card .row-1 { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.4rem; font-weight: bold; }
    .leave-card .row-1 .title { font-size: 1rem; color: #111; }
    .status-bar { display: inline-flex; height: 24px; padding: 0 10px; border-radius: 6px; font-size: 0.8rem; font-weight: 700; color: #fff; align-items: center; }
    .status-å¯©æ ¸ä¸­ { background: #e67e22; } .status-é€šé { background: #27ae60; } .status-é€€å› { background: #c0392b; }
    .leave-card .info { font-size: 0.9rem; color: #555; line-height: 1.5; }
    .leave-card .reason { margin-top: 6px; font-size: 0.9rem; color: #333; font-style: italic; background: #f9f9f9; padding: 6px; border-radius: 6px; }

    /* Manager Page */
    #page-manager { text-align: left; padding-top: 1vh; }
    .manager-tabs { display: flex; gap: 10px; margin-bottom: 15px; justify-content: center; }
    .manager-tabs button { flex: 0 0 auto; width: auto; padding: 10px 16px; border-radius: 8px; border: 1px solid #ccc; background: transparent; font-weight: bold; color: #777; cursor: pointer; font-size: 1.2rem; }
    .manager-tabs button.active { background: #111; color: #fff; border-color: #111; }
    .review-actions { display: flex; gap: 10px; margin-top: 12px; }
    .btn-approve { flex: 1; padding: 10px; border-radius: 8px; border: none; background: #27ae60; color: #fff; font-weight: bold; cursor: pointer; }
    .btn-reject { flex: 1; padding: 10px; border-radius: 8px; border: none; background: #c0392b; color: #fff; font-weight: bold; cursor: pointer; }
    .empty-state { text-align: center; color: #999; margin-top: 30px; font-size: 0.95rem; }

    /* FAB */
    #fab-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 10015; }
    .menu-fab { position: fixed; left: 16px; bottom: calc(16px + env(safe-area-inset-bottom, 0px)); z-index: 10020; display: none; flex-direction: column; align-items: flex-start; }
    .fab-main { width: 60px; height: 60px; border-radius: 50%; border: none; background: #111; color: #fff; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 16px rgba(0,0,0,0.35); font-size: 1.6rem; position: relative; }
    .fab-icon-o, .fab-icon-x { position: absolute; font-family: sans-serif; font-weight: 700; transition: all 0.3s; }
    .fab-icon-o { opacity: 1; transform: scale(1); font-size: 1.5rem; } .fab-icon-x { opacity: 0; transform: rotate(-90deg) scale(0.5); font-size: 1.4rem; }
    .fab-main.open .fab-icon-o { opacity: 0; transform: scale(0.5); } .fab-main.open .fab-icon-x { opacity: 1; transform: rotate(0deg) scale(1); }
    .menu-sheet { margin-bottom: 10px; } .menu-sheet.hidden { display: none; }
    .fab-option { display: flex; align-items: center; margin-bottom: 10px; }
    .menu-item { padding: 8px 14px; border: none; background: #fff; color: #333; font-size: 0.9rem; border-radius: 999px; box-shadow: 0 4px 12px rgba(0,0,0,0.18); white-space: nowrap; cursor: pointer; }
    .menu-circle { width: 35px; height: 35px; margin-left: 8px; border-radius: 50%; background: #fff; color: #555; display: flex; align-items: center; justify-content: center; font-size: 0.95rem; box-shadow: 0 4px 12px rgba(0,0,0,0.25); position: relative; }
    .notification-dot::after { content: ''; position: absolute; top: -2px; right: -2px; width: 10px; height: 10px; background-color: #ff3b30; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    .menu-item.active { background: #111; color: #fff; font-weight: 700; } .menu-item.active + .menu-circle { border: 2px solid #111; }

    /* HUD */
    .hud-right { position: fixed; right: 16px; bottom: calc(16px + env(safe-area-inset-bottom, 0px)); display: none; z-index: 10001; }
    .gacha-btn { background: transparent !important; border: 0 !important; width: auto; height: auto; }
    .gacha-img { width: 96px; height: 96px; } .gacha-img:not(.hidden) + .gacha-svg { display: none; } .gacha-svg { width: 96px; height: 96px; }
    .gacha-badge { position: absolute; right: -6px; top: -6px; min-width: 22px; height: 22px; padding: 0 6px; border-radius: 999px; background: #111; color: #fff; font-weight: 800; font-size: 12px; display: inline-flex; align-items: center; justify-content: center; border: 1px solid #fff; }

    /* Modals (Common) */
    .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.45); z-index: 10030; } .modal.open { display: flex; }
    .modal-card { width: min(520px, 92%); background: #fff; border-radius: 16px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); text-align: left; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; } .modal-header h3 { margin: 0; font-size: 1.1rem; } .modal-close { background: none; border: none; font-size: 1.2rem; cursor: pointer; }
    
    /* Gacha Styles (New) */
    .modal-tabs { display: flex; gap: 8px; margin-bottom: 10px; }
    .modal-tabs button { flex: 1; padding: 8px; border-radius: 10px; border: 1px solid #222; background: #fff; cursor: pointer; font-weight: 700; color: #111; }
    .modal-tabs button.active { background: #111; color: #fff; border-color: #111; }
    .gacha-body-content { text-align: center; padding: 10px 0; }
    .gacha-btn-main {
      width: 100%; padding: 16px; font-size: 1.2rem; font-weight: bold; color: #fff; background-color: #111;
      border: none; border-radius: 12px; cursor: pointer;
      box-shadow: 0 6px 0 #444; /* 3D effect */
      transform: translateY(0);
      transition: all 0.1s;
      margin-bottom: 10px;
    }
    .gacha-btn-main:active { box-shadow: 0 2px 0 #444; transform: translateY(4px); }
    .gacha-btn-main:disabled { background-color: #aaa; box-shadow: none; transform: translateY(4px); cursor: not-allowed; }
    
    .gacha-result { 
      min-height: 60px; display: flex; align-items: center; justify-content: center; 
      font-size: 1.2rem; font-weight: bold; color: #111; margin-top: 10px; 
      opacity: 0; transition: opacity 0.3s;
    }
    .gacha-result.show { opacity: 1; }
    
    /* Gacha Animation */
    .shake-hard { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) infinite; }
    @keyframes shake {
      10%, 90% { transform: translate3d(-1px, 0, 0); }
      20%, 80% { transform: translate3d(2px, 0, 0); }
      30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
      40%, 60% { transform: translate3d(4px, 0, 0); }
    }

    .gacha-log-item { padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.9rem; color: #555; display: flex; justify-content: space-between; }
    .gacha-log-item:last-child { border-bottom: none; }
    .gacha-win { color: #d35400; font-weight: bold; }

    /* Leave Form */
    #leave-form label { display: block; margin-top: 0.5rem; font-size: 0.9rem; color: #555; }
    #leave-form select, #leave-form textarea { width: 100%; box-sizing: border-box; margin-top: 0.2rem; padding: 0.4rem 0.5rem; border-radius: 8px; border: 1px solid #ccc; font-size: 0.9rem; } #leave-form textarea { min-height: 60px; resize: vertical; }
    .leave-form-actions { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 0.8rem; }
    .leave-submit-btn { padding: 0.5rem 1rem; font-size: 0.9rem; border-radius: 999px; border: none; background: #111; color: #fff; cursor: pointer; }
    .leave-cancel-btn { padding: 0.5rem 0.9rem; font-size: 0.9rem; border-radius: 999px; border: 1px solid #aaa; background: #f5f5f5; color: #555; cursor: pointer; }
    #leave-status-msg { margin-top: 0.4rem; font-size: 0.85rem; color: #555; }
    
    /* Loading Spinner */
    .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid #bbb; border-top-color: #111; border-radius: 50%; animation: spin 0.8s linear infinite; vertical-align: middle; margin-right: 8px; }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
    #loading-screen { position: fixed; inset: 0; background: #fdf5e6; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 20000; transition: opacity 0.3s ease; }
    #loading-screen.hidden { opacity: 0; pointer-events: none; }
    #loading-screen .spinner { width: 50px; height: 50px; border: 4px solid #ccc; border-top-color: #111; border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 1rem; }
  </style>
</head>
<body>
  <div id="loading-screen"><div class="spinner"></div><p>è³‡æ–™è¼‰å…¥ä¸­...</p></div>
  <div id="fab-overlay" class="hidden" onclick="toggleMenu()"></div>

  <header id="global-header" class="hidden"><img src="qoopio logo.png" class="header-logo" alt="Qoopio Logo" /></header>

  <div class="container">
    <div id="login-page" class="hidden page-section">
      <img src="qoopio logo.png" class="logo-large" />
      <h3>è«‹è¼¸å…¥æ‚¨çš„ Email ç™»å…¥</h3>
      <input type="email" id="login-email" placeholder="name@qoopio.com" />
      <button type="button" onclick="login()">ç™»å…¥</button>
    </div>

    <div id="page-leave" class="hidden page-section">
      <h3 style="display:none">è«‹å‡</h3>
      <button class="leave-btn-main" type="button" onclick="openLeaveForm()">ç”³è«‹è«‹å‡</button>
      <h4>å€‹äººè«‹å‡ç´€éŒ„</h4>
      <div id="leave-history">è¼‰å…¥ä¸­...</div>
    </div>

    <div id="page-clock" class="hidden page-section">
      <div id="user-label" class="user-label"></div>
      <div id="leave-pending-banner"></div>
      <button id="clockInBtn" type="button" onclick="submitClockIn()">æ‰“å¡</button>
      <button type="button" onclick="resetEmail()" class="logout-btn">ç™»å‡º</button>
      <div id="status"></div>
    </div>

    <div id="page-schedule" class="hidden page-section">
      <div class="calendar-view">
        <div class="calendar-header">
          <button onclick="changeMonth(-1)">ã€ˆ</button><span id="calendar-title"></span><button onclick="changeMonth(1)">ã€‰</button>
        </div>
        <div id="calendar-grid" class="calendar-grid"></div>
        <div id="selected-shift">ğŸ“… è«‹é¸æ“‡æ—¥æœŸ</div>
      </div>
    </div>

    <div id="page-manager" class="hidden page-section">
      <div class="manager-tabs">
        <button id="mgr-tab-pending" class="active" onclick="loadManagerLeaves()">å¾…å¯©æ ¸</button>
      </div>
      <div id="manager-list">
        <div class="empty-state"><div class="loading-spinner"></div> è®€å–ä¸­...</div>
      </div>
    </div>
  </div>

  <div class="menu-fab" id="menu-fab">
    <div class="menu-sheet hidden" id="menu-sheet">
      <div class="fab-option">
        <button class="menu-item" type="button" data-page="clock" onclick="navigateTo('clock')">æ‰“å¡</button><div class="menu-circle">â±</div>
      </div>
      <div class="fab-option">
        <button class="menu-item" type="button" data-page="leave" onclick="navigateTo('leave')">è«‹å‡</button><div class="menu-circle">ğŸ“</div>
      </div>
      <div class="fab-option">
        <button class="menu-item" type="button" data-page="schedule" onclick="navigateTo('schedule')">ç­è¡¨</button><div class="menu-circle">ğŸ“…</div>
      </div>
      <div class="fab-option hidden" id="btn-manager-fab">
        <button class="menu-item" type="button" data-page="manager" onclick="navigateTo('manager')">è«‹å‡å¯©æ ¸</button>
        <div class="menu-circle" id="mgr-fab-circle">ğŸ–‹ï¸</div>
      </div>
    </div>
    <button class="fab-main" type="button" onclick="toggleMenu()">
      <span class="fab-icon-o">O</span><span class="fab-icon-x">âœ•</span>
    </button>
  </div>

  <div class="hud-right" id="hud-right">
    <button class="gacha-btn" id="gachaBtn" type="button"><img id="gacha-img" class="gacha-img hidden" width="36" height="36" /><span class="gacha-badge" id="gacha-badge">0</span></button>
  </div>

  <div class="modal" id="gacha-modal">
    <div class="modal-card">
      <div class="modal-header"><h3>æ‰­è›‹æ©Ÿ</h3><button class="modal-close" onclick="closeGacha()">âœ•</button></div>
      <div class="modal-tabs">
        <button id="tab-gacha-play" class="active" onclick="switchGachaTab('play')">æ‰­è›‹</button>
        <button id="tab-gacha-log" onclick="switchGachaTab('log')">ç´€éŒ„</button>
      </div>
      <div class="modal-body" id="gacha-view-play">
        <div class="gacha-body-content">
          <p><b>ä»£å¹£ï¼š</b><span id="modal-coin-count">0</span></p>
          <div style="height:10px"></div>
          <button id="gacha-action-btn" class="gacha-btn-main" onclick="playGachaAnimation()">START</button>
          <div id="gacha-result-display" class="gacha-result"></div>
          <div style="font-size:0.85rem; color:#888; margin-top:10px;">ç¥æ‚¨ä¸­ç (Â´â‰–â—à±ªâ—Ÿâ‰–)</div>
        </div>
      </div>
      <div class="modal-body hidden" id="gacha-view-log">
        <div id="gacha-history-list" style="max-height:200px; overflow-y:auto;"></div>
      </div>
    </div>
  </div>

  <div class="modal" id="leave-modal">
    <div class="modal-card">
      <div class="modal-header"><h3>ç”³è«‹è«‹å‡</h3><button class="modal-close" onclick="closeLeaveForm()">âœ•</button></div>
      <div class="modal-body">
        <div id="leave-form">
          <div><strong>ç”³è«‹äººï¼š</strong><span id="leave-name">â€”</span></div>
          <label>æ—¥æœŸ<select id="leave-date-select"></select></label>
          <label>å‡åˆ¥<select id="leave-type-select">
            <option value="äº‹å‡">äº‹å‡</option><option value="ç—…å‡">ç—…å‡</option><option value="ä¼‘å‡">ä¼‘å‡</option><option value="ä¾‹å‡">ä¾‹å‡</option><option value="ç‰¹ä¼‘å‡">ç‰¹ä¼‘å‡</option><option value="åœ‹å®šå‡æ—¥è£œä¼‘">åœ‹å®šå‡æ—¥è£œä¼‘</option>
          </select></label>
          <label>åŸå› <textarea id="leave-reason" placeholder="åŸå› ..."></textarea></label>
          <div class="leave-form-actions">
            <button class="leave-cancel-btn" onclick="closeLeaveForm()">å–æ¶ˆ</button>
            <button class="leave-submit-btn" onclick="submitLeave()">é€å‡º</button>
          </div>
          <div id="leave-status-msg"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    var scriptUrl = "https://script.google.com/macros/s/AKfycbzB12OEJhNMEMWQI3lNjm61pfAtl7boHkN8n7MpTsWTLVl7txO4vxFs593fn_YyljOm/exec";
    
    var userData = {
      "lilian6337@gmail.com": { "name": "é™³å½¥å¦‚ â‚á¢.Ë¬.á¢â‚", "role": "manager", "position": "AS/RTR" },
      "tiffany05141997@gmail.com": { "name": "è¨±å®‡ç¦ Ê•-á´¥-Ê”", "role": "staff", "position": "MUA" },
      "ray.at.qoopio@gmail.com": { "name": "å‘‚æ‰¿å¡ à¼¼ ã¤/ÌµÍ‡Ì¿Ì¿/â€™Ì¿â€™Ì¿ Ì¿ Ì¿Ì¿ Ì¿Ì¿â—• _â—• à¼½ã¤", "role": "manager", "position": "AS/PGR" },
      "olaaaqoopio@gmail.com": { "name": "ç‹å½¥èŒ¹ ã€(â™¡Ë™ï¸¶Ë™â™¡)â€˜ ", "role": "staff", "position": "MUA" },
      "violet.qoopio@gmail.com": { "name": "è­šé›¯ Ê•â ã£â â€¢â á´¥â â€¢â Ê”â ã£", "role": "staff", "position": "AS" },
      "ringo.qoopio0407@gmail.com": { "name": "ç‹å§è˜‹ (â•¬â–¼Ğ´ï¾Ÿ)â–„ï¸»â”»â”³â•ä¸€", "role": "staff", "position": "PGR" },
      "rulinqoopio@gmail.com": { "name": "é»ƒèŒ¹ç³", "role": "staff", "position": "AS" },
      "orange.at.qoopio@gmail.com": { "name": "åŠ‰å®‡æ™¨", "role": "staff", "position": "PGR" },
      "xinyu881106.at.qoopio@gmail.com": { "name": "é„­é‘«ä¿", "role": "staff", "position": "MUA" },
      "e3072029@gmail.com": { "name": "é»ƒè¾°éˆº", "role": "staff", "position": "RTR" },
      "pegalt178y@gmail.com": { "name": "å‘¨éœˆæ£‹", "role": "staff", "position": "RTR" },
      "wenwan718@hotmail.com": { "name": "ç¾…æ–‡è", "role": "part-time", "position": "PGR" }
    };

    var currentYear = new Date().getFullYear();
    var currentMonth = new Date().getMonth();
    var LEAVE_PENDING_USERS = ["ray.at.qoopio@gmail.com","lilian6337@gmail.com"];
    var GACHA_ICON = "gacha-icon.png?v=20251117";

    window.onload = function() {
      var email = localStorage.getItem("qoopio_email");
      if (email && userData[email]) {
        initLogin(email);
      } else {
        document.getElementById("loading-screen").classList.add("hidden");
        document.getElementById("login-page").classList.remove("hidden");
      }
      try {
        var img = document.getElementById("gacha-img");
        img.src = GACHA_ICON;
        img.classList.remove("hidden");
      } catch(_){}
    };

    function initLogin(email) {
      document.getElementById("login-page").classList.add("hidden");
      document.getElementById("global-header").classList.remove("hidden");
      document.getElementById("page-clock").classList.remove("hidden");
      document.getElementById("hud-right").style.display = "inline-flex";
      document.getElementById("menu-fab").style.display = "flex";
      document.getElementById("loading-screen").classList.remove("hidden");

      showUserInfo(email);
      updateMenuByRole(email);
      highlightMenu("clock");

      Promise.all([
        updateButtonLabel(),
        updateTodayStatusFromSheet(),
        loadLeaveHistory(email),
        (async ()=>{ loadCalendar(currentYear, currentMonth); await updateMonthShiftMarkers(); })()
      ]).then(()=>{
        document.getElementById("loading-screen").classList.add("hidden");
        refreshCoinUi();
        updateLeavePendingBanner(email);
      });

      var gbtn = document.getElementById("gachaBtn");
      if(gbtn) gbtn.onclick = openGacha;
    }

    function login() {
      var email = document.getElementById("login-email").value.trim();
      if(!email || !userData[email]) return alert("æŸ¥ç„¡æ­¤å¸³è™Ÿ");
      localStorage.setItem("qoopio_email", email);
      initLogin(email);
    }

    function showUserInfo(email) {
      var u = userData[email];
      document.getElementById("user-label").textContent = u.name;
      document.getElementById("leave-name").textContent = u.name;
    }

    function updateMenuByRole(email) {
      var u = userData[email];
      var mgrBtn = document.getElementById("btn-manager-fab");
      if (u && u.role === 'manager') {
        mgrBtn.classList.remove("hidden");
        checkManagerBadge();
      } else {
        mgrBtn.classList.add("hidden");
      }
    }

    async function checkManagerBadge() {
      try {
        var res = await fetch(scriptUrl + "?action=getAllPendingLeaves");
        var data = await res.json();
        if (data.items && data.items.length > 0) {
          document.getElementById('mgr-fab-circle').classList.add('notification-dot');
        } else {
          document.getElementById('mgr-fab-circle').classList.remove('notification-dot');
        }
      } catch(e) {}
    }

    function toggleMenu() {
      var sheet = document.getElementById("menu-sheet");
      var fab = document.querySelector(".fab-main");
      var overlay = document.getElementById("fab-overlay");
      if(sheet.classList.contains("hidden")){
        sheet.classList.remove("hidden");
        fab.classList.add("open");
        overlay.classList.remove("hidden");
      } else {
        sheet.classList.add("hidden");
        fab.classList.remove("open");
        overlay.classList.add("hidden");
      }
    }
    function navigateTo(page) {
      document.querySelectorAll(".page-section").forEach(el => el.classList.add("hidden"));
      document.getElementById("page-" + page).classList.remove("hidden");
      
      var hud = document.getElementById("hud-right");
      if(page === 'clock') hud.style.display = 'inline-flex'; else hud.style.display = 'none';

      document.querySelectorAll(".menu-item").forEach(btn => {
        btn.classList.toggle("active", btn.getAttribute("data-page") === page);
      });

      if (page === 'manager') loadManagerLeaves();
      toggleMenu();
    }
    function highlightMenu(page) {
      document.querySelectorAll(".menu-item").forEach(btn => {
        btn.classList.toggle("active", btn.getAttribute("data-page") === page);
      });
    }

    async function loadManagerLeaves() {
      var box = document.getElementById("manager-list");
      box.innerHTML = '<div class="empty-state"><div class="loading-spinner"></div> è®€å–ä¸­...</div>';
      try {
        var res = await fetch(scriptUrl + "?action=getAllPendingLeaves");
        var data = await res.json();
        var items = data.items || [];
        if (items.length > 0) document.getElementById('mgr-fab-circle').classList.add('notification-dot');
        else document.getElementById('mgr-fab-circle').classList.remove('notification-dot');

        if (items.length === 0) {
          box.innerHTML = '<div class="empty-state">ğŸ‰ ç›®å‰æ²’æœ‰å¾…å¯©æ ¸çš„å‡å–®</div>';
          return;
        }
        box.innerHTML = items.map(function(item) {
          return `
            <div class="leave-card" id="leave-card-${item.rowIndex}">
              <div class="row-1"><span class="title">${item.name} (${item.leaveType})</span><span class="status-bar status-å¯©æ ¸ä¸­">å¾…å¯©æ ¸</span></div>
              <div class="info">æ—¥æœŸï¼š${item.date}<br>ç”³è«‹ï¼š${item.appliedAt}</div>
              <div class="reason">ç†ç”±ï¼š${item.reason}</div>
              <div class="review-actions">
                <button class="btn-reject" onclick="reviewLeave(${item.rowIndex}, '${item.email}', '${item.date}', 'é€€å›')">é€€å›</button>
                <button class="btn-approve" onclick="reviewLeave(${item.rowIndex}, '${item.email}', '${item.date}', 'é€šé')">é€šé</button>
              </div>
            </div>`;
        }).join("");
      } catch(e) { box.innerHTML = '<div class="empty-state">âŒ è®€å–å¤±æ•—</div>'; }
    }

    async function reviewLeave(rowIndex, email, date, status) {
      if (!confirm(`ç¢ºå®šè¦ã€Œ${status}ã€é€™ç­†è«‹å‡å—ï¼Ÿ`)) return;
      var card = document.getElementById("leave-card-" + rowIndex);
      if(card) card.style.opacity = "0.5";
      try {
        var payload = { action: "reviewLeave", rowIndex: rowIndex, email: email, date: date, status: status };
        await fetch(scriptUrl, {
          method: "POST", mode: "no-cors",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify(payload)
        });
        if(card) {
          card.innerHTML = `<div style="text-align:center; padding:10px; color:${status==='é€šé'?'green':'red'}; font-weight:bold;">å·²${status}</div>`;
          setTimeout(() => card.remove(), 1000);
          setTimeout(checkManagerBadge, 1500);
        }
      } catch(e) { alert("æ“ä½œå¤±æ•—"); if(card) card.style.opacity = "1"; }
    }

    /* --- Gacha Enhanced Logic --- */
    function openGacha(){ document.getElementById("gacha-modal").classList.add("open"); refreshCoinUi(); switchGachaTab('play'); }
    function closeGacha(){ document.getElementById("gacha-modal").classList.remove("open"); resetGachaUI(); }
    function resetGachaUI(){
      document.getElementById("gacha-result-display").classList.remove("show");
      document.getElementById("gacha-result-display").innerHTML = "";
      document.getElementById("gacha-action-btn").disabled = false;
      document.getElementById("gacha-action-btn").classList.remove("shake-hard");
    }
    function switchGachaTab(tab){
      document.getElementById("tab-gacha-play").classList.toggle("active", tab==='play');
      document.getElementById("tab-gacha-log").classList.toggle("active", tab==='log');
      if(tab==='play'){
        document.getElementById("gacha-view-play").classList.remove("hidden");
        document.getElementById("gacha-view-log").classList.add("hidden");
      } else {
        document.getElementById("gacha-view-play").classList.add("hidden");
        document.getElementById("gacha-view-log").classList.remove("hidden");
        renderGachaLog();
      }
    }
    function renderGachaLog(){
      var email = localStorage.getItem("qoopio_email");
      var log = JSON.parse(localStorage.getItem("qoopio_gacha_" + email) || "[]").slice(-10).reverse();
      var box = document.getElementById("gacha-history-list");
      if(!log.length) { box.innerHTML = "<div style='text-align:center;color:#999;padding:10px;'>å°šç„¡ç´€éŒ„</div>"; return; }
      box.innerHTML = log.map(i => {
        var d = new Date(i.time);
        var ts = (d.getMonth()+1)+"/"+d.getDate()+" "+d.getHours()+":"+("0"+d.getMinutes()).slice(-2);
        return `<div class="gacha-log-item"><span>${ts}</span><span class="${i.result==='win'?'gacha-win':''}">${i.result==='win'?'ä¸­ç ğŸ‰':'æ²’ä¸­'}</span></div>`;
      }).join("");
    }
    
    function playGachaAnimation() {
      var email = localStorage.getItem("qoopio_email");
      var key = "qoopio_tokens_" + email;
      var ledger = JSON.parse(localStorage.getItem(key) || "{}");
      var days = Object.keys(ledger);
      if(days.length === 0) { alert("ä»£å¹£ä¸è¶³ï¼è«‹æ˜å¤©æ—©é»æ‰“å¡"); return; }

      // æ‰£ä»£å¹£
      delete ledger[days[0]];
      localStorage.setItem(key, JSON.stringify(ledger));
      refreshCoinUi();

      // UI ç‹€æ…‹
      var btn = document.getElementById("gacha-action-btn");
      var resBox = document.getElementById("gacha-result-display");
      btn.disabled = true;
      resBox.classList.remove("show");
      resBox.innerHTML = "";
      
      // å‹•ç•«é–‹å§‹
      btn.classList.add("shake-hard");
      
      // æ¨¡æ“¬é‹ç®—
      setTimeout(function(){
        btn.classList.remove("shake-hard");
        var win = Math.random() < 0.01; // 1%
        
        // å¯«ç´€éŒ„
        var logKey = "qoopio_gacha_" + email;
        var log = JSON.parse(localStorage.getItem(logKey) || "[]");
        log.push({ time: new Date().toISOString(), result: win ? 'win' : 'lose' });
        if(log.length > 20) log = log.slice(-20);
        localStorage.setItem(logKey, JSON.stringify(log));

        // é¡¯ç¤ºçµæœ
        if(win) {
          resBox.innerHTML = "<span style='color:#d35400; font-size:1.4rem;'>ğŸ‰ ä¸­çå•¦ï¼æˆªåœ–æ‰¾Rayé ˜ç</span>";
        } else {
          resBox.innerHTML = "<span style='color:#555;'>å“ˆå“ˆæ²’ä¸­å•¦( ÕÙ¼Õ)</span>";
        }
        resBox.classList.add("show");
        btn.disabled = false;
      }, 1500);
    }

    function getLocalDateStr(d){ d=d||new Date(); return d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate()); }
    function pad(n){ return ("0"+n).slice(-2); }
    async function updateButtonLabel() { /* Simplified */ var btn=document.getElementById("clockInBtn"); var email=localStorage.getItem("qoopio_email"); if(!btn||!email)return; var shift=""; try{var r=await fetch(scriptUrl+"?email="+email+"&date="+getLocalDateStr(),{cache:"no-store"}); var d=await r.json(); shift=d.shift||"";}catch(_){} if(shift.includes("ä¼‘")||shift.includes("å‡")){ btn.textContent="ä¼‘å‡ä¸­";btn.disabled=true;btn.style.backgroundColor="#bbb";return;} var mins=new Date().getHours()*60+new Date().getMinutes(); var state=localStorage.getItem("qoopio_state_"+email); if(mins>=120&&mins<1080){ if(state==="working"){btn.textContent="ä¸Šç­ä¸­";btn.disabled=true;btn.style.backgroundColor="#aaa";}else{btn.textContent="ä¸Šç­";btn.disabled=false;btn.style.backgroundColor="#111";btn.dataset.type="ä¸Šç­";} }else{ if(state==="offwork"){btn.textContent="ä¸‹ç­æ°æ°";btn.disabled=true;btn.style.backgroundColor="#aaa";}else{btn.textContent="ä¸‹ç­";btn.disabled=false;btn.style.backgroundColor="#111";btn.dataset.type="ä¸‹ç­";} } }
    function submitClockIn() { /* Simplified */ var btn=document.getElementById("clockInBtn"); var email=localStorage.getItem("qoopio_email"); btn.disabled=true; navigator.geolocation.getCurrentPosition(function(pos){ var type=btn.dataset.type; document.getElementById("status").textContent="âœ… æ‰“å¡æˆåŠŸ"; document.getElementById("status").style.color="green"; localStorage.setItem("qoopio_state_"+email, type==="ä¸Šç­"?"working":"offwork"); if(type==="ä¸Šç­") awardTokenIfEligible(type); fetch(scriptUrl,{method:"POST",mode:"no-cors",body:JSON.stringify({action:"clockIn",email:email,type:type,lat:pos.coords.latitude,lng:pos.coords.longitude})}).then(updateButtonLabel); },function(){alert("ç„¡æ³•å®šä½");btn.disabled=false;}); }
    function awardTokenIfEligible(type){ if(type!=="ä¸Šç­"||new Date().getHours()>=12)return; var k="qoopio_tokens_"+localStorage.getItem("qoopio_email"); var l=JSON.parse(localStorage.getItem(k)||"{}"); if(!l[getLocalDateStr()]){l[getLocalDateStr()]=true;localStorage.setItem(k,JSON.stringify(l));refreshCoinUi();} }
    function refreshCoinUi(){ var e=localStorage.getItem("qoopio_email"); if(!e)return; var c=Object.keys(JSON.parse(localStorage.getItem("qoopio_tokens_"+e)||"{}")).length; document.getElementById("gacha-badge").textContent=c; document.getElementById("modal-coin-count").textContent=c; }
    function openLeaveForm(){ document.getElementById("leave-modal").classList.add("open"); prepareLeaveDates(); }
    function closeLeaveForm(){ document.getElementById("leave-modal").classList.remove("open"); }
    function prepareLeaveDates(){ var s=document.getElementById("leave-date-select"); s.innerHTML=""; var d=new Date(); for(var i=0;i<60;i++){ var v=getLocalDateStr(d); var o=document.createElement("option"); o.value=v; o.textContent=v; s.appendChild(o); d.setDate(d.getDate()+1); } }
    async function submitLeave(){ var e=localStorage.getItem("qoopio_email"); var btn=document.querySelector(".leave-submit-btn"); btn.textContent="..."; await fetch(scriptUrl,{method:"POST",mode:"no-cors",body:JSON.stringify({action:"applyLeave",email:e,name:userData[e].name,date:document.getElementById("leave-date-select").value,leaveType:document.getElementById("leave-type-select").value,reason:document.getElementById("leave-reason").value})}); btn.textContent="é€å‡º"; closeLeaveForm(); alert("å·²é€å‡º"); loadLeaveHistory(e); }
    async function loadLeaveHistory(e){ try{var r=await fetch(scriptUrl+"?action=leaveHistory&email="+e);var d=await r.json(); document.getElementById("leave-history").innerHTML=d.items.map(i=>`<div class="leave-card"><div class="row-1"><span class="title">${i.leaveType}</span><span class="status-bar status-${i.status}">${i.status}</span></div><div class="info">${i.date}</div></div>`).join("");}catch(_){} }
    async function updateTodayStatusFromSheet(){ try{var e=localStorage.getItem("qoopio_email");var r=await fetch(scriptUrl+"?action=clockHistory&email="+e+"&date="+getLocalDateStr(),{cache:"no-store"});var d=await r.json();var s=document.getElementById("status");if(d.items.length){s.textContent="ä»Šæ—¥å·²æ‰“å¡";s.style.color="#0B6B3A";}else{s.textContent="ä»Šæ—¥æœªæ‰“å¡";s.style.color="#8B0000";}}catch(_){} }
    function resetEmail(){ localStorage.removeItem("qoopio_email"); location.reload(); }
    function loadCalendar(y,m){ var g=document.getElementById("calendar-grid"); g.innerHTML=""; document.getElementById("calendar-title").textContent=y+" å¹´ "+(m+1)+" æœˆ"; var d=new Date(y,m,1).getDay(); d=(d+6)%7; var dim=new Date(y,m+1,0).getDate(); ["ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","æ—¥"].forEach(n=>{var c=document.createElement("div");c.textContent=n;c.className="day-name";g.appendChild(c);}); for(var i=0;i<d;i++)g.appendChild(document.createElement("div")); for(var i=1;i<=dim;i++){let cell=document.createElement("div");cell.className="day-cell";cell.innerHTML=`<div>${i}</div><div class="day-indicator"></div>`; let ds=y+"-"+pad(m+1)+"-"+pad(i); cell.onclick=function(){document.querySelectorAll(".day-cell").forEach(x=>x.classList.remove("selected"));this.classList.add("selected");document.getElementById("selected-shift").innerHTML="...";loadAllShifts(ds);}; g.appendChild(cell);} }
    async function updateMonthShiftMarkers(){ try{var ym=currentYear+"-"+pad(currentMonth+1);var res=await fetch(scriptUrl+"?month="+ym+"&mode=summary&email="+localStorage.getItem("qoopio_email"));var d=await res.json(); document.querySelectorAll(".day-cell").forEach(c=>{ var dv=c.querySelector("div").textContent; if(!dv)return; var f=ym+"-"+pad(dv); if(d.zhongshanDays.includes(f))c.classList.add("shift-zhongshan"); if(d.jingmeiDays.includes(f))c.classList.add("shift-jingmei"); });}catch(_){} }
    function changeMonth(o){currentMonth+=o;if(currentMonth<0){currentMonth=11;currentYear--;}if(currentMonth>11){currentMonth=0;currentYear++;}loadCalendar(currentYear,currentMonth);updateMonthShiftMarkers();}
    async function loadAllShifts(ds){ try{var r=await fetch(scriptUrl+"?date="+ds+"&mode=all"); var d=await r.json(); document.getElementById("selected-shift").innerHTML=ds+"<br>å¾…ä¸²æ¥å®Œæ•´ç­è¡¨API";}catch(_){} }
    async function updateLeavePendingBanner(e){ if(!LEAVE_PENDING_USERS.includes(e))return; try{var r=await fetch(scriptUrl+"?action=leaveStatus&email="+e);var d=await r.json();if(d.hasPending)document.getElementById("leave-pending-banner").textContent="æœ‰è«‹å‡å¾…å¯©æ ¸";}catch(_){} }
  </script>
</body>
</html>
