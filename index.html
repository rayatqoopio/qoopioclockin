<!DOCTYPE html>
<html>
  <head>
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#111111" />

    <meta charset="UTF-8" />
    <title>Qoopio ÊâìÂç°Á≥ªÁµ±</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <script>
    if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js");
    }
    </script>
    <style>
      body {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        margin: 0;
        padding: 1.5rem;
        background-color: #f9f9f9;
        color: #333;
        text-align: center;
      }

      .container {
        max-width: 360px;
        margin: 5vh auto;
      }

      .logo {
        width: 100%;
        max-height: 360px;
        object-fit: contain;
        margin-bottom: 2rem;
      }

      label {
        display: block;
        margin: 1rem 0 0.5rem;
        font-size: 1.5rem;
        text-align: left;
      }

      input[type="email"] {
        font-size: 1.2rem;
        width: 98%;
        padding: 1.2rem;
        border: 1px solid #ccc;
        border-radius: 12px;
        box-sizing: border-box;
      }

      .type-buttons {
        display: flex;
        justify-content: space-between;
        margin: 2.5rem 0;
        gap: 1rem;
      }

      .type-button {
        flex: 1;
        padding: 2rem;
        font-size: 1.8rem;
        background-color: #e0e0e0;
        border: none;
        border-radius: 16px;
        cursor: pointer;
      }

      .type-button.selected {
        background-color: #222;
        color: #fff;
      }



      #status {
        margin-top: 2rem;
        font-size: 0.8rem;
        font-weight: bold;
      }



      .button-row {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
      }

      .submit-btn {
        flex: 5;
        padding: 1.5rem;
        font-size: 1.2rem;
        font-weight: bold;
        background-color: #111;
        color: #fff;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      .submit-btn:hover {
        background-color: #444;
      }

      .change-btn {
        flex: 1;
        padding: 1.5rem;
        font-size: 0.8rem;
        background-color: #e0e0e0;
        color: #222;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .change-btn:hover {
        background-color: #ccc;
      }

      .user-label {
        font-size: 0.7rem;
        font-weight: bold;
        margin-bottom: 1rem;
      }


    </style>
  </head>
  <body>
    <div class="container">

            <img
        class="logo"
        src="qoopio logo.png"
        alt="Qoopio Logo"
        onerror="this.style.display='none'"
      />

      <!-- üë§ È°ØÁ§∫‰ΩøÁî®ËÄÖÂêçÁ®±Ëàá email -->
      <div id="user-info" style="display: none;">
        <div id="user-label" class="user-label"></div>
      </div>

      <!-- üì© Email Ëº∏ÂÖ•ÂçÄ -->
      <div id="email-input-area">
        <label for="email">EmailÔºö</label>
        <input type="email" id="email" placeholder="Ëº∏ÂÖ•ÂÖ¨Âè∏ email" />
        <button onclick="handleLogin()">ÁôªÂÖ•</button> <!-- ‚≠ê ÂéüÊú¨ÁöÑ enter Ëº∏ÂÖ•Ê≥ïÊîπÁÇ∫ÊåâÈàïÈªûÊìä -->
      </div>

      
      <!-- üë§ ‰ΩøÁî®ËÄÖË≥áË®äÂçÄ -->
      <div id="user-info" style="display: none;">
        <div id="user-label" class="user-label"></div>
        <button onclick="resetEmail()">ÁôªÂá∫</button>
      </div>


      <!-- üïí ÊâìÂç°ËàáÊõ¥ÊèõÂ∏≥ËôüÊåâÈàï -->
      <div class="button-row">
        <button id="clockInBtn" class="submit-btn" onclick="submitClockIn()">ÊâìÂç°</button>
        <button onclick="resetEmail()" class="change-btn">ÁôªÂá∫</button>
      </div>

      <!-- ‚úÖ ÊâìÂç°ÁãÄÊÖãÈ°ØÁ§∫ -->
      <div id="status"></div>


    <script>

        if ("serviceWorker" in navigator) {
    navigator.serviceWorker
      .register("service-worker.js")
      .then(() => console.log("‚úÖ Service Worker registered"))
      .catch((error) => console.error("‚ùå SW registration failed:", error));
      }

      const scriptUrl = "https://script.google.com/macros/s/AKfycbz8r--Pcm04IfW3GE-CrcrMothFlEVqRj1sczKnz9LvSusBIFvH61VzajlMi51bexji/exec";

      let userData = {}; // ÂÑ≤Â≠òÂæû users.json ËºâÂÖ•ÁöÑË≥áÊñô
      
      // 1. ËºâÂÖ• user.json
      fetch("user.json")
        .then(res => res.json())
        .then(json => {
          userData = json;
          initLogin(); // Ê™¢Êü• localStorageÔºåÊúâÁöÑË©±Áõ¥Êé•ÁôªÂÖ•
        })
        .catch(err => {
          console.error("‚ùå ÁÑ°Ê≥ïËºâÂÖ•‰ΩøÁî®ËÄÖË≥áÊñô", err);
        });
      
      // 2. Â¶ÇÊûú localStorage Êúâ emailÔºåÁõ¥Êé•ÁôªÂÖ•
      function initLogin() {
        const savedEmail = localStorage.getItem("qoopio_email");
        if (savedEmail && userData[savedEmail]) {
          showUserInfo(savedEmail);
        } else {
          showEmailInput();
        }
      }
      
      // 3. ‰ΩøÁî®ËÄÖÊâãÂãïËº∏ÂÖ• email ÂæåÁôªÂÖ•
      function handleLogin() {
        const email = document.getElementById("email").value.trim();
        if (!userData[email]) {
          alert("Êü•ÁÑ°Ê≠§Â∏≥ËôüÔºåË´ãÈáçÊñ∞Á¢∫Ë™ç emailÔºÅ");
          return;
        }
      
        localStorage.setItem("qoopio_email", email);
        showUserInfo(email);
      }
      
      // 4. È°ØÁ§∫‰ΩøÁî®ËÄÖË≥áË®ä
      function showUserInfo(email) {
        const name = userData[email]?.name || email;
        document.getElementById("user-label").textContent = `${name}Ôºà${email}Ôºâ`;
        document.getElementById("user-info").style.display = "block";
        document.getElementById("email-input-area").style.display = "none";
      }
      
      // 5. ÁôªÂá∫ÔºàÈáçË®≠ emailÔºâ
      function resetEmail() {
        localStorage.removeItem("qoopio_email");
        location.reload();
      }


      function showEmailInput() {
        const userInfo = document.getElementById("user-info");
        const emailInputArea = document.getElementById("email-input-area");
        userInfo.style.display = "none";
        emailInputArea.style.display = "block";
      }

      function resetEmail() {
        localStorage.removeItem("qoopio_email");
        location.reload();
      }

      let lastSubmitTime = 0;

      function updateButtonLabel() {
        const now = new Date();
        const hour = now.getHours();
        const minute = now.getMinutes();
        const totalMinutes = hour * 60 + minute;

        const clockInBtn = document.getElementById("clockInBtn");
        if (totalMinutes >= 240 && totalMinutes <= 1140) {
          clockInBtn.textContent = "‰∏äÁè≠ÊâìÂç°";
          clockInBtn.dataset.type = "‰∏äÁè≠";
        } else {
          clockInBtn.textContent = "‰∏ãÁè≠ÊâìÂç°";
          clockInBtn.dataset.type = "‰∏ãÁè≠";
        }
      }

      function submitClockIn() {
        const name = userData[email]?.name || email;
        if (now - lastSubmitTime < 15000) {
          alert("Ë´ãÂãøÈáçË§áÊâìÂç°ÔºåË´ãÁ≠âÂæÖÂπæÁßíÂÜçË©¶ÔºÅ");
          return;
        }

        // ‚úÖ ÈÄôË£°ÂÖàÂèñÂæó email
        const email = localStorage.getItem("qoopio_email") || document.getElementById("email").value.trim();
        if (!email) {
          alert("Ë´ãËº∏ÂÖ• emailÔºÅ");
          return;
        }

        // ‚úÖ ÂÑ≤Â≠ò‰∏¶È°ØÁ§∫‰ΩøÁî®ËÄÖË≥áË®ä
        localStorage.setItem("qoopio_email", email);
        showUserInfo(email);

        // ‚úÖ ÂèñÂæóÂÆö‰ΩçË≥áÊñô‰∏¶ÈÄÅÂá∫
        if (!navigator.geolocation) {
          alert("ÊÇ®ÁöÑÁÄèË¶ΩÂô®‰∏çÊîØÊè¥ÂÆö‰ΩçÂäüËÉΩ");
          return;
        }

        navigator.geolocation.getCurrentPosition((position) => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          const type = document.getElementById("clockInBtn").dataset.type || "‰∏äÁè≠";

          const data = { email, type, lat, lng };

          const name = nameMap[email] || email;
          const timeStr = new Date().toLocaleTimeString();

          const statusEl = document.getElementById("status");
          statusEl.textContent = `‚úÖ ${name} ${type}Ôºà${timeStr}Ôºâ`;
          statusEl.style.color = "green";

          document.getElementById("clockInBtn").disabled = true;
          setTimeout(() => {
            document.getElementById("clockInBtn").disabled = false;
          }, 15000);

          lastSubmitTime = now;
          
          fetch("https://script.google.com/macros/s/AKfycbzqsXMv82AT1Mx1tJYYA4us4QXuWWj-BdfTXcLylACjQhac21KuUW1e_e8rJkYSYJY-/exec", {
            method: "POST",
            mode: "no-cors",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
          });
        }); // <-- ÈÄôÊòØ geolocation ÊàêÂäü callback ÁöÑÁµêÂ∞æ
      }     // ‚úÖ Ë£ú‰∏äÈÄôÂÄã function ÁöÑÁµêÂ∞æÊã¨Ëôü
    </script>



  </body>
</html>
