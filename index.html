<!DOCTYPE html>
<html lang="zh-TW" style="background-color: #fdf5e6;">
<head>
  <meta charset="UTF-8" />
  <title>Qoopio å“¡å·¥ç³»çµ± (v4.6)</title>
  <meta name="theme-color" content="#fdf5e6" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no" />
  <link rel="manifest" href="manifest.json?v=20251201" />
  <link rel="icon" href="icon.png" />
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js?v=20251201");
    }
  </script>
  <style>
    /* Base & Reset */
    @supports(height:100dvh){.container{min-height:calc(100dvh - env(safe-area-inset-bottom,0px))}}
    html,body{
      margin:0;padding:0;height:100%;
      background-color:#fdf5e6;
      font-family:"Helvetica Neue",Arial,sans-serif;
      color:#333;text-align:center;overflow-x:hidden;
    }
    .hidden{display:none!important;}

    /* page-section: é é¢åˆ‡æ›æ·¡å…¥å‹•ç•« */
    .page-section{
      width:100%;flex:1;
      opacity:0;
      transform:translateY(6px);
      transition:opacity 0.2s ease, transform 0.2s ease;
    }
    .page-section.visible{
      opacity:1;
      transform:translateY(0);
    }
    
    /* Header */
    #global-header{
      position:fixed;top:0;left:0;right:0;
      height:60px;background:#fdf5e6;
      display:flex;align-items:center;justify-content:center;
      z-index:10010;padding-top:env(safe-area-inset-top,0px);
    }
    .header-logo{height:56px;width:auto;display:block;}

    /* Container */
    .container{
      max-width:500px;margin:0 auto;
      padding:calc(60px + env(safe-area-inset-top,0px)) 1rem calc(3rem + env(safe-area-inset-bottom,0px));
      box-sizing:border-box;
      min-height:calc(100vh - env(safe-area-inset-bottom,0px));
      display:flex;flex-direction:column;
    }

    /* Login */
    #login-page{padding-top:10vh;}
    .logo-large{width:200px;margin-bottom:1.5rem;}
    #login-page input{
      width:80%;padding:0.8rem;margin:1rem 0;
      border-radius:8px;border:1px solid #ccc;
    }
    #login-page button{
      padding:0.8rem 1.5rem;background:#111;color:#fff;
      border:none;border-radius:8px;cursor:pointer;
    }

    /* Clock */
    #page-clock{
      display:flex;flex-direction:column;
      justify-content:center;
      padding-top:10vh;padding-bottom:15vh;
    }
    .user-label{font-size:1.1rem;font-weight:bold;margin-bottom:0.4rem;}
    .user-email{font-size:0.9rem;color:#666;margin-bottom:1rem;font-family:monospace;}
    #clockInBtn{
      width:80%;padding:1.7rem;font-size:1.3rem;
      background:#111;color:#fff;border:none;border-radius:10px;
      margin:0.8rem auto;transition:opacity 0.3s, background 0.2s;
    }
    #clockInBtn:disabled{background:#bbb;opacity:.6;}
    .logout-btn{background:none;border:none;color:#777;margin:0 auto;}
    #status{margin-top:1rem;font-weight:bold;}

    /* ===== Schedule â€“ æœˆæ›†æ¨£å¼ ===== */
    .calendar-header{
      padding-top:1rem;
      display:flex;justify-content:space-between;align-items:center;
      margin-bottom:0.6rem;
      font-size:1.2rem;font-weight:bold;
    }
    .calendar-header button{
      background:none;border:none;
      font-size:1.6rem;font-weight:bold;
      cursor:pointer;padding:0.2rem 0.6rem;
      border-radius:999px;
      transition:background 0.15s ease, transform 0.12s ease;
    }
    .calendar-header button:active{
      transform:scale(0.9);
      background:rgba(0,0,0,0.05);
    }

    .calendar-grid{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:4px;
      margin-bottom:0.8rem;
      font-size:0.8rem;
    }
    .day-name{
      font-size:0.75rem;
      color:#999;
      text-align:center;
      padding:0.15rem 0 0.25rem;
    }

    @keyframes dayIn{
      from{opacity:0;transform:translateY(10px) scale(0.95);}
      to{opacity:1;transform:translateY(0) scale(1);}
    }

    .day-cell{
      position:relative;
      padding:6px 0 10px;
      border-radius:12px;
      cursor:pointer;
      display:flex;flex-direction:column;
      align-items:center;justify-content:flex-start;
      transition:
        background 0.18s ease,
        color 0.18s ease,
        transform 0.18s ease,
        box-shadow 0.18s ease;
      font-size:0.9rem;
      opacity:0;
      transform:translateY(6px) scale(0.96);
      animation:dayIn 0.26s ease-out forwards;
    }
    .day-cell.today{
      box-shadow:0 0 0 1px #111 inset;
      font-weight:600;
    }
    .day-cell.selected{
      background:#111;
      color:#fff;
      box-shadow:0 4px 10px rgba(0,0,0,0.18);
      transform:translateY(-2px) scale(1.02);
    }
    .day-cell.selected .day-indicator{
      opacity:1;
      border-color:rgba(255,255,255,0.6);
    }
    .day-cell:active{
      transform:translateY(1px) scale(0.98);
    }

    .day-indicator{
      width:7px;height:7px;border-radius:50%;
      margin-top:4px;
      border:1px solid transparent;
      opacity:0;
      transition:opacity 0.18s, background 0.18s, border-color 0.18s;
    }
    .shift-zhongshan .day-indicator{
      background-color:#e74c3c;
      opacity:1;
    }
    .shift-jingmei .day-indicator{
      background-color:#27ae60;
      opacity:1;
    }

    /* é¸å–ç•¶æ—¥ç­è¡¨ â€“ åº•éƒ¨å¡ç‰‡ */
    #selected-shift{
      padding:1rem 1rem 0.8rem;
      background:#fff;
      border-radius:14px;
      box-shadow:0 4px 12px rgba(0,0,0,0.08);
      min-height:60px;
      text-align:left;
      line-height:1.7;
      font-size:0.9rem;
      transform:translateY(10px);
      opacity:0;
      transition:opacity 0.22s ease, transform 0.22s ease;
    }
    #selected-shift.show{
      opacity:1;
      transform:translateY(0);
    }
    .shift-date-title{
      font-weight:700;
      margin-bottom:10px;
      font-size:0.95rem;
    }
    .shift-section-title{
      font-weight:700;
      margin-top:10px;
      margin-bottom:6px;
      font-size:1rem;
    }
    .shift-line{margin-bottom:4px;}

    /* Admin/Manager */
    .manager-tabs{display:flex;gap:10px;margin-bottom:15px;justify-content:center;}
    .manager-tabs button{
      padding:8px 16px;border-radius:8px;
      border:1px solid #ccc;background:transparent;
      font-weight:bold;color:#777;font-size:1.1rem;cursor:pointer;
    }
    .manager-tabs button.active{background:#111;color:#fff;border-color:#111;}
    
    .dash-title{font-size:1.1rem;font-weight:bold;margin:20px 0 10px 0;border-left:4px solid #111;padding-left:10px;}
    .dashboard-card{background:#fff;padding:15px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:10px;text-align:left;}
    .dash-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee;font-size:0.95rem;}
    .dash-item:last-child{border-bottom:none;}
    .btn-approve{padding:4px 8px;border-radius:6px;border:none;background:#27ae60;color:#fff;font-weight:bold;cursor:pointer;}
    
    .admin-menu-btn{width:100%;padding:16px;background:#fff;border:1px solid #ddd;border-radius:12px;margin-bottom:10px;font-size:1rem;font-weight:bold;display:flex;justify-content:space-between;align-items:center;cursor:pointer;box-shadow:0 2px 5px rgba(0,0,0,0.05);}
    .admin-input{width:100%;padding:12px;margin-bottom:10px;border:1px solid #ddd;border-radius:8px;box-sizing:border-box;font-size:1rem;}
    .admin-action-btn{width:100%;padding:12px;background:#111;color:#fff;border:none;border-radius:8px;font-weight:bold;cursor:pointer;font-size:1rem;}

    /* Leave Page */
    .leave-btn-main{
      position:fixed;left:50%;transform:translateX(-50%);
      bottom:calc(100px + env(safe-area-inset-bottom,0px));
      z-index:9998;width:55%;min-width:180px;max-width:300px;
      padding:0.9rem;font-size:1rem;border-radius:999px;border:none;
      background:#111;color:#fff;cursor:pointer;
      box-shadow:0 4px 14px rgba(0,0,0,0.12);
    }
    #leave-history{margin-top:0.5rem;font-size:0.9rem;color:#555;}
    .leave-card{padding:0.8rem;border-radius:12px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:0.8rem;text-align:left;}
    .leave-card .row-1{display:flex;justify-content:space-between;align-items:center;margin-bottom:0.4rem;font-weight:bold;}
    .status-bar{padding:2px 8px;border-radius:4px;color:#fff;font-size:0.8rem;}
    .status-å¯©æ ¸ä¸­{background:#e67e22;} .status-é€šé{background:#27ae60;} .status-é€€å›{background:#c0392b;}

    /* FAB */
    #fab-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:10015;}
    .menu-fab{position:fixed;left:24px;bottom:calc(24px + env(safe-area-inset-bottom,0px));z-index:10020;display:none;flex-direction:column;align-items:flex-start;}
    .fab-main{width:60px;height:60px;border-radius:50%;background:#111;color:#fff;border:none;box-shadow:0 6px 16px rgba(0,0,0,0.35);font-size:1.6rem;position:relative;display:flex;align-items:center;justify-content:center;cursor:pointer;}
    .fab-icon-o,.fab-icon-x{position:absolute;font-family:sans-serif;font-weight:700;transition:all 0.3s;}
    .fab-icon-o{opacity:1;transform:scale(1);} .fab-icon-x{opacity:0;transform:rotate(-90deg)scale(0.5);}
    .fab-main.open .fab-icon-o{opacity:0;transform:scale(0.5);} .fab-main.open .fab-icon-x{opacity:1;transform:rotate(0deg)scale(1);}
    .menu-sheet{margin-bottom:10px;} .menu-sheet.hidden{display:none;}
    .fab-option{display:flex;align-items:center;margin-bottom:8px;}
    .menu-pill{padding:7px 16px;background:#fff;border:none;color:#333;font-size:0.95rem;font-weight:bold;border-radius:999px;box-shadow:0 4px 12px rgba(0,0,0,0.18);cursor:pointer;white-space:nowrap;}
    .menu-pill.active{background:#111;color:#fff;}
    .menu-pill.has-notif{position:relative;}
    .menu-pill.has-notif::after{content:'';position:absolute;top:0;right:0;width:10px;height:10px;background:#ff3b30;border-radius:50%;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,0.2);}

    /* HUD & Modals */
    .hud-right{position:fixed;right:16px;bottom:calc(16px + env(safe-area-inset-bottom,0px));display:none;z-index:10001;}
    .gacha-btn{background:transparent;border:0;} .gacha-img{width:96px;}
    .gacha-badge{position:absolute;right:-6px;top:-6px;min-width:22px;padding:0 6px;border-radius:999px;background:#111;color:#fff;font-size:12px;font-weight:800;border:1px solid #fff;}
    
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:10030;} .modal.open{display:flex;}
    .modal-card{width:min(520px,92%);background:#fff;border-radius:16px;padding:20px;text-align:left;position:relative;max-height:85vh;overflow-y:auto;}
    .modal-close-btn{position:absolute;top:15px;right:15px;background:none;border:none;font-size:1.5rem;cursor:pointer;line-height:1;}
    .modal-title{font-size:1.2rem;font-weight:bold;margin-bottom:15px;text-align:center;}

    /* Gacha UI */
    .modal-tabs{display:flex;gap:8px;margin-bottom:10px;}
    .modal-tabs button{flex:1;padding:8px;border-radius:10px;border:1px solid #222;background:#fff;cursor:pointer;font-weight:700;color:#111;}
    .modal-tabs button.active{background:#111;color:#fff;border-color:#111;}
    .gacha-body-content{text-align:center;padding:10px 0;}
    .gacha-btn-main{width:100%;padding:16px;font-size:1.2rem;font-weight:bold;color:#fff;background:#111;border:none;border-radius:12px;cursor:pointer;box-shadow:0 6px 0 #444;margin-bottom:10px;transform:translateY(0);transition:all 0.1s;}
    .gacha-btn-main:active{box-shadow:0 2px 0 #444;transform:translateY(4px);}
    .gacha-btn-main:disabled{background:#aaa;box-shadow:none;transform:translateY(4px);cursor:not-allowed;}
    .gacha-result{min-height:60px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;font-weight:bold;color:#111;margin-top:10px;opacity:0;transition:opacity 0.3s;} .gacha-result.show{opacity:1;}
    .shake-hard{animation:shake 0.5s infinite;} @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}

    /* Loading */
    #loading-screen{position:fixed;inset:0;background:#fdf5e6;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:20000;transition:opacity 0.3s;}
    #loading-screen.hidden{opacity:0;pointer-events:none;}
    .spinner{width:40px;height:40px;border:4px solid #ccc;border-top-color:#111;border-radius:50%;animation:spin 0.8s linear infinite;margin-bottom:10px;}
    @keyframes spin{to{transform:rotate(360deg);}}
  </style>
</head>
<body>
  <div id="loading-screen"><div class="spinner"></div><p>ç³»çµ±é€£ç·šä¸­...</p></div>
  <div id="fab-overlay" class="hidden" onclick="toggleMenu()"></div>
  <header id="global-header" class="hidden"><img src="qoopio logo.png" class="header-logo" /></header>

  <div class="container">
    <div id="login-page" class="hidden page-section">
      <img src="qoopio logo.png" class="logo-large" />
      <h3>è«‹è¼¸å…¥æ‚¨çš„ Email ç™»å…¥</h3>
      <input type="email" id="login-email" placeholder="name@qoopio.com" />
      <button onclick="login()">é€²å…¥ç³»çµ±</button>
    </div>

    <div id="page-clock" class="hidden page-section">
      <div id="user-label" class="user-label"></div>
      <div id="user-email" class="user-email"></div>
      <button id="clockInBtn" type="button" onclick="submitClockIn()">è®€å–ä¸­...</button>
      <button onclick="resetApp()" class="logout-btn">ç™»å‡º</button>
      <div id="status"></div>
    </div>

    <div id="page-leave" class="hidden page-section">
      <h3 style="display:none">è«‹å‡</h3>
      <button class="leave-btn-main" type="button" onclick="openModal('leave')">ç”³è«‹è«‹å‡</button>
      <h4>å€‹äººè«‹å‡ç´€éŒ„</h4>
      <div id="leave-history">è¼‰å…¥ä¸­...</div>
    </div>

    <div id="page-schedule" class="hidden page-section">
      <div class="calendar-header">
        <button onclick="changeMonth(-1)">ã€ˆ</button>
        <span id="calendar-title"></span>
        <button onclick="changeMonth(1)">ã€‰</button>
      </div>
      <div id="calendar-grid" class="calendar-grid"></div>
      <div id="selected-shift" class="show">ğŸ“… è«‹é¸æ“‡æ—¥æœŸæŸ¥çœ‹ç­åˆ¥</div>
    </div>

    <div id="page-manager" class="hidden page-section">
      <div class="manager-tabs">
        <button id="mgr-tab-pending" class="active" onclick="showMgrTab('pending')">å¾…å¯©æ ¸</button>
        <button id="mgr-tab-today" onclick="showMgrTab('today')">ä»Šæ—¥å‡ºå‹¤</button>
      </div>
      <div id="mgr-view-pending"><div class="dashboard-card" id="mgr-review-list">è¼‰å…¥ä¸­...</div></div>
      <div id="mgr-view-today" class="hidden"><div class="dashboard-card" id="mgr-dashboard-list">è¼‰å…¥ä¸­...</div></div>
    </div>

    <div id="page-admin" class="hidden page-section">
      <div class="dash-title">ç®¡ç†å“¡åŠŸèƒ½</div>
      <button class="admin-menu-btn" onclick="openModal('admin-token')">ğŸ ç™¼é€æ‰­è›‹ä»£å¹£ <span>â€º</span></button>
      <button class="admin-menu-btn" onclick="openModal('admin-announce')">ğŸ“¢ ç™¼å¸ƒå…¨åŸŸå…¬å‘Š <span>â€º</span></button>
      <button class="admin-menu-btn" onclick="openModal('admin-sync')">âš™ï¸ ç³»çµ±è³‡æ–™åŒæ­¥ <span>â€º</span></button>
    </div>
  </div>

  <div class="menu-fab" id="menu-fab">
    <div class="menu-sheet hidden" id="menu-sheet">
      <div class="fab-option"><button class="menu-pill" data-page="clock" onclick="nav('clock')">æ‰“å¡</button></div>
      <div class="fab-option"><button class="menu-pill" data-page="leave" onclick="nav('leave')">è«‹å‡</button></div>
      <div class="fab-option"><button class="menu-pill" data-page="schedule" onclick="nav('schedule')">ç­è¡¨</button></div>
      <div class="fab-option hidden" id="fab-mgr"><button class="menu-pill" data-page="manager" onclick="nav('manager')">è«‹å‡å¯©æ ¸</button></div>
      <div class="fab-option hidden" id="fab-adm"><button class="menu-pill" data-page="admin" onclick="nav('admin')">ç®¡ç†å“¡</button></div>
    </div>
    <button class="fab-main" onclick="toggleMenu()"><span class="fab-icon-o">O</span><span class="fab-icon-x">âœ•</span></button>
  </div>

  <div class="hud-right" id="hud-right">
    <button class="gacha-btn" onclick="openModal('gacha')"><img id="gacha-img" src="icon.png" class="gacha-img" /><span class="gacha-badge" id="hud-coin">0</span></button>
  </div>

  <div class="modal" id="modal-gacha">
    <div class="modal-card">
      <button class="modal-close-btn" onclick="closeModal('gacha')">âœ•</button>
      <div class="modal-title">æ‰­è›‹æ©Ÿ</div>
      <div class="modal-tabs">
        <button id="tab-gacha-play" class="active" onclick="switchGachaTab('play')">æ‰­è›‹</button>
        <button id="tab-gacha-log" onclick="switchGachaTab('log')">ç´€éŒ„</button>
      </div>
      <div class="gacha-body-content" id="gacha-view-play">
        <p>ä»£å¹£ï¼š<span id="modal-coin-count">0</span></p>
        <div style="height:10px"></div>
        <button id="gacha-action-btn" class="gacha-btn-main" onclick="playGacha()">START</button>
        <div id="gacha-result-display" class="gacha-result"></div>
        <div style="font-size:0.85rem; color:#888; margin-top:10px;">ç¥æ‚¨ä¸­ç (Â´â‰–â—à±ªâ—Ÿâ‰–)</div>
      </div>
      <div class="hidden" id="gacha-view-log">
        <div id="gacha-history-list" style="max-height:200px; overflow-y:auto;"></div>
      </div>
    </div>
  </div>

  <div class="modal" id="modal-leave">
    <div class="modal-card">
      <button class="modal-close-btn" onclick="closeModal('leave')">âœ•</button>
      <div class="modal-title">ç”³è«‹è«‹å‡</div>
      <label style="display:block;margin-top:10px">æ—¥æœŸ</label>
      <select id="leave-date" class="admin-input"></select>
      <label style="display:block;margin-top:10px">å‡åˆ¥</label>
      <select id="leave-type" class="admin-input">
        <option>äº‹å‡</option><option>ç—…å‡</option><option>ä¼‘å‡</option><option>ç‰¹ä¼‘å‡</option>
      </select>
      <label style="display:block;margin-top:10px">åŸå› </label>
      <input id="leave-reason" class="admin-input" placeholder="é¸å¡«..." />
      <button class="admin-action-btn" style="margin-top:15px" onclick="submitLeave()">é€å‡ºç”³è«‹</button>
    </div>
  </div>

  <div class="modal" id="modal-admin-token">
    <div class="modal-card">
      <button class="modal-close-btn" onclick="closeModal('admin-token')">âœ•</button>
      <div class="modal-title">ç™¼é€ä»£å¹£</div>
      <input id="adm-token-email" class="admin-input" placeholder="å“¡å·¥ Email" />
      <input id="adm-token-amt" class="admin-input" type="number" placeholder="æ•¸é‡" />
      <button class="admin-action-btn" onclick="adminGiveToken()">ç™¼é€</button>
    </div>
  </div>

  <div class="modal" id="modal-admin-announce">
    <div class="modal-card">
      <button class="modal-close-btn" onclick="closeModal('admin-announce')">âœ•</button>
      <div class="modal-title">ç™¼å¸ƒå…¬å‘Š</div>
      <input id="adm-ann-title" class="admin-input" placeholder="æ¨™é¡Œ" />
      <textarea id="adm-ann-content" class="admin-input" rows="4" placeholder="å…§å®¹..."></textarea>
      <button class="admin-action-btn" onclick="adminSetAnnounce()">ç™¼å¸ƒ</button>
    </div>
  </div>

  <div class="modal" id="modal-admin-sync">
    <div class="modal-card">
      <button class="modal-close-btn" onclick="closeModal('admin-sync')">âœ•</button>
      <div class="modal-title">ç³»çµ±åŒæ­¥</div>
      <button class="admin-menu-btn" onclick="adminSync('schedule')">ğŸ“¥ åŒæ­¥ A è¡¨æ’ç­ (è‡³æœ¬æœˆBè¡¨)</button>
      <button class="admin-menu-btn" onclick="adminSync('clock')">ğŸ•’ è£œå¡«æ‰“å¡æ™‚é–“ (è‡³æœ¬æœˆBè¡¨)</button>
    </div>
  </div>

  <div class="modal" id="modal-show-announce">
    <div class="modal-card" style="text-align:center">
      <div id="ann-display-title" style="font-size:1.2rem;font-weight:bold;margin-bottom:10px"></div>
      <div id="ann-display-content" style="color:#555;margin-bottom:20px;line-height:1.5"></div>
      <button class="admin-action-btn" onclick="closeModal('show-announce')">æˆ‘çŸ¥é“äº†</button>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzdG-XnSqTjbrRft_K4Wc3alPIso5RinyXjpqM82Ne6HAg4TW-b3IxUBc6n9kuSbT_y-Q/exec";
    
    let currentUser = null;
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth();
    const GACHA_ICON = "gacha-icon.png?v=4.5";

    window.onload = async () => {
      const img = new Image();
      img.src = GACHA_ICON;
      img.onload = () => { document.getElementById("gacha-img").src = GACHA_ICON; };

      const email = localStorage.getItem("q_email");
      if (email) {
        await appInit(email);
      } else {
        const loading = document.getElementById("loading-screen");
        const loginPage = document.getElementById("login-page");
        loading.classList.add("hidden");
        loginPage.classList.remove("hidden");
        loginPage.classList.add("visible");
      }
    };

    async function appInit(email) {
      document.getElementById("login-page").classList.add("hidden");
      document.getElementById("login-page").classList.remove("visible");
      document.getElementById("loading-screen").classList.remove("hidden");
      try {
        const res = await fetch(`${API_URL}?action=initApp&email=${email}`);
        const data = await res.json();
        if (!data.ok) { alert(data.msg); resetApp(); return; }
        currentUser = data.user;
        currentUser.email = email;
        setupUI(data);
        if (data.announcement) {
          const lastRead = localStorage.getItem("q_ann_id");
          if (lastRead != data.announcement.id) {
            document.getElementById("ann-display-title").textContent = data.announcement.title;
            document.getElementById("ann-display-content").textContent = data.announcement.content;
            openModal('show-announce');
            localStorage.setItem("q_ann_id", data.announcement.id);
          }
        }
        loadCalendar(currentYear, currentMonth);
        updateMonthShiftMarkers();
        document.getElementById("loading-screen").classList.add("hidden");
        document.getElementById("global-header").classList.remove("hidden");
        const clockPage = document.getElementById("page-clock");
        clockPage.classList.remove("hidden");
        clockPage.classList.add("visible");
        document.getElementById("menu-fab").style.display = "flex";
        document.getElementById("hud-right").style.display = "inline-flex";
        // é è¨­ FAB é«˜äº®æ‰“å¡
        const clockPill = document.querySelector('.menu-pill[data-page="clock"]');
        if (clockPill) clockPill.classList.add("active");
      } catch (e) {
        alert("é€£ç·šå¤±æ•—ï¼Œè«‹é‡è©¦");
        document.getElementById("loading-screen").classList.add("hidden");
        const loginPage = document.getElementById("login-page");
        loginPage.classList.remove("hidden");
        loginPage.classList.add("visible");
      }
    }

    function setupUI(data) {
      document.getElementById("user-label").textContent = currentUser.name;
      document.getElementById("user-email").textContent = currentUser.email; 
      document.getElementById("hud-coin").textContent = data.tokens;
      document.getElementById("modal-coin-count").textContent = data.tokens;
      const btn = document.getElementById("clockInBtn");
      const status = document.getElementById("status");
      if (data.clockStatus.includes("å·²")) {
        status.textContent = data.clockStatus;
        status.style.color = "green";
        const isOff = data.clockStatus.includes("ä¸‹ç­");
        btn.textContent = isOff ? "å·²ä¸‹ç­" : "ä¸‹ç­";
        btn.style.background = "#333";
        btn.dataset.type = isOff ? "done" : "ä¸‹ç­";
        if(isOff) btn.disabled = true;
      } else {
        btn.textContent = "ä¸Šç­";
        btn.dataset.type = "ä¸Šç­";
      }
      if (currentUser.role === 'manager' || currentUser.role === 'admin') document.getElementById("fab-mgr").classList.remove("hidden");
      if (currentUser.role === 'admin') document.getElementById("fab-adm").classList.remove("hidden");
      if(currentUser.role === 'manager' || currentUser.role === 'admin') checkManagerBadge();
    }

    function login() {
      const email = document.getElementById("login-email").value.trim();
      if (!email) return;
      localStorage.setItem("q_email", email);
      appInit(email);
    }

    function resetApp() {
      // æ¸…æ‰ç™»å…¥è³‡è¨Š & å›åˆ°ç™»å…¥é 
      localStorage.removeItem("q_email");
      currentUser = null;
      document.getElementById("global-header").classList.add("hidden");
      document.getElementById("menu-fab").style.display = "none";
      document.getElementById("hud-right").style.display = "none";
      document.querySelectorAll(".page-section").forEach(p=>{
        p.classList.add("hidden");
        p.classList.remove("visible");
      });
      const loginPage = document.getElementById("login-page");
      loginPage.classList.remove("hidden");
      loginPage.classList.add("visible");
    }

    // Navigation
    function toggleMenu() {
      const sheet = document.getElementById("menu-sheet");
      const overlay = document.getElementById("fab-overlay");
      const fab = document.querySelector(".fab-main");
      sheet.classList.toggle("hidden");
      overlay.classList.toggle("hidden");
      fab.classList.toggle("open");
    }

    function nav(page) {
      const target = document.getElementById("page-" + page);

      document.querySelectorAll(".page-section").forEach(p => {
        p.classList.add("hidden");
        p.classList.remove("visible");
      });

      target.classList.remove("hidden");
      requestAnimationFrame(() => {
        target.classList.add("visible");
      });

      toggleMenu();
      document.querySelectorAll(".menu-pill").forEach(btn => btn.classList.remove("active"));
      const pill = document.querySelector(`.menu-pill[data-page="${page}"]`);
      if (pill) pill.classList.add("active");

      if (page === 'manager') loadManagerData();
      if (page === 'leave') loadLeaveHistory(currentUser.email);
      if (page === 'schedule') {
        // åˆ‡å›ç­è¡¨æ™‚é‡æ–°ç•« marker
        updateMonthShiftMarkers();
      }
    }

    function openModal(id) {
      document.getElementById("modal-" + id).classList.add("open");
      if(id==='leave') prepareLeaveDates();
    }
    function closeModal(id) {
      document.getElementById("modal-" + id).classList.remove("open");
      if(id==='gacha') resetGachaUI();
    }

    /* ====== Schedule ====== */
    function loadCalendar(y,m){
      const grid=document.getElementById("calendar-grid");
      grid.innerHTML="";
      document.getElementById("calendar-title").textContent = y + " å¹´ " + (m+1) + " æœˆ";

      const firstWeekday = (new Date(y,m,1).getDay()+6)%7; // é€±ä¸€ç•¶ç¬¬ä¸€å¤©
      const daysInMonth = new Date(y,m+1,0).getDate();

      ["ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","æ—¥"].forEach(n=>{
        const c=document.createElement("div");
        c.className="day-name";
        c.textContent=n;
        grid.appendChild(c);
      });

      for(let i=0;i<firstWeekday;i++){
        grid.appendChild(document.createElement("div"));
      }

      const today = new Date();
      const isSameMonth = (today.getFullYear()===y && today.getMonth()===m);

      for(let d=1; d<=daysInMonth; d++){
        const cell = document.createElement("div");
        cell.className = "day-cell";
        cell.innerHTML = `<div>${d}</div><div class="day-indicator"></div>`;

        if(isSameMonth && d === today.getDate()){
          cell.classList.add("today");
        }

        const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        cell.onclick = () => {
          document.querySelectorAll(".day-cell").forEach(x=>x.classList.remove("selected"));
          cell.classList.add("selected");
          const box = document.getElementById("selected-shift");
          box.classList.remove("show");
          box.innerHTML = `<div class="shift-date-title">${ds}</div><div style="color:#999">è¼‰å…¥ä¸­...</div>`;
          loadAllShifts(ds);
        };

        const indexForAnim = d;
        cell.style.animationDelay = (indexForAnim * 0.01) + "s";

        grid.appendChild(cell);
      }
    }

    async function updateMonthShiftMarkers(){
      if(!currentUser) return;
      try{
        const ym=`${currentYear}-${String(currentMonth+1).padStart(2,'0')}`;
        const res=await fetch(`${API_URL}?month=${ym}&mode=summary&email=${currentUser.email}`);
        const d=await res.json();
        document.querySelectorAll(".day-cell").forEach(c=>{
          const firstDiv = c.querySelector("div");
          if(!firstDiv) return;
          const dv = firstDiv.textContent;
          if(!dv || isNaN(dv)) return;
          const f=`${ym}-${String(dv).padStart(2,'0')}`;
          c.classList.remove("shift-zhongshan","shift-jingmei");
          if(d.zhongshanDays && d.zhongshanDays.includes(f)) c.classList.add("shift-zhongshan");
          if(d.jingmeiDays && d.jingmeiDays.includes(f)) c.classList.add("shift-jingmei");
        });
      }catch(e){}
    }

    function changeMonth(o){
      currentMonth+=o;
      if(currentMonth<0){currentMonth=11;currentYear--;}
      if(currentMonth>11){currentMonth=0;currentYear++;}
      loadCalendar(currentYear,currentMonth);
      updateMonthShiftMarkers();
    }
    
    // ç­è¡¨è©³ç´° â€“ ç‰ˆé¢é è¿‘ä½ æˆªåœ–çš„æ¨£å­
    async function loadAllShifts(ds) {
      const box = document.getElementById("selected-shift");
      box.classList.remove("show");
      box.innerHTML = `<div class="shift-date-title">${ds}</div><div style="color:#999">è¼‰å…¥ä¸­...</div>`;

      try {
        const res = await fetch(`${API_URL}?date=${ds}&mode=all`);
        const d = await res.json();

        if (!d.ok || !d.shifts) {
          box.innerHTML = `<div class="shift-date-title">${ds}</div>å°šç„¡ç­è¡¨è³‡æ–™`;
          box.classList.add("show");
          return;
        }

        let html = `<div class="shift-date-title">${ds}</div>`;

        const buildSection = (title, arr) => {
          if (!arr || !arr.length) return "";
          // arr å…§å®¹æ˜¯ "å§“å (ä¸­å±±æ”å½±â€¦)" é€™ç¨®å­—ä¸²
          // ç›¡é‡æ‹†å‡ºè§’è‰²åç¨±ä¾†æ’
          const roleOrder = ["æ«ƒæª¯","å½©å¦","æ”å½±","ä¿®åœ–"];
          const groups = {};
          arr.forEach(str=>{
            const m = String(str).match(/^(.+?)\s*\((.+?)\)$/);
            let name = str;
            let shift = "";
            if (m) {
              name = m[1].trim();
              shift = m[2].trim();
            }
            let role = "";
            const roleMatch = shift.match(/(æ«ƒæª¯|å½©å¦|æ”å½±|ä¿®åœ–)/);
            role = roleMatch ? roleMatch[1] : "";
            const key = role || "å…¶ä»–";
            if (!groups[key]) groups[key] = [];
            groups[key].push(name);
          });

          const sortedKeys = Object.keys(groups).sort((a,b)=>{
            const ia = roleOrder.indexOf(a);
            const ib = roleOrder.indexOf(b);
            return (ia === -1 ? 99 : ia) - (ib === -1 ? 99 : ib);
          });

          let sec = `<div class="shift-section-title">[${title}]</div>`;
          sortedKeys.forEach(k=>{
            sec += `<div class="shift-line">${title}${k}ï¼š${groups[k].join("ã€")}</div>`;
          });
          return sec;
        };

        if (d.shifts.zhongshan && d.shifts.zhongshan.length > 0) {
          html += buildSection("ä¸­å±±", d.shifts.zhongshan);
        }
        if (d.shifts.jingmei && d.shifts.jingmei.length > 0) {
          html += buildSection("æ™¯ç¾", d.shifts.jingmei);
        }
        if (d.shifts.other && d.shifts.other.length > 0) {
          html += buildSection("å…¶ä»–", d.shifts.other);
        }

        if (
          (!d.shifts.zhongshan || d.shifts.zhongshan.length === 0) &&
          (!d.shifts.jingmei || d.shifts.jingmei.length === 0) &&
          (!d.shifts.other || d.shifts.other.length === 0)
        ) {
          html += `<div class="shift-line">æœ¬æ—¥ç„¡äººæ’ç­</div>`;
        }

        box.innerHTML = html;
        requestAnimationFrame(() => box.classList.add("show"));
      } catch (e) {
        box.innerHTML = `<div class="shift-date-title">${ds}</div>è®€å–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦`;
        box.classList.add("show");
      }
    }

    // Clock
    function submitClockIn() {
      const btn = document.getElementById("clockInBtn");
      if (btn.disabled) return;
      if (!confirm(`ç¢ºå®šè¦æ‰“ã€Œ${btn.dataset.type}ã€å¡å—ï¼Ÿ`)) return;
      btn.disabled = true; btn.textContent = "å®šä½ä¸­...";
      navigator.geolocation.getCurrentPosition(async (pos) => {
        btn.textContent = "æ‰“å¡ä¸­...";
        await fetch(API_URL, {
          method: "POST", mode: "no-cors",
          body: JSON.stringify({action:"clockIn",email:currentUser.email,type:btn.dataset.type,lat:pos.coords.latitude,lng:pos.coords.longitude})
        });
        alert("æ‰“å¡æˆåŠŸ");
        if(btn.dataset.type==="ä¸Šç­"){ btn.textContent="ä¸‹ç­"; btn.dataset.type="ä¸‹ç­"; btn.disabled=false; }
        else{ btn.textContent="å·²ä¸‹ç­"; btn.disabled=true; }
      },()=>{ alert("å®šä½å¤±æ•—"); btn.disabled=false; });
    }

    // Manager
    function showMgrTab(t){
      document.getElementById("mgr-tab-pending").classList.toggle("active",t==='pending');
      document.getElementById("mgr-tab-today").classList.toggle("active",t==='today');
      document.getElementById("mgr-view-pending").classList.toggle("hidden",t!=='pending');
      document.getElementById("mgr-view-today").classList.toggle("hidden",t!=='today');
    }
    async function loadManagerData(){
      const rList=document.getElementById("mgr-review-list");
      const dList=document.getElementById("mgr-dashboard-list");
      rList.innerHTML="è¼‰å…¥ä¸­..."; dList.innerHTML="è¼‰å…¥ä¸­...";
      
      const rRes=await fetch(`${API_URL}?action=getAllPendingLeaves`);
      const rData=await rRes.json();
      if(rData.items && rData.items.length>0){
        document.querySelector('button[data-page="manager"]').classList.add("has-notif");
        rList.innerHTML=rData.items.map(i=>`<div class="dash-item"><span>${i.name} - ${i.leaveType} (${i.date})</span><button class="btn-approve" onclick="review(${i.rowIndex},'${i.email}','${i.date}','é€šé')">âœ…</button></div>`).join("");
      } else {
        rList.innerHTML="ç„¡å¾…å¯©æ ¸é …ç›®";
        document.querySelector('button[data-page="manager"]').classList.remove("has-notif");
      }
      
      const dRes=await fetch(`${API_URL}?action=getManagerDashboard`);
      const dData=await dRes.json();
      if(dData.items) {
        dList.innerHTML=dData.items.map(i=>`<div class="dash-item"><span>${i.name} <small style="color:#888">(${i.dept})</small></span><span class="dash-time">${i.in}/${i.out}</span></div>`).join("")||"ä»Šæ—¥ç„¡äººä¸Šç­";
      } else {
        dList.innerHTML="è®€å–éŒ¯èª¤";
      }
    }
    async function checkManagerBadge(){
      try{
        const r=await fetch(`${API_URL}?action=getAllPendingLeaves`);
        const d=await r.json();
        if(d.items.length)document.querySelector('button[data-page="manager"]').classList.add("has-notif");
      }catch(e){}
    }
    async function review(idx,em,dt,st){
      if(!confirm("ç¢ºå®šé€šé?"))return;
      await fetch(API_URL,{method:"POST",mode:"no-cors",body:JSON.stringify({action:"reviewLeave",rowIndex:idx,email:em,date:dt,status:st})});
      alert("å·²å¯©æ ¸"); loadManagerData();
    }

    // Admin
    async function adminGiveToken(){
      const e=document.getElementById("adm-token-email").value;
      const a=document.getElementById("adm-token-amt").value;
      if(!e||!a)return;
      await fetch(API_URL,{method:"POST",mode:"no-cors",body:JSON.stringify({action:"adminGiveToken",targetEmail:e,amount:a})});
      alert("å·²ç™¼é€"); closeModal("admin-token");
    }
    async function adminSetAnnounce(){
      const t=document.getElementById("adm-ann-title").value;
      const c=document.getElementById("adm-ann-content").value;
      await fetch(API_URL,{method:"POST",mode:"no-cors",body:JSON.stringify({action:"adminSetAnnounce",title:t,content:c})});
      alert("å·²ç™¼å¸ƒ"); closeModal("admin-announce");
    }
    async function adminSync(t){
      if(!confirm("ç¢ºå®šåŸ·è¡Œ?"))return;
      await fetch(API_URL,{method:"POST",mode:"no-cors",body:JSON.stringify({action:"adminSync",type:t})});
      alert("æŒ‡ä»¤å·²ç™¼é€"); closeModal("admin-sync");
    }

    // Gacha
    function playGacha(){
      const btn=document.getElementById("gacha-action-btn");
      const res=document.getElementById("gacha-result-display");
      btn.disabled=true; btn.classList.add("shake-hard"); res.innerHTML="";
      setTimeout(async()=>{
        btn.classList.remove("shake-hard");
        try{
          const r=await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"drawGacha",email:currentUser.email})});
          const d=await r.json();
          if(!d.ok){alert(d.msg);btn.disabled=false;return;}
          document.getElementById("modal-coin-count").textContent=d.balance;
          document.getElementById("hud-coin").textContent=d.balance;
          res.innerHTML=d.win?"<span style='color:red;font-size:1.5rem'>ğŸ‰ ä¸­çï¼</span>":"æ²’ä¸­ ğŸ˜‚";
          res.classList.add("show"); btn.disabled=false;
        }catch(e){alert("é€£ç·šéŒ¯èª¤");btn.disabled=false;}
      },1500);
    }
    function resetGachaUI(){
      document.getElementById("gacha-result-display").classList.remove("show");
      document.getElementById("gacha-result-display").innerHTML="";
      document.getElementById("gacha-action-btn").disabled=false;
    }
    function switchGachaTab(tab){
      document.getElementById("tab-gacha-play").classList.toggle("active", tab==='play');
      document.getElementById("tab-gacha-log").classList.toggle("active", tab==='log');
      if(tab==='play'){
        document.getElementById("gacha-view-play").classList.remove("hidden");
        document.getElementById("gacha-view-log").classList.add("hidden");
      } else {
        document.getElementById("gacha-view-play").classList.add("hidden");
        document.getElementById("gacha-view-log").classList.remove("hidden");
        renderGachaLog();
      }
    }
    function renderGachaLog(){
      document.getElementById("gacha-history-list").innerHTML =
        "<div style='text-align:center;padding:10px;color:#999'>é–‹ç™¼ä¸­...</div>";
    }

    // Leave Helpers
    function prepareLeaveDates(){
      const s=document.getElementById("leave-date"); s.innerHTML="";
      for(let i=0;i<30;i++){
        let d=new Date(); d.setDate(d.getDate()+i);
        let v=d.toISOString().split('T')[0];
        let o=document.createElement("option"); o.text=v; o.value=v; s.add(o);
      }
    }
    async function submitLeave(){
      await fetch(API_URL,{method:"POST",mode:"no-cors",body:JSON.stringify({
        action:"applyLeave",email:currentUser.email,
        date:document.getElementById("leave-date").value,
        leaveType:document.getElementById("leave-type").value,
        reason:document.getElementById("leave-reason").value
      })});
      alert("å·²é€å‡º"); closeModal("leave"); loadLeaveHistory(currentUser.email);
    }
    async function loadLeaveHistory(e){
      try{
        const r=await fetch(`${API_URL}?action=leaveHistory&email=${e}`);
        const d=await r.json();
        document.getElementById("leave-history").innerHTML=
          d.items.map(i=>`<div class="leave-card">
            <div class="row-1">
              <span class="title">${i.leaveType}</span>
              <span class="status-bar status-${i.status}">${i.status}</span>
            </div>
            <div class="info">${i.date}</div>
          </div>`).join("");
      }catch(err){
        document.getElementById("leave-history").textContent="è®€å–å¤±æ•—";
      }
    }
  </script>
</body>
</html>
