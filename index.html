<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>Qoopio æ‰“å¡ç³»çµ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#111111" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon.png" />
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker
        .register("service-worker.js")
        .then(() => console.log("âœ… Service Worker registered"))
        .catch((error) => console.error("âŒ SW registration failed:", error));
    }
  </script>
  <style>
    body {
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 2rem;
      background-color: #fdf5e6;
      color: #333;
      text-align: center;
    }
    .container {
      max-width: 500px;
      margin: 5vh auto;
      padding-bottom: 6rem;
    }
    .logo {
      width: 200px;
      margin-bottom: 1.5rem;
    }
    .user-label {
      font-size: 1rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    .button-row {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }
    .submit-btn {
      flex: 5;
      padding: 1.4rem;
      font-size: 1.3rem;
      background-color: #111;
      color: #fff;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    .change-btn {
      flex: 2;
      padding: 1.4rem;
      font-size: 1rem;
      background-color: #ddd;
      color: #222;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    #status {
      margin-top: 1rem;
      font-size: 1.1rem;
      font-weight: bold;
    }
    #shift-info {
      margin-top: 1.5rem;
      font-size: 1rem;
      color: #444;
    }
    .hidden { display: none; }

    /* âœ… å°è¦½åˆ— */
    .tab-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 70px;
      background-color: #000;
      display: flex;
      justify-content: space-around;
      align-items: center;
      border-top: 2px solid #222;
      z-index: 999;
    }
    .tab-button {
      flex: 1;
      color: white;
      font-size: 1.2rem;
      font-weight: bold;
      background: none;
      border: none;
      cursor: pointer;
      height: 100%;
    }
    .tab-button.active { background-color: #222; }

    /* âœ… æœˆæ›† */
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      font-size: 1.2rem;
      font-weight: bold;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-bottom: 1rem;
    }
    .day-cell {
      position: relative;
      padding: 10px;
      border-radius: 8px;
      background: #fff;
      border: 1px solid #ddd;
      cursor: pointer;
      transition: all 0.2s;
    }
    .day-cell:hover { background-color: #eee; }
    .day-cell.today {
      border: 2px solid #111;
      font-weight: bold;
      background: #fafafa;
    }
    .day-name {
      font-weight: bold;
      color: #666;
      background: none;
      border: none;
    }

    /* ğŸ”´ğŸŸ¢ ç­åˆ¥æ¨™ç¤ºé» */
    .shift-zhongshan::after {
      content: "â€¢";
      position: absolute;
      bottom: 6px;
      right: 8px;
      font-size: 1.2rem;
      color: #e74c3c;
    }
    .shift-jingmei::before {
      content: "â€¢";
      position: absolute;
      bottom: 6px;
      left: 8px;
      font-size: 1.2rem;
      color: #27ae60;
    }

    #selected-shift {
      font-size: 1rem;
      line-height: 1.8;
      color: #444;
      text-align: left;
      padding: 1rem;
      border-radius: 10px;
      background: #fff;
      box-shadow: 0 0 6px rgba(0,0,0,0.1);
    }
    .group-title {
      font-weight: bold;
      color: #000;
      margin-top: 1rem;
      margin-bottom: 0.5rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- æ‰“å¡é  -->
    <div id="page-clock">
      <img src="qoopio logo.png" class="logo" alt="Qoopio Logo" />
      <div id="user-label" class="user-label"></div>
      <div class="button-row">
        <button id="clockInBtn" class="submit-btn" onclick="submitClockIn()">æ‰“å¡</button>
        <button onclick="resetEmail()" class="change-btn">ç™»å‡º</button>
      </div>
      <div id="shift-info">è®€å–ç­åˆ¥ä¸­â€¦</div>
      <div id="status"></div>
    </div>

    <!-- ç­è¡¨é  -->
    <div id="page-schedule" class="hidden">
      <div class="calendar-view">
        <div class="calendar-header">
          <button onclick="changeMonth(-1)">ã€ˆ</button>
          <span id="calendar-title"></span>
          <button onclick="changeMonth(1)">ã€‰</button>
        </div>
        <div id="calendar-grid" class="calendar-grid"></div>
        <div id="selected-shift">ğŸ“… è«‹é¸æ“‡æ—¥æœŸ</div>
      </div>
    </div>
  </div>

  <!-- å°è¦½åˆ— -->
  <div class="tab-bar">
    <button class="tab-button active" onclick="switchPage('clock')">æ‰“å¡</button>
    <button class="tab-button" onclick="switchPage('schedule')">ç­è¡¨</button>
  </div>

  <script>
    const scriptUrl = "https://script.google.com/macros/s/AKfycbzfCWSZCydOFXJMaOqHOA25HHW36RlONmD-DTgruSsx6xrO4RegK7CGlkwNwpG6QKlj/exec";
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth();
    let userData = {};

    fetch("user.json")
      .then(res => res.json())
      .then(json => {
        userData = json;
        initLogin();
      })
      .catch(() => alert("ä½¿ç”¨è€…è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹åˆ·æ–°é é¢"));

    function initLogin() {
      const savedEmail = localStorage.getItem("qoopio_email");
      if (savedEmail && userData[savedEmail]) showUserInfo(savedEmail);
      updateButtonLabel();
      setInterval(updateButtonLabel, 60000);
      loadCalendar(currentYear, currentMonth);
      loadAllShifts(); // é è¨­ä»Šæ—¥å…¨å“¡ç­è¡¨
    }

    function showUserInfo(email) {
      const name = userData[email]?.name || email;
      document.getElementById("user-label").textContent = `${name} ${email}`;
    }

    function switchPage(page) {
      document.getElementById("page-clock").classList.add("hidden");
      document.getElementById("page-schedule").classList.add("hidden");
      document.getElementById(`page-${page}`).classList.remove("hidden");
      document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("active"));
      document.querySelector(`.tab-button[onclick="switchPage('${page}')"]`).classList.add("active");
      if (page === "schedule") updateMonthShiftMarkers();
    }

    function updateButtonLabel() {
      const now = new Date();
      const totalMinutes = now.getHours() * 60 + now.getMinutes();
      const btn = document.getElementById("clockInBtn");
      if (totalMinutes >= 240 && totalMinutes <= 1140) {
        btn.textContent = "ä¸Šç­æ‰“å¡"; btn.dataset.type = "ä¸Šç­";
      } else {
        btn.textContent = "ä¸‹ç­æ‰“å¡"; btn.dataset.type = "ä¸‹ç­";
      }
    }

    /* === æœˆæ›† === */
    function loadCalendar(year, month) {
      const title = document.getElementById("calendar-title");
      const grid = document.getElementById("calendar-grid");
      grid.innerHTML = "";
      title.textContent = `${year} å¹´ ${month + 1} æœˆ`;

      const dayNames = ["ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","æ—¥"];
      const firstDay = (new Date(year, month, 1).getDay() + 6) % 7; // æ˜ŸæœŸä¸€ç‚ºé¦–
      
      dayNames.forEach(d => {
        const cell = document.createElement("div");
        cell.textContent = d;
        cell.className = "day-name";
        grid.appendChild(cell);
      });

      const daysInMonth = new Date(year, month + 1, 0).getDate();
      for (let i = 0; i < firstDay; i++) grid.appendChild(document.createElement("div"));

      for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement("div");
        cell.textContent = day;
        cell.className = "day-cell";
        const today = new Date();
        if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear())
          cell.classList.add("today");
        const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
        cell.onclick = () => loadAllShifts(dateStr);
        grid.appendChild(cell);
      }
      updateMonthShiftMarkers();
    }

    function changeMonth(offset) {
      currentMonth += offset;
      if (currentMonth < 0) { currentMonth = 11; currentYear--; }
      if (currentMonth > 11) { currentMonth = 0; currentYear++; }
      loadCalendar(currentYear, currentMonth);
    }

    /* === æ¨™è¨˜æœ‰ç­æ—¥ === */
    function updateMonthShiftMarkers() {
      const ym = `${currentYear}-${String(currentMonth + 1).padStart(2, "0")}`;
      fetch(`${scriptUrl}?month=${ym}&mode=summary`)
        .then(res => res.json())
        .then(data => {
          const zhongshanDays = data.zhongshanDays || [];
          const jingmeiDays = data.jingmeiDays || [];
          document.querySelectorAll(".day-cell").forEach(cell => {
            const day = cell.textContent;
            const full = `${ym}-${String(day).padStart(2, "0")}`;
            if (zhongshanDays.includes(full)) cell.classList.add("shift-zhongshan");
            if (jingmeiDays.includes(full)) cell.classList.add("shift-jingmei");
          });
        })
        .catch(() => console.log("ç„¡æ³•å–å¾—æœ‰ç­æ—¥"));
    }

    /* === ç­è¡¨ === */
    function loadAllShifts(dateStr) {
      const target = dateStr || new Date().toISOString().split("T")[0];
      fetch(`${scriptUrl}?date=${target}&mode=all`)
        .then(res => res.json())
        .then(data => {
          const shifts = data.shifts || [];
          if (!shifts.length) {
            document.getElementById("selected-shift").innerHTML = "ç„¡ç­è¡¨è³‡æ–™";
            return;
          }
          const zhongshan = [], jingmei = [], off = [];
          shifts.forEach(s => {
            const shift = s.shift || "";
            if (/å‡/.test(shift)) off.push(s);
            else if (/ä¸­å±±/.test(shift)) zhongshan.push(s);
            else if (/æ™¯ç¾/.test(shift)) jingmei.push(s);
          });
          const sortOrder = ["æ«ƒæª¯","å½©å¦","æ”å½±","ä¿®åœ–"];
          const sorter = (a,b)=>{
            const ai=sortOrder.findIndex(k=>a.shift.includes(k));
            const bi=sortOrder.findIndex(k=>b.shift.includes(k));
            return (ai===-1?99:ai)-(bi===-1?99:bi);
          };
          zhongshan.sort(sorter); jingmei.sort(sorter);
          let html = `ğŸ“… ${target} å…¨å“¡ç­è¡¨<br><br>`;
          if (zhongshan.length) html += `<div class="group-title">[ä¸­å±±]</div>` + formatGroup(zhongshan);
          if (jingmei.length) html += `<div class="group-title">[æ™¯ç¾]</div>` + formatGroup(jingmei);
          if (off.length) html += `<div class="group-title">[æ”¾å‡]</div>` + off.map(s=>`ãƒ»${s.name}`).join("<br>");
          document.getElementById("selected-shift").innerHTML = html;
        })
        .catch(()=>document.getElementById("selected-shift").textContent="è®€å–å¤±æ•—");
    }

    function formatGroup(list){
      const grouped={};
      list.forEach(s=>{
        const match=s.shift.match(/(æ«ƒæª¯|å½©å¦|æ”å½±|ä¿®åœ–)/);
        const role=match?match[1]:"å…¶ä»–";
        if(!grouped[role])grouped[role]=[];
        grouped[role].push(s.name);
      });
      const store=list[0].shift.includes("ä¸­å±±")?"ä¸­å±±":"æ™¯ç¾";
      return Object.keys(grouped)
        .map(role=>`${store}${role}ï¼š${grouped[role].join("ã€")}`)
        .join("<br>");
    }

    /* === æ‰“å¡ === */
    function submitClockIn() {
      const email = localStorage.getItem("qoopio_email");
      if (!email) return alert("è«‹å…ˆç™»å…¥ï¼");
      const type = document.getElementById("clockInBtn").dataset.type || "ä¸Šç­";
      navigator.geolocation.getCurrentPosition(pos=>{
        const data={email,type,lat:pos.coords.latitude,lng:pos.coords.longitude};
        const name=userData[email]?.name||email;
        const timeStr=new Date().toLocaleTimeString();
        document.getElementById("status").textContent=`âœ… ${name} ${type}ï¼ˆ${timeStr}ï¼‰`;
        document.getElementById("status").style.color="green";
        fetch(scriptUrl,{method:"POST",mode:"no-cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)});
      },()=>alert("ç„¡æ³•å–å¾—å®šä½è³‡è¨Š"));
    }

    function resetEmail(){
      localStorage.removeItem("qoopio_email");
      location.reload();
    }
  </script>
</body>
</html>
