<!DOCTYPE html>
<html lang="zh-TW" style="background-color: #fdf5e6;">
<head>
  <meta charset="UTF-8" />
  <title>Qoopio</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#fdf5e6" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no" />
  <link rel="manifest" href="manifest.json?v=20251201" />
  <link rel="icon" href="icon.png" />
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js?v=20251201");
    }
  </script>
  <style>
    /* Base & Reset */
    @supports(height:100dvh){
      .container{min-height:calc(100dvh - env(safe-area-inset-bottom,0px))}
    }
    html,body{
      margin:0;padding:0;height:100%;
      background-color:#fdf5e6;
      font-family:"Helvetica Neue",Arial,sans-serif;
      color:#333;text-align:center;overflow-x:hidden;
    }
    .hidden{display:none!important;}

    /* page-section: é é¢åˆ‡æ›æ·¡å…¥å‹•ç•« */
    .page-section{
      width:100%;flex:1;
      opacity:0;
      transform:translateY(6px);
      transition:opacity 0.2s ease, transform 0.2s ease;
    }
    .page-section.visible{
      opacity:1;
      transform:translateY(0);
    }
    
    /* Header */
    #global-header{
      position:fixed;top:0;left:0;right:0;
      height:60px;background:#fdf5e6;
      display:flex;align-items:center;justify-content:center;
      z-index:10010;padding-top:env(safe-area-inset-top,0px);
    }
    .header-logo{height:56px;width:auto;display:block;}

    /* Container */
    .container{
      max-width:500px;margin:0 auto;
      padding:calc(60px + env(safe-area-inset-top,0px)) 1rem calc(3rem + env(safe-area-inset-bottom,0px));
      box-sizing:border-box;
      min-height:calc(100vh - env(safe-area-inset-bottom,0px));
      display:flex;flex-direction:column;
    }

    /* Login */
    #login-page{padding-top:10vh;}
    .logo-large{width:200px;margin-bottom:1.5rem;}
    #login-page input{
      width:80%;padding:0.8rem;margin:1rem 0;
      border-radius:8px;border:1px solid #ccc;
    }
    #login-page button{
      padding:0.8rem 1.5rem;background:#111;color:#fff;
      border:none;border-radius:8px;cursor:pointer;
    }

    /* Clock */
    #page-clock{
      display:flex;flex-direction:column;
      justify-content:center;
      padding-top:12vh;padding-bottom:12vh;
    }
    .user-label{font-size:1.1rem;font-weight:bold;margin-bottom:0.4rem;}
    .user-symbol{font-size:0.95rem;color:#444;margin-bottom:0.3rem;}
    .user-email{font-size:0.9rem;color:#666;margin-bottom:1rem;font-family:monospace;}
    /* Clock Headerï¼šå·¦ç´™å¨ƒå¨ƒ + å³è³‡è¨Šåˆ— */
    .clockin-header{display:flex;align-items:center;justify-content:flex-start;gap:12px;margin-bottom:1.2rem;}
    /* ç´…è‰²æ¡†ï¼šä¹‹å¾Œæ”¾ç´™å¨ƒå¨ƒ */
    .avatar-slot{
      flex:0 0 96px;          /* ç´™å¨ƒå¨ƒå¯¬åº¦ï¼Œå¯è‡ªè¡Œèª¿æ•´ */
      aspect-ratio:3 / 4;     /* ç´™å¨ƒå¨ƒæ¯”ä¾‹ */
      border-radius:10px;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      box-sizing:border-box;
    }
    .avatar-placeholder{font-size:12px;opacity:0.6;}
    .user-info-block{
      flex:1;
      border-radius:8px;
      padding:6px 10px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:left;
      gap:4px;
      box-sizing:border-box;
      min-width:0;          /* è®“ flex è£¡é¢çš„å¯¬åº¦å¯ä»¥ç¸® */
    }
    
    /* ä¸‰è¡Œæ–‡å­—ï¼šå–®è¡Œã€ä¸æ›è¡Œã€äº¤çµ¦ JS è‡ªå‹•ç¸®å­—ç´š */
    .user-info-block > div{white-space:nowrap;overflow:hidden;text-overflow:clip;}       /* ä¸è¦ â€¦ ç”±ç¸®å­—ä¾†è™•ç† */
    
    /* é¢¨æ ¼å¾®èª¿ */
    .user-name{font-weight:600;}
    .user-symbol{opacity:0.85;}
    .user-email{opacity:0.7;font-family:monospace;}
    
    /* çµ±ä¸€æ‰“å¡å€å¡Š layout */
    #page-clock{
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      padding-top:12vh;
      padding-bottom:15vh;
      align-items:stretch;
    }
    #clockInBtn{
      width:80%;padding:1.7rem;font-size:1.3rem;
      background:#111;color:#fff;border:none;border-radius:10px;
      margin:0.8rem auto;transition:opacity 0.3s, background 0.2s;
    }
    #clockInBtn:disabled{background:#bbb;opacity:.6;}
    .logout-btn{background:none;border:none;color:#777;margin:0 auto;}
    #status{margin-top:1rem;font-weight:bold;}

    /* ===== Schedule â€“ æœˆæ›†æ¨£å¼ ===== */
    .calendar-header{
      padding-top:1rem;
      display:flex;justify-content:space-between;align-items:center;
      margin-bottom:0.6rem;
      font-size:1.2rem;font-weight:bold;
    }
    .calendar-header button{
      background:none;border:none;
      font-size:1.6rem;font-weight:bold;
      cursor:pointer;padding:0.2rem 0.6rem;
      border-radius:999px;
      color:#000; /* ç®­é ­ç¶­æŒé»‘è‰² */
      transition:background 0.15s ease, transform 0.12s ease;
    }
    .calendar-header button:active{
      transform:scale(0.9);
      background:rgba(0,0,0,0.05);
    }

    .calendar-grid{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:4px;
      margin-bottom:0.8rem;
      font-size:0.8rem;
    }
    .day-name{
      font-size:0.75rem;
      color:#999;
      text-align:center;
      padding:0.15rem 0 0.25rem;
    }

    @keyframes dayIn{
      from{opacity:0;transform:translateY(10px) scale(0.95);}
      to{opacity:1;transform:translateY(0) scale(1);}
    }

    .day-cell{
      position:relative;
      padding:6px 0 10px;
      border-radius:12px;
      cursor:pointer;
      display:flex;flex-direction:column;
      align-items:center;justify-content:flex-start;
      transition:
        background 0.18s ease,
        color 0.18s ease,
        transform 0.18s ease,
        box-shadow 0.18s ease;
      font-size:0.9rem;
      opacity:0;
      transform:translateY(6px) scale(0.96);
      animation:dayIn 0.26s ease-out forwards;
    }
    .day-cell.today{
      box-shadow:0 0 0 1px #111 inset;
      font-weight:600;
    }
    .day-cell.selected{
      background:#111;
      color:#fff;
      box-shadow:0 4px 10px rgba(0,0,0,0.18);
      transform:translateY(-2px) scale(1.02);
    }
    .day-cell.selected .day-indicator{
      opacity:1;
      border-color:rgba(255,255,255,0.6);
    }
    .day-cell:active{
      transform:translateY(1px) scale(0.98);
    }

    .day-indicator{
      width:7px;height:7px;border-radius:50%;
      margin-top:4px;
      border:1px solid transparent;
      opacity:0;
      transition:opacity 0.18s, background 0.18s, border-color 0.18s;
    }
    /* ä¸­å±± = ç´…é» */
    .shift-zhongshan .day-indicator{
      background-color:#e74c3c;
      opacity:1;
    }
    /* æ™¯ç¾ = ç¶ é» */
    .shift-jingmei .day-indicator{
      background-color:#27ae60;
      opacity:1;
    }
    /* å¾Œå‚™ï¼šæœ‰æ’ç­ä½†ç„¡é–€å¸‚è³‡è¨Šï¼Œç”¨ç¶ é» */
    .shift-any .day-indicator{
      background-color:#27ae60;
      opacity:1;
    }

    /* é¸å–ç•¶æ—¥ç­è¡¨ â€“ åº•éƒ¨å¡ç‰‡ */
    #selected-shift{
      padding:1rem 1rem 0.8rem;
      background:#fff;
      border-radius:14px;
      box-shadow:0 4px 12px rgba(0,0,0,0.08);
      min-height:60px;
      text-align:left;
      line-height:1.7;
      font-size:0.9rem;
      transform:translateY(10px);
      opacity:0;
      transition:opacity 0.22s ease, transform 0.22s ease;
    }
    #selected-shift.show{
      opacity:1;
      transform:translateY(0);
    }
    .shift-date-title{
      font-weight:700;
      margin-bottom:10px;
      font-size:0.95rem;
    }

    /* æ—¥æœŸåˆ‡æ›æ™‚çš„å° loading åœˆåœˆ */
    .shift-loading{
      width:18px;height:18px;
      border-radius:50%;
      border:2px solid #ddd;
      border-top-color:#111;
      animation:spin 0.7s linear infinite;
      margin:4px auto;
    }

    /* Admin/Manager */
    .manager-tabs{display:flex;gap:10px;margin-bottom:15px;justify-content:center;}
    .manager-tabs button{
      padding:8px 16px;border-radius:8px;
      border:1px solid #ccc;background:transparent;
      font-weight:bold;color:#777;font-size:1.1rem;cursor:pointer;
    }
    .manager-tabs button.active{background:#111;color:#fff;border-color:#111;}
    
    .dash-title{font-size:1.1rem;font-weight:bold;margin:20px 0 10px 0;border-left:4px solid #111;text-align:left;padding-left:10px;}
    .dashboard-card{background:#fff;padding:15px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:10px;text-align:left;}
    .dash-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee;font-size:0.95rem;}
    .dash-item:last-child{border-bottom:none;}
    .btn-approve{padding:4px 8px;border-radius:6px;border:none;background:#27ae60;color:#fff;font-weight:bold;cursor:pointer;}
    
    .admin-menu-btn{width:100%;padding:16px;background:#fff;border:1px solid #ddd;border-radius:12px;margin-bottom:10px;font-size:1rem;font-weight:bold;display:flex;justify-content:space-between;align-items:center;cursor:pointer;box-shadow:0 2px 5px rgba(0,0,0,0.05);}
    .admin-input{width:100%;padding:12px;margin-bottom:10px;border:1px solid #ddd;border-radius:8px;box-sizing:border-box;font-size:1rem;}
    .admin-action-btn{width:100%;padding:12px;background:#111;color:#fff;border:none;border-radius:8px;font-weight:bold;cursor:pointer;font-size:1rem;}

    /* Leave Page */
    .leave-btn-main{
      position:fixed;left:50%;transform:translateX(-50%);
      bottom:calc(100px + env(safe-area-inset-bottom,0px));
      z-index:9998;width:55%;min-width:180px;max-width:300px;
      padding:0.9rem;font-size:1rem;border-radius:999px;border:none;
      background:#111;color:#fff;cursor:pointer;
      box-shadow:0 4px 14px rgba(0,0,0,0.12);
    }
    #leave-history{margin-top:0.5rem;font-size:0.9rem;color:#555;}
    .leave-card{padding:0.8rem;border-radius:12px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:0.8rem;text-align:left;}
    .leave-card .row-1{display:flex;justify-content:space-between;align-items:center;margin-bottom:0.4rem;font-weight:bold;}
    .status-bar{padding:2px 8px;border-radius:4px;color:#fff;font-size:0.8rem;}
    .status-å¯©æ ¸ä¸­{background:#e67e22;} .status-é€šé{background:#27ae60;} .status-é€€å›{background:#c0392b;}

    /* FAB */
    #fab-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:10015;}
    .menu-fab{position:fixed;left:24px;bottom:calc(24px + env(safe-area-inset-bottom,0px));z-index:10020;display:none;flex-direction:column;align-items:flex-start;}
    .fab-main{width:60px;height:60px;border-radius:50%;background:#111;color:#fff;border:none;box-shadow:0 6px 16px rgba(0,0,0,0.35);font-size:1.6rem;position:relative;display:flex;align-items:center;justify-content:center;cursor:pointer;}
    .fab-icon-o,.fab-icon-x{position:absolute;font-family:sans-serif;font-weight:700;transition:all 0.3s;}
    .fab-icon-o{opacity:1;transform:scale(1);} .fab-icon-x{opacity:0;transform:rotate(-90deg)scale(0.5);}
    .fab-main.open .fab-icon-o{opacity:0;transform:scale(0.5);} .fab-main.open .fab-icon-x{opacity:1;transform:rotate(0deg)scale(1);}
    .menu-sheet{margin-bottom:10px;} .menu-sheet.hidden{display:none;}
    .fab-option{display:flex;align-items:center;margin-bottom:8px;}
    .menu-pill{padding:7px 16px;background:#fff;border:none;color:#333;font-size:0.95rem;font-weight:bold;border-radius:999px;box-shadow:0 4px 12px rgba(0,0,0,0.18);cursor:pointer;white-space:nowrap;}
    .menu-pill.active{background:#111;color:#fff;}
    .menu-pill.has-notif{position:relative;}
    .menu-pill.has-notif::after{content:'';position:absolute;top:0;right:0;width:10px;height:10px;background:#ff3b30;border-radius:50%;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,0.2);}

    /* HUD & Modals */
    .hud-right{position:fixed;right:16px;bottom:calc(16px + env(safe-area-inset-bottom,0px));display:none;z-index:10025;}
    .gacha-btn{background:transparent;border:0;} .gacha-img{width:96px;}
    .gacha-badge{position:absolute;right:-6px;top:-6px;min-width:22px;padding:0 6px;border-radius:999px;background:#111;color:#fff;font-size:12px;font-weight:800;border:1px solid #fff;}
    
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:10030;}
    .modal.open{display:flex;}
    .modal-card{width:min(520px,92%);background:#fff;border-radius:16px;padding:20px;text-align:left;position:relative;max-height:85vh;overflow-y:auto;}
    .modal-close-btn{position:absolute;top:15px;right:15px;background:none;border:none;font-size:1.5rem;cursor:pointer;line-height:1;}
    .modal-title{font-size:1.2rem;font-weight:bold;margin-bottom:15px;text-align:center;}

    /* Gacha UI */
    .modal-tabs{display:flex;gap:8px;margin-bottom:10px;}
    .modal-tabs button{flex:1;padding:8px;border-radius:10px;border:1px solid #222;background:#fff;cursor:pointer;font-weight:700;color:#111;}
    .modal-tabs button.active{background:#111;color:#fff;border-color:#111;}
    .gacha-body-content{text-align:center;padding:10px 0;}
    .gacha-btn-main{width:100%;padding:16px;font-size:1.2rem;font-weight:bold;color:#fff;background:#111;border:none;border-radius:12px;cursor:pointer;box-shadow:0 6px 0 #444;margin-bottom:10px;transform:translateY(0);transition:all 0.1s;}
    .gacha-btn-main:active{box-shadow:0 2px 0 #444;transform:translateY(4px);}
    .gacha-btn-main:disabled{background:#aaa;box-shadow:none;transform:translateY(4px);cursor:not-allowed;}
    .gacha-result{min-height:60px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;font-weight:bold;color:#111;margin-top:10px;opacity:0;transition:opacity 0.3s;}
    .gacha-result.show{opacity:1;}
    .shake-hard{animation:shake 0.5s infinite;}
    @keyframes shake{
      0%,100%{transform:translateX(0)}
      25%{transform:translateX(-5px)}
      75%{transform:translateX(5px)}
    }

    /* Loading (å…¨ç•«é¢) */
    #loading-screen{
      position:fixed;inset:0;background:#fdf5e6;
      display:flex;flex-direction:column;
      align-items:center;justify-content:center;
      z-index:20000;transition:opacity 0.3s;
    }
    #loading-screen.hidden{opacity:0;pointer-events:none;}
    .spinner{
      width:40px;height:40px;border:4px solid #ccc;
      border-top-color:#111;border-radius:50%;
      animation:spin 0.8s linear infinite;margin-bottom:10px;
    }
    @keyframes spin{to{transform:rotate(360deg);}}

  </style>
</head>
<body>
  <div id="loading-screen">
    <div class="spinner"></div>
    <p>ç³»çµ±é€£ç·šä¸­...</p>
  </div>
  <div id="fab-overlay" class="hidden" onclick="toggleMenu()"></div>
  <header id="global-header" class="hidden">
    <img src="qoopio logo.png" class="header-logo" />
  </header>

  <div class="container">
    <div id="login-page" class="hidden page-section">
      <img src="qoopio logo.png" class="logo-large" />
      <h3>è«‹è¼¸å…¥æ‚¨çš„ Email ç™»å…¥</h3>
      <input type="email" id="login-email" placeholder="name@qoopio.com" />
      <button onclick="login()">é€²å…¥ç³»çµ±</button>
    </div>

    <div id="page-clock" class="hidden page-section">
      <!-- é ‚éƒ¨ï¼šç´™å¨ƒå¨ƒ + ä½¿ç”¨è€…è³‡è¨Š -->
      <div class="clockin-header">
        <!-- ç´…è‰²æ¡†ï¼šæœªä¾†ç´™å¨ƒå¨ƒé¡¯ç¤ºå€ -->
        <div class="avatar-slot">
          <!-- ä¹‹å¾Œå¯ä»¥æ›æˆ <img> æˆ– canvas -->
          <span class="avatar-placeholder">ç´™å¨ƒå¨ƒ</span>
        </div>
    
        <!-- ç¶ è‰²æ¡†ï¼šåç¨± / ç¬¦è™Ÿ / emailï¼ˆè‡ªå‹•ç¸®å­—ç´šï¼‰ -->
        <div class="user-info-block">
          <div id="user-label"
               class="user-name auto-fit-text"
               data-min="14" data-max="20"></div>
    
          <div id="user-symbol"
               class="user-symbol auto-fit-text"
               data-min="12" data-max="18"></div>
    
          <div id="user-email"
               class="user-email auto-fit-text"
               data-min="10" data-max="16"></div>
        </div>
      </div>
    
      <!-- ä¸­é–“ï¼šæ‰“å¡æŒ‰éˆ• -->
      <button id="clockInBtn" type="button" onclick="submitClockIn()">è®€å–ä¸­...</button>
      <!-- ä¸‹æ–¹ï¼šç™»å‡º / ç‹€æ…‹æ–‡å­— -->
      <button onclick="resetApp()" class="logout-btn">ç™»å‡º</button>
      <div id="status"></div>
    </div>

    <div id="page-leave" class="hidden page-section">
      <h3 style="display:none">è«‹å‡</h3>
      <button class="leave-btn-main" type="button" onclick="openModal('leave')">ç”³è«‹è«‹å‡</button>
      <h4>å€‹äººè«‹å‡ç´€éŒ„</h4>
      <div id="leave-history">è¼‰å…¥ä¸­...</div>
    </div>

    <div id="page-schedule" class="hidden page-section">
      <div class="calendar-header">
        <button onclick="changeMonth(-1)">ã€ˆ</button>
        <span id="calendar-title"></span>
        <button onclick="changeMonth(1)">ã€‰</button>
      </div>
      <div id="calendar-grid" class="calendar-grid"></div>
      <div id="selected-shift" class="show">ğŸ“… è«‹é¸æ“‡æ—¥æœŸæŸ¥çœ‹ç­åˆ¥</div>
    </div>

    <div id="page-manager" class="hidden page-section">
      <div class="dash-title">å·¨äººä¹‹åŠ›</div>
      <div class="manager-tabs">
        <button id="mgr-tab-pending" class="active" onclick="showMgrTab('pending')">å¾…å¯©æ ¸</button>
        <button id="mgr-tab-today" onclick="showMgrTab('today')">ä»Šæ—¥å‡ºå‹¤</button>
      </div>
      <div id="mgr-view-pending">
        <div class="dashboard-card" id="mgr-review-list">è¼‰å…¥ä¸­...</div>
      </div>
      <div id="mgr-view-today" class="hidden">
        <div class="dashboard-card" id="mgr-dashboard-list">è¼‰å…¥ä¸­...</div>
      </div>
    </div>

    <div id="page-admin" class="hidden page-section">
      <div class="dash-title">åœ¨ç‹—å«ä»€éº¼</div>
      <button class="admin-menu-btn" onclick="openModal('admin-token')">
        ğŸ ç™¼é€æ‰­è›‹ä»£å¹£ <span>â€º</span>
      </button>
      <button class="admin-menu-btn" onclick="openModal('admin-announce')">
        ğŸ“¢ ç™¼å¸ƒå…¨åŸŸå…¬å‘Š <span>â€º</span>
      </button>
      <button class="admin-menu-btn" onclick="openModal('admin-sync')">
        âš™ï¸ ç³»çµ±è³‡æ–™åŒæ­¥ <span>â€º</span>
      </button>
    </div>
  </div>

  <div class="menu-fab" id="menu-fab">
    <div class="menu-sheet hidden" id="menu-sheet">
      <div class="fab-option"><button class="menu-pill" data-page="clock" onclick="nav('clock')">æ‰“å¡</button></div>
      <div class="fab-option"><button class="menu-pill" data-page="leave" onclick="nav('leave')">è«‹å‡</button></div>
      <div class="fab-option"><button class="menu-pill" data-page="schedule" onclick="nav('schedule')">ç­è¡¨</button></div>
      <div class="fab-option hidden" id="fab-mgr"><button class="menu-pill" data-page="manager" onclick="nav('manager')">å¸•æ‹‰è¿ªå³¶</button></div>
      <div class="fab-option hidden" id="fab-adm"><button class="menu-pill" data-page="admin" onclick="nav('admin')">å¤§ç ”å‰µæ„çš„ç‹—</button></div>
    </div>
    <button class="fab-main" onclick="toggleMenu()">
      <span class="fab-icon-o">O</span>
      <span class="fab-icon-x">âœ•</span>
    </button>
  </div>

  <div class="hud-right" id="hud-right">
    <button class="gacha-btn" onclick="openModal('gacha')">
      <img id="gacha-img" src="icon.png" class="gacha-img" />
      <span class="gacha-badge" id="hud-coin">0</span>
    </button>
  </div>

  <!-- Gacha Modal -->
  <div class="modal" id="modal-gacha">
    <div class="modal-card">
      <button class="modal-close-btn" onclick="closeModal('gacha')">âœ•</button>
      <div class="modal-title">æ‰­è›‹æ©Ÿ</div>
      <div class="modal-tabs">
        <button id="tab-gacha-play" class="active" onclick="switchGachaTab('play')">æ‰­è›‹</button>
        <button id="tab-gacha-log" onclick="switchGachaTab('log')">ç´€éŒ„</button>
      </div>
      <div class="gacha-body-content" id="gacha-view-play">
        <p>ä»£å¹£ï¼š<span id="modal-coin-count">0</span></p>
        <div style="height:10px"></div>
        <button id="gacha-action-btn" class="gacha-btn-main" onclick="playGacha()">START</button>
        <div id="gacha-result-display" class="gacha-result"></div>
        <div style="font-size:0.85rem; color:#888; margin-top:10px;">ç¥æ‚¨ä¸­ç (Â´â‰–â—à±ªâ—Ÿâ‰–)</div>
      </div>
      <div class="hidden" id="gacha-view-log">
        <div id="gacha-history-list" style="max-height:200px; overflow-y:auto;"></div>
      </div>
    </div>
  </div>

  <!-- Leave Modal -->
  <div class="modal" id="modal-leave">
    <div class="modal-card">
      <button class="modal-close-btn" onclick="closeModal('leave')">âœ•</button>
      <div class="modal-title">ç”³è«‹è«‹å‡</div>
      <label style="display:block;margin-top:10px">æ—¥æœŸ</label>
      <select id="leave-date" class="admin-input"></select>
      <label style="display:block;margin-top:10px">å‡åˆ¥</label>
      <select id="leave-type" class="admin-input">
        <option>äº‹å‡</option>
        <option>ç—…å‡</option>
        <option>ä¼‘å‡</option>
        <option>ç‰¹ä¼‘å‡</option>
      </select>
      <label style="display:block;margin-top:10px">åŸå› </label>
      <input id="leave-reason" class="admin-input" placeholder="é¸å¡«..." />
      <button class="admin-action-btn" style="margin-top:15px" onclick="submitLeave()">é€å‡ºç”³è«‹</button>
    </div>
  </div>

    <!-- Review Leave Modal -->
  <div class="modal" id="modal-review">
    <div class="modal-card">
      <button class="modal-close-btn" onclick="closeModal('review')">âœ•</button>
      <div class="modal-title">è«‹å‡å¯©æ ¸</div>
      <div style="font-size:0.95rem; line-height:1.7;">
        <div><b>ç”³è«‹äººï¼š</b><span id="rv-name"></span></div>
        <div><b>ç”³è«‹æ™‚é–“ï¼š</b><span id="rv-appliedAt"></span></div>
        <div><b>è«‹å‡æ—¥æœŸï¼š</b><span id="rv-date"></span></div>
        <div><b>å‡åˆ¥ï¼š</b><span id="rv-type"></span></div>
        <div><b>åŸå› ï¼š</b><span id="rv-reason"></span></div>
      </div>
      <div style="margin-top:12px;">
        <label style="font-size:0.9rem;display:block;margin-bottom:4px;">å¯©æ ¸å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
        <textarea id="rv-note" class="admin-input" rows="3" placeholder="ä¾‹å¦‚ï¼šç­è¡¨å·²èª¿æ•´ã€è«‹è£œå‡å–®..."></textarea>
      </div>
      <div style="display:flex;gap:10px;margin-top:14px;">
        <button class="admin-action-btn" style="flex:1;background:#27ae60;"
                onclick="handleReviewAction('é€šé')">é€šé</button>
        <button class="admin-action-btn" style="flex:1;background:#c0392b;"
                onclick="handleReviewAction('é€€å›')">é€€å›</button>
      </div>
    </div>
  </div>

  <!-- Admin: Token -->
  <div class="modal" id="modal-admin-token">
    <div class="modal-card">
      <button class="modal-close-btn" onclick="closeModal('admin-token')">âœ•</button>
      <div class="modal-title">ç™¼é€ä»£å¹£</div>

      <div style="font-size:0.9rem;margin-bottom:6px;">é¸æ“‡å°è±¡ï¼ˆå¯è¤‡é¸ï¼‰</div>
      <div id="adm-user-list"
           style="max-height:180px;overflow-y:auto;border:1px solid #eee;border-radius:8px;padding:6px 10px;margin-bottom:10px;font-size:0.9rem;text-align:left;">
        è®€å–ä¸­...
      </div>

      <input id="adm-token-amt" class="admin-input" type="number" placeholder="æ¯äººç™¼æ”¾æ•¸é‡" />
      <input id="adm-token-reason" class="admin-input" placeholder="åŸå› ï¼ˆä¾‹å¦‚ï¼šæ´»å‹•çå‹µã€è¡¨ç¾å„ªç§€â€¦ï¼‰" />

      <button id="adm-token-submit" class="admin-action-btn" onclick="adminGiveToken()">ç™¼é€</button>
    </div>
  </div>

  <!-- Admin: Announcement -->
  <div class="modal" id="modal-admin-announce">
    <div class="modal-card">
      <button class="modal-close-btn" onclick="closeModal('admin-announce')">âœ•</button>
      <div class="modal-title">ç™¼å¸ƒå…¬å‘Š</div>
      <input id="adm-ann-title" class="admin-input" placeholder="æ¨™é¡Œ" />
      <textarea id="adm-ann-content" class="admin-input" rows="4" placeholder="å…§å®¹..."></textarea>
      <button id="adm-announce-submit" class="admin-action-btn" onclick="adminSetAnnounce()">ç™¼å¸ƒ</button>
    </div>
  </div>

  <!-- Admin: Sync -->
  <div class="modal" id="modal-admin-sync">
    <div class="modal-card">
      <button class="modal-close-btn" onclick="closeModal('admin-sync')">âœ•</button>
      <div class="modal-title">ç³»çµ±åŒæ­¥</div>
      <button class="admin-menu-btn" onclick="adminSync('schedule')">ğŸ“¥ åŒæ­¥ A è¡¨æ’ç­ (è‡³æœ¬æœˆBè¡¨)</button>
      <button class="admin-menu-btn" onclick="adminSync('clock')">ğŸ•’ è£œå¡«æ‰“å¡æ™‚é–“ (è‡³æœ¬æœˆBè¡¨)</button>
    </div>
  </div>

  <!-- Announcement Modal -->
  <div class="modal" id="modal-show-announce">
    <div class="modal-card" style="text-align:center">
      <div id="ann-display-title" style="font-size:1.2rem;font-weight:bold;margin-bottom:10px"></div>
      <div id="ann-display-content" style="color:#555;margin-bottom:20px;line-height:1.5"></div>
      <button class="admin-action-btn" onclick="closeModal('show-announce')">æˆ‘çŸ¥é“äº†</button>
    </div>
  </div>

    <!-- Token Reward Modal -->
  <div class="modal" id="modal-token-reward">
    <div class="modal-card" style="text-align:center">
      <div style="font-size:1.1rem;font-weight:bold;margin-bottom:6px;">ğŸ ä½ æœ‰æ–°çš„ä»£å¹£</div>
      <div style="font-size:0.95rem;margin-bottom:16px;">
        æœ¬æ¬¡æ–°å¢ <span id="reward-token-amount" style="font-weight:bold;"></span> é¡†ä»£å¹£
      </div>
      <button class="admin-action-btn" onclick="closeModal('token-reward')">æ”¶ä¸‹ä»£å¹£</button>
    </div>
  </div>

<script>
  // âš ï¸ C è¡¨ Web App URL
  const API_URL =
    "https://script.google.com/macros/s/AKfycbzdG-XnSqTjbrRft_K4Wc3alPIso5RinyXjpqM82Ne6HAg4TW-b3IxUBc6n9kuSbT_y-Q/exec";

  let currentUser = null;
  let currentYear = new Date().getFullYear();
  let currentMonth = new Date().getMonth();
  let pendingLeaveItems = [];
  let currentReviewIndex = null;
  let allUsersForAdmin = [];
  const GACHA_ICON = "gacha-icon.png?v=4.5";

  /** åªé¡¯ç¤ºç™»å…¥é ï¼Œå…¶ä»–å…¨éƒ¨æ”¶èµ·ä¾†ï¼ˆé¿å…çœ‹åˆ°ã€Œç™½ç•«é¢ã€ï¼‰ */
  function showLoginOnly() {
    const loading = document.getElementById("loading-screen");
    if (loading) loading.classList.add("hidden");

    ["clock","leave","schedule","manager","admin"].forEach((p)=>{
      const el = document.getElementById("page-" + p);
      if (!el) return;
      el.classList.add("hidden");
      el.classList.remove("visible");
    });

    const header = document.getElementById("global-header");
    if (header) header.classList.add("hidden");
    const fab = document.getElementById("menu-fab");
    if (fab) fab.style.display = "none";

    const loginPage = document.getElementById("login-page");
    if (loginPage) {
      loginPage.classList.remove("hidden");
      requestAnimationFrame(()=>loginPage.classList.add("visible"));
    }
  }

  // é€²ç«™ï¼šåˆ¤æ–·æ˜¯å¦å·²ç™»å…¥
  window.addEventListener("load", async () => {
    // é è¼‰æ‰­è›‹ icon
    try {
      const img = new Image();
      img.onload = () => {
        const gachaImg = document.getElementById("gacha-img");
        if (gachaImg) gachaImg.src = GACHA_ICON;
      };
      img.src = GACHA_ICON;
    } catch (e) {}

    const email = localStorage.getItem("q_email");
    if (email) {
      await appInit(email);
    } else {
      showLoginOnly();
    }
  });

  async function appInit(email) {
    const loading = document.getElementById("loading-screen");
    if (loading) loading.classList.remove("hidden");
    document.getElementById("login-page").classList.add("hidden");

    try {
      const res = await fetch(`${API_URL}?action=initApp&email=${encodeURIComponent(email)}`);
      const data = await res.json();
      if (!data.ok) {
        alert(data.msg || "æŸ¥ç„¡å¸³è™Ÿ");
        resetApp();
        return;
      }

      currentUser = data.user;
      currentUser.email = email;

      setupUI(data);

      // âœ… ä»£å¹£å·®é¡æç¤ºï¼ˆç™»å…¥æ™‚ï¼‰
      const prevBalance = Number(localStorage.getItem("q_token_balance") || "0");
      const nowBalance  = Number(data.tokens || 0);
      if (nowBalance > prevBalance) {
        const diff = nowBalance - prevBalance;
        const span = document.getElementById("reward-token-amount");
        if (span) span.textContent = diff;
        openModal("token-reward");
      }
      localStorage.setItem("q_token_balance", nowBalance);

      // å…¬å‘Š
      if (data.announcement) {
        const lastRead = localStorage.getItem("q_ann_id");
        if (String(lastRead) !== String(data.announcement.id)) {
          document.getElementById("ann-display-title").textContent = data.announcement.title || "";
          document.getElementById("ann-display-content").textContent = data.announcement.content || "";
          openModal("show-announce");
          localStorage.setItem("q_ann_id", data.announcement.id);
        }
      }

      // åˆå§‹åŒ–ç­è¡¨
      loadCalendar(currentYear, currentMonth);
      updateMonthShiftMarkers();

      // é¡¯ç¤ºä¸»ç•«é¢ï¼ˆæ‰“å¡é ï¼‰
      if (loading) loading.classList.add("hidden");
      document.getElementById("global-header").classList.remove("hidden");
      const clockPage = document.getElementById("page-clock");
      clockPage.classList.remove("hidden");
      requestAnimationFrame(() => {
        clockPage.classList.add("visible");
        // åç¨± / ç¬¦è™Ÿ / email æ–‡å­—è‡ªå‹•ç¸®æ”¾
        applyAutoFitText();
      });

      const fab = document.getElementById("menu-fab");
      if (fab) fab.style.display = "flex";

      document.querySelectorAll(".menu-pill").forEach(btn=>btn.classList.remove("active"));
      const clockPill = document.querySelector('.menu-pill[data-page="clock"]');
      if (clockPill) clockPill.classList.add("active");
    } catch (e) {
      console.error(e);
      alert("é€£ç·šå¤±æ•—ï¼Œè«‹é‡è©¦");
      showLoginOnly();
    }
  }

  // ===== æ–‡å­—è‡ªå‹•ç¸®æ”¾ï¼Œç¢ºä¿ä¸æ›è¡Œ =====
  function fitTextToOneLine(el) {
    if (!el) return;
  
    // å¦‚æœé€™å€‹å…ƒç´ ç›®å‰æ˜¯ hiddenï¼ˆdisplay:noneï¼‰ï¼Œå…ˆè·³éï¼Œé¿å…ç®—åˆ° 0 å¯¬åº¦
    if (el.offsetParent === null) return;
  
    const min = parseFloat(el.dataset.min) || 10;
    const max = parseFloat(el.dataset.max) || 18;
  
    let size = max;
    el.style.fontSize = size + "px";
  
    // ä¸€ç›´ç¸®ï¼Œç›´åˆ°å¯¬åº¦ä¸è¶…éå®¹å™¨æˆ–åˆ°é”æœ€å°å­—ç´š
    while (el.scrollWidth > el.clientWidth && size > min) {
      size -= 1;
      el.style.fontSize = size + "px";
    }
  }
  
  function applyAutoFitText() {
    const elements = document.querySelectorAll(".auto-fit-text");
  
    // å…ˆæ¸…ç©ºå­—ç´šï¼Œé¿å…é‡è¤‡ç¸®è¶Šç¸®è¶Šå°
    elements.forEach((el) => {
      el.style.fontSize = "";
    });
  
    elements.forEach(fitTextToOneLine);
  }
  
  // è¦–çª—å°ºå¯¸è®ŠåŒ–æ™‚å†é‡ç®—ä¸€æ¬¡
  window.addEventListener("resize", () => {
    applyAutoFitText();
  });
  
  function setupUI(data) {
    // ===== å…ˆé‡ç½®æ¬Šé™ç›¸é—œ UI =====
    const mgrFab = document.getElementById("fab-mgr");
    const admFab = document.getElementById("fab-adm");
    if (mgrFab) mgrFab.classList.add("hidden");
    if (admFab) admFab.classList.add("hidden");
  
    const mgrPill = document.querySelector('.menu-pill[data-page="manager"]');
    const admPill = document.querySelector('.menu-pill[data-page="admin"]');
    if (mgrPill) mgrPill.classList.remove("has-notif");
    // ï¼ˆé é¢æœ¬èº«æ˜¯å¦èƒ½è¢«ç›´æ¥ nav åˆ°ï¼Œä½ ç›®å‰æ˜¯æ²’é–ï¼Œä½†å…¥å£æŒ‰éˆ•çœ‹ä¸åˆ°å°±å¥½ï¼‰
  
    // ===== ä»¥ä¸‹ç¶­æŒåŸæœ¬é‚è¼¯ =====
    const nameEl   = document.getElementById("user-label");
    const symbolEl = document.getElementById("user-symbol");
    const emailEl  = document.getElementById("user-email");
    const btn      = document.getElementById("clockInBtn");
    const status   = document.getElementById("status");
    
    const clockStatus = data.clockStatus || "";
    
    // åç¨±ã€Email
    nameEl.textContent  = currentUser.name  || "";
    emailEl.textContent = currentUser.email || "";
    
    // ç¬¦è™Ÿ
    if (currentUser.symbol) {
      symbolEl.textContent = currentUser.symbol;
      symbolEl.classList.remove("hidden");
    } else {
      symbolEl.textContent = "";
      symbolEl.classList.add("hidden");
    }
    
    // ä»£å¹£æ•¸
    document.getElementById("hud-coin").textContent         = data.tokens || 0;
    document.getElementById("modal-coin-count").textContent = data.tokens || 0;
    
    // æ‰“å¡ç‹€æ…‹
    if (clockStatus.includes("å·²")) {
      status.textContent = clockStatus;
      status.style.color = "green";
      const isOff = clockStatus.includes("ä¸‹ç­");
      btn.textContent = isOff ? "å·²ä¸‹ç­" : "ä¸‹ç­";
      btn.style.background = "#333";
      btn.dataset.type = isOff ? "done" : "ä¸‹ç­";
      btn.disabled = !!isOff;
    } else {
      status.textContent = clockStatus || "ä»Šæ—¥æœªæ‰“å¡";
      status.style.color = "#8B0000";
      btn.textContent = "ä¸Šç­";
      btn.dataset.type = "ä¸Šç­";
      btn.disabled = false;
      btn.style.background = "#111";
    }
    
    // æ¬Šé™ï¼šmanager / admin
    if (currentUser.role === "manager" || currentUser.role === "admin") {
      if (mgrFab) mgrFab.classList.remove("hidden");
      checkManagerBadge();
    }
    if (currentUser.role === "admin") {
      if (admFab) admFab.classList.remove("hidden");
    }
  }

  function login() {
    const email = document.getElementById("login-email").value.trim();
    if (!email) {
      alert("è«‹å…ˆè¼¸å…¥ Email");
      return;
    }
    localStorage.setItem("q_email", email);
    appInit(email);
  }

  function resetApp() {
    localStorage.removeItem("q_email");
    // å¦‚æœå¸Œæœ›ä»£å¹£å·®é¡æç¤ºé‡æ–°è¨ˆç®—ï¼Œä¹Ÿå¯ä»¥é †ä¾¿æ¸…
    // localStorage.removeItem("q_token_balance");
  
    currentUser = null;
  
    // æŠŠ FAB æ‡‰è©²çœ‹ä¸åˆ°çš„å…ˆè—èµ·ä¾†ï¼ˆä¿éšªï¼‰
    const mgrFab = document.getElementById("fab-mgr");
    const admFab = document.getElementById("fab-adm");
    if (mgrFab) mgrFab.classList.add("hidden");
    if (admFab) admFab.classList.add("hidden");
  
    showLoginOnly();
  }

  // ===== å°è¦½ FAB =====
  function toggleMenu() {
    const sheet   = document.getElementById("menu-sheet");
    const overlay = document.getElementById("fab-overlay");
    const fab     = document.querySelector(".fab-main");
    const hud     = document.getElementById("hud-right");
  
    // ç¾åœ¨é€™æ¬¡å‘¼å« toggleMenu ä¹‹å¾Œï¼Œå°è¦½åˆ—æœƒè®Šæˆã€Œæ‰“é–‹ã€é‚„æ˜¯ã€Œé—œé–‰ã€ï¼Ÿ
    const willOpen = sheet.classList.contains("hidden"); 
    // å¦‚æœåŸæœ¬æ˜¯ hiddenï¼Œä»£è¡¨é€™æ¬¡æœƒè¢«æ‰“é–‹
  
    sheet.classList.toggle("hidden");
    overlay.classList.toggle("hidden");
    fab.classList.toggle("open");
  
    // å°è¦½åˆ—æ‰“é–‹æ™‚é¡¯ç¤ºæ‰­è›‹æ©Ÿï¼Œé—œæ‰æ™‚éš±è—
    if (hud) {
      hud.style.display = willOpen ? "inline-flex" : "none";
    }
  }

  function nav(page) {
    const target = document.getElementById("page-" + page);

    document.querySelectorAll(".page-section").forEach((p)=>{
      p.classList.add("hidden");
      p.classList.remove("visible");
    });

    target.classList.remove("hidden");
    requestAnimationFrame(()=>target.classList.add("visible"));

    toggleMenu();

    document.querySelectorAll(".menu-pill").forEach(btn=>btn.classList.remove("active"));
    const pill = document.querySelector(`.menu-pill[data-page="${page}"]`);
    if (pill) pill.classList.add("active");

    if (page === "manager") loadManagerData();
    if (page === "leave" && currentUser) loadLeaveHistory(currentUser.email);
    if (page === "schedule") {
      updateMonthShiftMarkers();
    }
    if (page === "clock") {
      // åˆ‡å›æ‰“å¡é æ™‚ï¼Œé‡æ–°ä¾ç›®å‰å¯¬åº¦ç¸®ä¸€æ¬¡å­—
      requestAnimationFrame(() => {
        applyAutoFitText();
      });
    }
  }

  function openModal(id) {
    const el = document.getElementById("modal-" + id);
    if (!el) return;
    el.classList.add("open");
    if (id === "leave") prepareLeaveDates();
    if (id === "admin-token") loadAdminUserList();   // âœ… æ–°å¢
  }
  function closeModal(id) {
    const el = document.getElementById("modal-" + id);
    if (!el) return;
    el.classList.remove("open");
    if (id === "gacha") resetGachaUI();
  }

  // ===== ç­è¡¨ï¼šæœˆæ›† =====
  function loadCalendar(y, m) {
    const grid = document.getElementById("calendar-grid");
    grid.innerHTML = "";
    document.getElementById("calendar-title").textContent =
      y + " å¹´ " + (m + 1) + " æœˆ";

    const firstWeekday = (new Date(y, m, 1).getDay() + 6) % 7; // é€±ä¸€é–‹é ­
    const daysInMonth = new Date(y, m + 1, 0).getDate();

    ["ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","æ—¥"].forEach((n)=>{
      const c = document.createElement("div");
      c.className = "day-name";
      c.textContent = n;
      grid.appendChild(c);
    });

    for (let i = 0; i < firstWeekday; i++) {
      grid.appendChild(document.createElement("div"));
    }

    const today = new Date();
    const isSameMonth = today.getFullYear() === y && today.getMonth() === m;

    for (let d = 1; d <= daysInMonth; d++) {
      const cell = document.createElement("div");
      cell.className = "day-cell";
      cell.innerHTML = `<div>${d}</div><div class="day-indicator"></div>`;

      if (isSameMonth && d === today.getDate()) {
        cell.classList.add("today");
      }

      const ds = `${y}-${String(m + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
      cell.onclick = () => {
        document.querySelectorAll(".day-cell").forEach(x=>x.classList.remove("selected"));
        cell.classList.add("selected");
        const box = document.getElementById("selected-shift");
        box.classList.remove("show");
        box.innerHTML = `<div class="shift-loading"></div>`;
        loadAllShifts(ds);
      };

      cell.style.animationDelay = d * 0.01 + "s";
      grid.appendChild(cell);
    }
  }

  async function updateMonthShiftMarkers(){
    if (!currentUser || !currentUser.email) return;

    try {
      const ym = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}`;
      const res = await fetch(
        `${API_URL}?month=${ym}&mode=summary&email=${encodeURIComponent(currentUser.email)}`
      );
      const d = await res.json();

      const zs = Array.isArray(d.zhongshanDays) ? d.zhongshanDays : [];
      const jm = Array.isArray(d.jingmeiDays)  ? d.jingmeiDays  : [];
      const dw = Array.isArray(d.daysWithShift) ? d.daysWithShift : [];

      const cells = document.querySelectorAll(".day-cell");
      cells.forEach(c=>{
        c.classList.remove("shift-zhongshan","shift-jingmei","shift-any");
        const first = c.firstElementChild;
        if (!first) return;
        const dayNum = parseInt(first.textContent,10);
        if (!dayNum) return;
        const fullDate = `${ym}-${String(dayNum).padStart(2,'0')}`;

        let marked = false;
        if (zs.includes(fullDate)) {
          c.classList.add("shift-zhongshan");
          marked = true;
        }
        if (jm.includes(fullDate)) {
          c.classList.add("shift-jingmei");
          marked = true;
        }
        if (!marked && dw.includes(fullDate)) {
          // æœ‰ç­ä½†æ²’åˆ†é–€å¸‚ï¼Œç”¨ shift-any é¡¯ç¤ºç¶ é»
          c.classList.add("shift-any");
        }
      });
    } catch (e) {
      console.error("updateMonthShiftMarkers error:", e);
    }
  }

  function changeMonth(o) {
    currentMonth += o;
    if (currentMonth < 0) {
      currentMonth = 11;
      currentYear--;
    }
    if (currentMonth > 11) {
      currentMonth = 0;
      currentYear++;
    }
    loadCalendar(currentYear, currentMonth);
    updateMonthShiftMarkers();
  }

  /** æŠŠã€Œåå­— (ä¸­å±±æ«ƒæª¯)ã€é€™ç¨®å­—ä¸²æ‹†æˆ {name, shift} */
  function parseShiftString(str) {
    const s = String(str || "");
    const m = s.match(/^(.+?)\s*\((.+)\)$/);
    if (m) return { name: m[1], shift: m[2] };
    return { name: s, shift: "" };
  }

  function buildStoreBlock(list, storeLabel) {
    if (!list.length) return "";
    const groups = {};
    const order = ["æ«ƒæª¯","å½©å¦","æ”å½±","ä¿®åœ–"];

    list.forEach((item)=>{
      const m = item.shift.match(/(æ«ƒæª¯|å½©å¦|æ”å½±|ä¿®åœ–)/);
      const role = m ? m[1] : "å…¶ä»–";
      if (!groups[role]) groups[role] = [];
      groups[role].push(item.name);
    });

    let lines = [];
    order.forEach(role=>{
      if (groups[role]) {
        lines.push(`${storeLabel}${role}ï¼š${groups[role].join("ã€")}`);
      }
    });
    if (groups["å…¶ä»–"]) {
      lines.push(`${storeLabel}å…¶ä»–ï¼š${groups["å…¶ä»–"].join("ã€")}`);
    }
    return lines.join("<br>");
  }

  // ===== ç­è¡¨è©³ç´° =====
  async function loadAllShifts(ds) {
    const box = document.getElementById("selected-shift");
    box.classList.remove("show");
    box.innerHTML = `<div class="shift-loading"></div>`;

    try {
      const res = await fetch(`${API_URL}?date=${ds}&mode=all`);
      const d = await res.json();

      if (!d.ok || !d.shifts) {
        box.innerHTML = "å°šç„¡ç­è¡¨è³‡æ–™";
        box.classList.add("show");
        return;
      }

      const raw = d.shifts;
      const zsList = (raw.zhongshan || []).map(parseShiftString);
      const jmList = (raw.jingmei   || []).map(parseShiftString);
      const offList = raw.off || [];

      let html = `<div class="shift-date-title">${ds}</div><br>`;

      if (zsList.length) {
        html += "<b>[ä¸­å±±]</b><br>" + buildStoreBlock(zsList,"ä¸­å±±") + "<br><br>";
      }
      if (jmList.length) {
        html += "<b>[æ™¯ç¾]</b><br>" + buildStoreBlock(jmList,"æ™¯ç¾") + "<br><br>";
      }
      if (offList.length) {
        html += "<b>[æ”¾å‡]</b><br>ãƒ»" + offList.join("<br>ãƒ»");
      }

      if (!zsList.length && !jmList.length && !offList.length) {
        html += "æœ¬æ—¥ç„¡äººæ’ç­";
      }

      box.innerHTML = html;
      requestAnimationFrame(()=>box.classList.add("show"));
    } catch (e) {
      console.error(e);
      box.innerHTML = "è®€å–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
      box.classList.add("show");
    }
  }

  // ===== æ‰“å¡ =====
  function submitClockIn() {
    const btn = document.getElementById("clockInBtn");
    const statusEl = document.getElementById("status");
  
    if (!currentUser) {
      alert("è«‹å…ˆç™»å…¥");
      return;
    }
    if (btn.disabled) return;
  
    const type = btn.dataset.type || "ä¸Šç­";
    if (type === "done") return;
  
    if (!confirm(`ç¢ºå®šè¦æ‰“ã€Œ${type}ã€å¡å—ï¼Ÿ`)) return;
  
    btn.disabled = true;
    btn.textContent = "å®šä½ä¸­...";
  
    navigator.geolocation.getCurrentPosition(
      async (pos) => {
        btn.textContent = "æ‰“å¡ä¸­...";
  
        try {
          const res = await fetch(API_URL, {
            method: "POST",
            // âš ï¸ ç”¨ã€Œç°¡å–®è«‹æ±‚ã€é¿å… CORS preflight
            headers: {
              "Content-Type": "text/plain;charset=utf-8",
            },
            body: JSON.stringify({
              action: "clockIn",
              email: currentUser.email,
              type,
              lat: pos.coords.latitude,
              lng: pos.coords.longitude,
            }),
          });
  
          if (!res.ok) {
            throw new Error("HTTP " + res.status);
          }
  
          // é€™è£¡å°±èƒ½åƒåˆ° handleClockIn_ å›å‚³çš„ { ok, status, tokens }
          const data = await res.json();
  
          if (!data.ok) {
            alert(data.msg || "æ‰“å¡å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
            btn.disabled = false;
            btn.textContent = type;
            return;
          }
  
          // âœ… é¡¯ç¤ºæ‰“å¡æˆåŠŸè¨Šæ¯
          alert("æ‰“å¡æˆåŠŸ");
  
          // âœ… æ›´æ–°ç•«é¢ä¸Šçš„ã€Œä»Šæ—¥å·²ä¸Šç­ / ä»Šæ—¥å·²ä¸‹ç­ã€
          if (statusEl && data.status) {
            statusEl.textContent = data.status;
            statusEl.style.color = data.status.includes("æœª")
              ? "#8B0000"
              : "green";
          }
  
          // âœ… å¦‚æœå¾Œç«¯æœ‰å›å‚³æœ€æ–°ä»£å¹£é¤˜é¡ï¼Œé †ä¾¿åˆ·æ–°å³ä¸‹è§’æ‰­è›‹æ•¸
          if (typeof data.tokens === "number") {
            const hudCoin = document.getElementById("hud-coin");
            const modalCoin = document.getElementById("modal-coin-count");
            if (hudCoin) hudCoin.textContent = data.tokens;
            if (modalCoin) modalCoin.textContent = data.tokens;
  
            // è·Ÿ initApp ä¸€æ¨£æ›´æ–° localStorageï¼Œä¹‹å¾Œç™»å…¥å¯ä»¥ç®—å·®é¡æç¤º
            localStorage.setItem("q_token_balance", data.tokens);
          }
  
          // âœ… æŒ‰éˆ•ç‹€æ…‹åˆ‡æ›ï¼ˆä¸Šç­ â†’ ä¸‹ç­ â†’ doneï¼‰
          if (type === "ä¸Šç­") {
            btn.textContent = "ä¸‹ç­";
            btn.dataset.type = "ä¸‹ç­";
            btn.disabled = false;
            btn.style.background = "#111";
          } else if (type === "ä¸‹ç­") {
            btn.textContent = "å·²ä¸‹ç­";
            btn.dataset.type = "done";
            btn.disabled = true;
            btn.style.background = "#333";
          }
        } catch (e) {
          console.error(e);
          alert("æ‰“å¡å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
          btn.disabled = false;
          btn.textContent = type;
        }
      },
      () => {
        alert("å®šä½å¤±æ•—ï¼Œè«‹ç¢ºèªå®šä½æ¬Šé™");
        btn.disabled = false;
        btn.textContent = type;
      }
    );
  }

  // ===== Manager å€ =====
  function showMgrTab(t) {
    document.getElementById("mgr-tab-pending").classList.toggle("active", t === "pending");
    document.getElementById("mgr-tab-today").classList.toggle("active", t === "today");
    document.getElementById("mgr-view-pending").classList.toggle("hidden", t !== "pending");
    document.getElementById("mgr-view-today").classList.toggle("hidden", t !== "today");
  }

  async function loadManagerData() {
    const rList = document.getElementById("mgr-review-list");
    const dList = document.getElementById("mgr-dashboard-list");
    rList.innerHTML = "è¼‰å…¥ä¸­...";
    dList.innerHTML = "è¼‰å…¥ä¸­...";

    try {
      const rRes = await fetch(`${API_URL}?action=getAllPendingLeaves`);
      const rData = await rRes.json();
      const items = (rData && rData.items) || [];

      // âœ… æŠŠçµæœå­˜èµ·ä¾†ï¼Œå¾Œé¢å¯©æ ¸ç”¨
      pendingLeaveItems = items;

      const mgrBtn = document.querySelector('button[data-page="manager"]');
      if (mgrBtn) mgrBtn.classList.toggle("has-notif", items.length > 0);

      if (items.length) {
        rList.innerHTML = items.map((i, idx)=>
          `<div class="dash-item">
             <span>${i.name} - ${i.leaveType} (${i.date})</span>
             <button class="btn-approve btn-review" data-idx="${idx}">å¯©æ ¸</button>
           </div>`
        ).join("");

        // ç¶å®šå¯©æ ¸æŒ‰éˆ•äº‹ä»¶
        rList.querySelectorAll(".btn-review").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const idx = Number(btn.dataset.idx);
            openReviewModal(idx);
          });
        });
      } else {
        rList.innerHTML = "ç„¡å¾…å¯©æ ¸é …ç›®";
      }
    } catch (e) {
      console.error("load pending error", e);
      rList.innerHTML = "è®€å–éŒ¯èª¤";
    }

    try {
      const dRes = await fetch(`${API_URL}?action=getManagerDashboard`);
      const dData = await dRes.json();
      const list = (dData && dData.items) || [];
      if (list.length) {
        dList.innerHTML = list.map(i=>
          `<div class="dash-item">
             <span>${i.name} <small style="color:#888">(${i.dept})</small></span>
             <span class="dash-time">${i.in}/${i.out}</span>
           </div>`
        ).join("");
      } else {
        dList.innerHTML = "ä»Šæ—¥ç„¡äººä¸Šç­";
      }
    } catch (e) {
      console.error("load dashboard error", e);
      dList.innerHTML = "è®€å–éŒ¯èª¤";
    }
  }

  async function checkManagerBadge() {
    try {
      const r = await fetch(`${API_URL}?action=getAllPendingLeaves`);
      const d = await r.json();
      const mgrBtn = document.querySelector('button[data-page="manager"]');
      if (mgrBtn && d.items && d.items.length) {
        mgrBtn.classList.add("has-notif");
      }
    } catch (e) {
      console.warn("checkManagerBadge error", e);
    }
  }

  async function review(idx, em, dt, st) {
    if (!confirm("ç¢ºå®šé€šé?")) return;
    try {
      await fetch(API_URL, {
        method: "POST",
        mode: "no-cors",
        body: JSON.stringify({
          action: "reviewLeave",
          rowIndex: idx,
          email: em,
          date: dt,
          status: st,
        }),
      });
      alert("å·²å¯©æ ¸");
      loadManagerData();
    } catch (e) {
      console.error(e);
      alert("å¯©æ ¸å¤±æ•—");
    }
  }

    function openReviewModal(idx) {
    currentReviewIndex = idx;
    const item = pendingLeaveItems[idx];
    if (!item) return;

    document.getElementById("rv-name").textContent      = item.name || "";
    document.getElementById("rv-appliedAt").textContent = item.appliedAt || "";
    document.getElementById("rv-date").textContent      = item.date || "";
    document.getElementById("rv-type").textContent      = item.leaveType || "";
    document.getElementById("rv-reason").textContent    = item.reason || "";
    document.getElementById("rv-note").value            = "";

    openModal("review");
  }

  async function handleReviewAction(statusText) {
    if (currentReviewIndex == null) return;
    const item = pendingLeaveItems[currentReviewIndex];
    if (!item) return;

    if (!confirm(`ç¢ºå®šè¦å°‡ã€Œ${item.name} ${item.date} çš„ ${item.leaveType}ã€æ¨™è¨˜ç‚ºã€Œ${statusText}ã€å—ï¼Ÿ`)) {
      return;
    }

    const note = document.getElementById("rv-note").value.trim();

    try {
      await fetch(API_URL, {
        method: "POST",
        mode: "no-cors",
        body: JSON.stringify({
          action: "reviewLeave",
          rowIndex: item.rowIndex,   // ç›´æ¥ç”¨å¾Œç«¯çµ¦çš„ rowIndex
          email: item.email,
          date: item.date,
          status: statusText,
          note: note
        }),
      });
      alert("å·²é€å‡ºå¯©æ ¸çµæœ");
      closeModal("review");
      loadManagerData();
    } catch (e) {
      console.error(e);
      alert("å¯©æ ¸å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
    }
  }
  
  // ===== Admin =====
  async function adminGiveToken() {
    const e = document.getElementById("adm-token-email").value.trim();
    const a = document.getElementById("adm-token-amt").value;
    if (!e || !a) {
      alert("è«‹å¡« Email èˆ‡æ•¸é‡");
      return;
    }
    await fetch(API_URL, {
      method: "POST",
      mode: "no-cors",
      body: JSON.stringify({
        action: "adminGiveToken",
        targetEmail: e,
        amount: a,
      }),
    });
    alert("å·²ç™¼é€");
    closeModal("admin-token");
  }

  async function adminSetAnnounce() {
    const t = document.getElementById("adm-ann-title").value;
    const c = document.getElementById("adm-ann-content").value;
    const btn = document.getElementById("adm-announce-submit");

    if (btn) {
      btn.disabled = true;
      btn.textContent = "ç™¼å¸ƒä¸­...";
    }

    try {
      await fetch(API_URL, {
        method: "POST",
        mode: "no-cors",
        body: JSON.stringify({
          action: "adminSetAnnounce",
          title: t,
          content: c,
        }),
      });
      alert("å·²ç™¼å¸ƒ");
      closeModal("admin-announce");
    } catch (e) {
      console.error(e);
      alert("ç™¼å¸ƒå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
    } finally {
      if (btn) {
        btn.disabled = false;
        btn.textContent = "ç™¼å¸ƒ";
      }
    }
  }

  async function adminSync(t) {
    if (!confirm("ç¢ºå®šåŸ·è¡Œ?")) return;

    const buttons = document.querySelectorAll("#modal-admin-sync .admin-menu-btn");
    buttons.forEach(b => b.disabled = true);

    try {
      await fetch(API_URL, {
        method: "POST",
        mode: "no-cors",
        body: JSON.stringify({ action: "adminSync", type: t }),
      });
      alert("æŒ‡ä»¤å·²ç™¼é€");
      closeModal("admin-sync");
    } catch (e) {
      console.error(e);
      alert("åŸ·è¡Œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
    } finally {
      buttons.forEach(b => b.disabled = false);
    }
  }

  // ===== Gacha =====
  function playGacha() {
    const btn = document.getElementById("gacha-action-btn");
    const res = document.getElementById("gacha-result-display");
    if (!currentUser) {
      alert("è«‹å…ˆç™»å…¥");
      return;
    }
  
    btn.disabled = true;
    btn.classList.add("shake-hard");  // ä¸€é–‹å§‹å°±é–‹å§‹æ™ƒ
    res.classList.remove("show");
    res.innerHTML = "";
  
    (async () => {
      try {
        const r = await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify({ action: "drawGacha", email: currentUser.email }),
        });
        const d = await r.json();
        if (!d.ok) {
          alert(d.msg || "ä»£å¹£ä¸è¶³");
          btn.disabled = false;
          btn.classList.remove("shake-hard"); // å‡ºéŒ¯æ™‚åœæ‰å‹•ç•«
          return;
        }
  
        document.getElementById("modal-coin-count").textContent = d.balance;
        document.getElementById("hud-coin").textContent = d.balance;
  
        res.innerHTML = d.win
          ? "<span style='color:red;font-size:1.5rem'>ğŸ‰ ä¸­çï¼</span>"
          : "å“ˆå“ˆæ²’ä¸­å•¦";
        res.classList.add("show");
      } catch (e) {
        console.error(e);
        alert("é€£ç·šéŒ¯èª¤");
      } finally {
        // âœ… ç„¡è«–æˆåŠŸ / å¤±æ•—ï¼Œçµæœé¡¯ç¤ºå¾Œæ‰åœ
        btn.disabled = false;
        btn.classList.remove("shake-hard");
      }
    })();
  }

  function resetGachaUI() {
    const res = document.getElementById("gacha-result-display");
    res.classList.remove("show");
    res.innerHTML = "";
    document.getElementById("gacha-action-btn").disabled = false;
  }

  function switchGachaTab(tab) {
    document.getElementById("tab-gacha-play").classList.toggle("active", tab === "play");
    document.getElementById("tab-gacha-log").classList.toggle("active", tab === "log");
    if (tab === "play") {
      document.getElementById("gacha-view-play").classList.remove("hidden");
      document.getElementById("gacha-view-log").classList.add("hidden");
    } else {
      document.getElementById("gacha-view-play").classList.add("hidden");
      document.getElementById("gacha-view-log").classList.remove("hidden");
      renderGachaLog();
    }
  }

  function renderGachaLog() {
    document.getElementById("gacha-history-list").innerHTML =
      "<div style='text-align:center;padding:10px;color:#999'>é–‹ç™¼ä¸­...</div>";
  }

    // éœ€è¦å¾Œç«¯æä¾›ï¼šGET ?action=listUsers
  // å›å‚³æ ¼å¼ç¤ºæ„ï¼š
  // { ok:true, items:[ {email:"a@...", name:"æŸæŸ", symbol:"ğŸ»"}, ... ] }
  async function loadAdminUserList() {
    const box = document.getElementById("adm-user-list");
    if (!box) return;
    box.textContent = "è®€å–ä¸­...";

    try {
      const r = await fetch(`${API_URL}?action=listUsers`);
      const d = await r.json();
      const items = d.items || [];
      allUsersForAdmin = items;

      if (!items.length) {
        box.textContent = "å°šç„¡äººå“¡åå–®";
        return;
      }

      box.innerHTML = items.map((u, idx)=>
        `<label style="display:flex;align-items:center;gap:6px;padding:4px 0;">
           <input type="checkbox" class="adm-user-checkbox" data-email="${u.email}" />
           <span>${u.name}${u.symbol ? `ï¼ˆ${u.symbol}ï¼‰` : ""} 
             <small style="color:#999;">${u.email}</small>
           </span>
         </label>`
      ).join("");
    } catch (e) {
      console.error(e);
      box.textContent = "è®€å–å¤±æ•—";
    }
  }

  async function adminGiveToken() {
    const checkboxes = Array.from(
      document.querySelectorAll(".adm-user-checkbox:checked")
    );
    const amount = Number(document.getElementById("adm-token-amt").value);
    const reason = document.getElementById("adm-token-reason").value.trim();

    if (!checkboxes.length) {
      alert("è«‹è‡³å°‘é¸æ“‡ä¸€ä½å“¡å·¥");
      return;
    }
    if (!amount) {
      alert("è«‹è¼¸å…¥ç™¼æ”¾æ•¸é‡");
      return;
    }

    const btn = document.getElementById("adm-token-submit");
    if (btn) {
      btn.disabled = true;
      btn.textContent = "ç™¼é€ä¸­...";
    }

    try {
      for (const cb of checkboxes) {
        const email = cb.dataset.email;
        await fetch(API_URL, {
          method: "POST",
          mode: "no-cors",
          body: JSON.stringify({
            action: "adminGiveToken",
            targetEmail: email,
            amount: amount,
            reason: reason,
          }),
        });
      }
      alert("å·²ç™¼é€");
      closeModal("admin-token");
    } catch (e) {
      console.error(e);
      alert("ç™¼é€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
    } finally {
      if (btn) {
        btn.disabled = false;
        btn.textContent = "ç™¼é€";
      }
    }
  }
  
  // ===== Leave =====
  function prepareLeaveDates() {
    const s = document.getElementById("leave-date");
    s.innerHTML = "";
    for (let i = 0; i < 30; i++) {
      const d = new Date();
      d.setDate(d.getDate() + i);
      const v = d.toISOString().split("T")[0];
      const o = document.createElement("option");
      o.value = v;
      o.textContent = v;
      s.add(o);
    }
  }

  async function submitLeave() {
    if (!currentUser) {
      alert("è«‹å…ˆç™»å…¥");
      return;
    }

    const btn = document.querySelector("#modal-leave .admin-action-btn");
    if (btn) {
      btn.disabled = true;
      btn.textContent = "é€å‡ºä¸­...";
    }

    try {
      await fetch(API_URL, {
        method: "POST",
        mode: "no-cors",
        body: JSON.stringify({
          action: "applyLeave",
          email: currentUser.email,
          date: document.getElementById("leave-date").value,
          leaveType: document.getElementById("leave-type").value,
          reason: document.getElementById("leave-reason").value,
        }),
      });
      alert("å·²é€å‡º");
      closeModal("leave");
      loadLeaveHistory(currentUser.email);
    } catch (e) {
      console.error(e);
      alert("é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
    } finally {
      if (btn) {
        btn.disabled = false;
        btn.textContent = "é€å‡ºç”³è«‹";
      }
    }
  }

  async function loadLeaveHistory(e) {
    try {
      const r = await fetch(
        `${API_URL}?action=leaveHistory&email=${encodeURIComponent(e)}`
      );
      const d = await r.json();
      const list = d.items || [];
      const box = document.getElementById("leave-history");
      if (!list.length) {
        box.innerHTML = "<p>ç›®å‰æ²’æœ‰è«‹å‡ç´€éŒ„</p>";
        return;
      }
      box.innerHTML = list.map(i=>
        `<div class="leave-card">
           <div class="row-1">
             <span class="title">${i.leaveType}</span>
             <span class="status-bar status-${i.status || "å¯©æ ¸ä¸­"}">${
              i.status || "å¯©æ ¸ä¸­"
            }</span>
           </div>
           <div class="info">${i.date}</div>
         </div>`
      ).join("");
    } catch (e) {
      console.error(e);
      document.getElementById("leave-history").innerHTML = "è¼‰å…¥å¤±æ•—";
    }
  }
</script>
</body>
</html>
