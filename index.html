<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Qoopio æ‰“å¡ç³»çµ±</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, userâ€‘scalable=no" />
    <meta name="theme-color" content="#111111" />
    <link rel="manifest" href="manifest.json" />
    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("service-worker.js")
          .then(() => console.log("âœ… Service Worker registered"))
          .catch((error) => console.error("âŒ SW registration failed:", error));
      }
    </script>
    <style>
      body {
        font-family: "Helvetica Neue", Helvetica, Arial, sansâ€‘serif;
        margin: 0;
        padding: 2rem;
        background-color: #f9f9f9;
        color: #333;
        text-align: center;
      }
      .container {
        max-width: 960px;
        margin: 20vh auto;
      }
      label {
        display: block;
        margin: 1rem 0 0.5rem;
        font-size: 1.5rem;
        text-align: left;
      }
      input[type="email"] {
        font-size: 2.5rem;
        width: 98%;
        padding: 1.6rem;
        border: 1px solid #ccc;
        border-radius: 12px;
        box-sizing: borderâ€‘box;
      }
      .button-row {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
      }
      .submit-btn {
        flex: 5;
        padding: 2.5rem;
        font-size: 2rem;
        background-color: #111;
        color: #fff;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }
      .submit-btn:hover {
        background-color: #444;
      }
      .change-btn {
        flex: 1;
        padding: 2.5rem;
        font-size: 1.6rem;
        background-color: #e0e0e0;
        color: #222;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .change-btn:hover {
        background-color: #ccc;
      }
      .user-label {
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: 1rem;
      }
      #status {
        margin-top: 1.2rem;
        font-size: 1.5rem;
        font-weight: bold;
      }
      #shift-info {
        margin-top: 2rem;
        font-size: 1.3rem;
        color: #444;
      }
    </style>
  </head>
  <body>
    <div class="container">

      <!-- ä½¿ç”¨è€…è³‡è¨Šå€ -->
      <div id="user-info" style="display: none;">
        <div id="user-label" class="user-label"></div>
      </div>

      <!-- Email è¼¸å…¥å€ -->
      <div id="email-input-area">
        <label for="email">Emailï¼š</label>
        <input type="email" id="email" placeholder="è¼¸å…¥å…¬å¸ email" required />
        <button onclick="handleLogin()">ç™»å…¥</button>
      </div>

      <!-- æ‰“å¡èˆ‡æ›´æ›å¸³è™ŸæŒ‰éˆ• -->
      <div class="button-row">
        <button id="clockInBtn" class="submit-btn" onclick="submitClockIn()">æ‰“å¡</button>
        <button onclick="resetEmail()" class="change-btn">æ›´æ›å¸³è™Ÿ</button>
      </div>

      <!-- ç­åˆ¥è³‡è¨Šé¡¯ç¤ºå€ -->
      <div id="shift-info">è®€å–ç­åˆ¥ä¸­â€¦</div>

      <!-- æ‰“å¡ç‹€æ…‹é¡¯ç¤º -->
      <div id="status"></div>

    </div>

    <script>
      const scriptUrl = "https://script.google.com/macros/s/AKfycbzfCWSZCydOFXJMaOqHOA25HHW36RlONmDâ€‘Dâ€‘TgruSsx6xrO4RegK7CGlkwNwpG6QKlj/exec";
      let userData = {};

      // è¼‰å…¥ user.json
      fetch("user.json")
        .then(res => res.json())
        .then(json => {
          userData = json;
          initLogin();
        })
        .catch(err => {
          console.error("âŒ ç„¡æ³•è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™", err);
          alert("ä½¿ç”¨è€…è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹åˆ·æ–°é é¢");
        });

      // åˆå§‹åŒ–ç™»å…¥ç‹€æ…‹
      function initLogin() {
        const savedEmail = localStorage.getItem("qoopio_email");
        if (savedEmail && userData[savedEmail]) {
          showUserInfo(savedEmail);
        } else {
          showEmailInput();
        }
        updateButtonLabel();
        setInterval(updateButtonLabel, 60000);
      }

      // è™•ç†ç™»å…¥æŒ‰éˆ•
      function handleLogin() {
        const email = document.getElementById("email").value.trim();
        if (!userData[email]) {
          alert("æŸ¥ç„¡æ­¤å¸³è™Ÿï¼Œè«‹é‡æ–°ç¢ºèª emailï¼");
          return;
        }
        localStorage.setItem("qoopio_email", email);
        showUserInfo(email);
      }

      // é¡¯ç¤ºä½¿ç”¨è€…è³‡è¨Š
      function showUserInfo(email) {
        const name = userData[email].name || email;
        document.getElementById("user-label").textContent = `${name}ï¼ˆ${email}ï¼‰`;
        document.getElementById("user-info").style.display = "block";
        document.getElementById("email-input-area").style.display = "none";
        loadShifts(email);
      }

      // é¡¯ç¤º email è¼¸å…¥å€
      function showEmailInput() {
        document.getElementById("user-info").style.display = "none";
        document.getElementById("email-input-area").style.display = "block";
      }

      // é‡è¨­å¸³è™Ÿ
      function resetEmail() {
        localStorage.removeItem("qoopio_email");
        location.reload();
      }

      // æ›´æ–°æ‰“å¡æŒ‰éˆ•æ–‡å­—ï¼ˆä¸Šç­ï¼ä¸‹ç­ï¼‰
      let lastSubmitTime = 0;
      function updateButtonLabel() {
        const now = new Date();
        const totalMinutes = now.getHours() * 60 + now.getMinutes();
        const btn = document.getElementById("clockInBtn");
        if (totalMinutes >= 240 && totalMinutes <= 1140) {
          btn.textContent = "ä¸Šç­æ‰“å¡";
          btn.dataset.type = "ä¸Šç­";
        } else {
          btn.textContent = "ä¸‹ç­æ‰“å¡";
          btn.dataset.type = "ä¸‹ç­";
        }
      }

      // å–å¾—ä»Šæ—¥èˆ‡æ˜æ—¥ç­åˆ¥
      function loadShifts(email) {
        document.getElementById("shift-info").textContent = "è®€å–ç­åˆ¥ä¸­â€¦";
        fetch(`${scriptUrl}?email=${encodeURIComponent(email)}`)
          .then(res => res.json())
          .then(data => {
            document.getElementById("shift-info").innerHTML =
              `ğŸ“… ä»Šæ—¥ç­åˆ¥ï¼š${data.today || "â€”"}<br>â­ï¸ æ˜æ—¥ç­åˆ¥ï¼š${data.tomorrow || "â€”"}`;
          })
          .catch(err => {
            console.error("âŒ ç„¡æ³•è¼‰å…¥ç­åˆ¥ï¼š", err);
            document.getElementById("shift-info").textContent = "ç„¡æ³•è®€å–ç­è¡¨";
          });
      }

      // æ‰“å¡é€å‡ºé‚è¼¯ï¼ˆå®šä½ + å‚³é€ +ç‹€æ…‹é¡¯ç¤ºï¼‰
      function submitClockIn() {
        const now = Date.now();
        if (now - lastSubmitTime < 15000) {
          alert("è«‹å‹¿é‡è¤‡æ‰“å¡ï¼Œè«‹ç­‰å¾…å¹¾ç§’å†è©¦ï¼");
          return;
        }
        const email = localStorage.getItem("qoopio_email");
        if (!email) {
          alert("è«‹å…ˆç™»å…¥ï¼");
          return;
        }
        const type = document.getElementById("clockInBtn").dataset.type || "ä¸Šç­";
        if (!navigator.geolocation) {
          alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½");
          return;
        }
        navigator.geolocation.getCurrentPosition(position => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;

          const data = { email, type, lat, lng };
          const name = userData[email].name || email;
          const timeStr = new Date().toLocaleTimeString();

          document.getElementById("status").textContent =
            `âœ… ${name} ${type}ï¼ˆ${timeStr}ï¼‰`;
          document.getElementById("status").style.color = "green";

          document.getElementById("clockInBtn").disabled = true;
          setTimeout(() => {
            document.getElementById("clockInBtn").disabled = false;
          }, 15000);

          lastSubmitTime = now;
          // å‚³é€è³‡æ–™çµ¦ Apps Script
          fetch(scriptUrl, {
            method: "POST",
            mode: "no-cors",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
          });
        }, () => {
          alert("ç„¡æ³•å–å¾—å®šä½è³‡è¨Šï¼Œè«‹ç¢ºèªç€è¦½å™¨æ¬Šé™ï¼");
        });
      }
    </script>
  </body>
</html>